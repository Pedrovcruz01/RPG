<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem - Draemora RPG</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    
    <!-- Font Awesome (√çcones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Biblioteca html2pdf para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Estilos customizados e fontes */
        :root {
            --bg-color: #0a0a0a;
            --text-color: #E0E1DD;
            --card-bg-color: rgba(27, 38, 59, 0.8);
            --card-border-color: #415A77;
            --input-bg-color: #1B263B;
            --input-border-color: #415A77;
            --primary-btn-bg: #0077B6;
            --primary-btn-hover-bg: #0096C7;
            --secondary-btn-bg: #FFB703;
            --secondary-btn-hover-bg: #FFC300;
            --secondary-btn-text: #1B263B;
            --danger-btn-bg: #b71c1c;
            --danger-btn-hover-bg: #d32f2f;
            --yellow-accent: #FFC300;
            --yellow-text-main: #FFC300; /* Used for font-runic text, original yellow */
            
            /* RGB values for rgba backgrounds, if needed for transparency */
            --red-strong-rgb: 183, 28, 28; /* #b71c1c */
            --blue-strong-rgb: 25, 118, 210; /* #1976D2 */
            --green-strong-rgb: 56, 142, 60; /* #388E3C */
            --purple-strong-rgb: 142, 36, 170; /* #8E24AA */
            --gray-strong-rgb: 27, 38, 59; /* For dark theme gray backgrounds */

            --red-text-color: #FF7777; /* Default light red for text */
            --blue-text-color: #77B6FF; /* Default light blue for text */
            --green-text-color: #77FF77; /* Default light green for text */
            --purple-text-color: #DDAAFF; /* Default light purple for text */

            --skill-checkbox-bg: #4b5563; /* Tailwind gray-700 */
            --skill-checkbox-border: #4b5563; /* Tailwind gray-600 */
            --skill-checkbox-checked: #9333ea; /* Tailwind purple-600 */
        }

        body.light-theme {
            --bg-color: #FFFFFF; /* White */
            --text-color: #1B263B; /* Dark blue/almost black */
            --card-bg-color: rgba(189, 212, 231, 0.8); /* Light blue from instructions */
            --card-border-color: #778DA9; /* Medium blue */
            --input-bg-color: #E0E1DD; /* Lighter grey-blue */
            --input-border-color: #778DA9;
            --primary-btn-bg: #0077B6; /* Keep primary blue */
            --primary-btn-hover-bg: #0096C7;
            --secondary-btn-bg: #FFD700; /* Yellow */
            --secondary-btn-hover-bg: #FFC300;
            --secondary-btn-text: #1B263B;
            --danger-btn-bg: #d32f2f;
            --danger-btn-hover-bg: #e57373;
            --yellow-accent: #FFC300; /* Accent yellow */
            --yellow-text-main: #DAA520; /* Darker yellow for contrast */
            
            /* Light theme specific RGBs for rgba backgrounds */
            --red-strong-rgb: 183, 28, 28; /* Same as dark for strong colors */
            --blue-strong-rgb: 25, 118, 210;
            --green-strong-rgb: 56, 142, 60;
            --purple-strong-rgb: 142, 36, 170;
            --gray-strong-rgb: 189, 212, 231; /* Use light blue for light theme gray */

            --red-text-color: #B71C1C; /* Darker red */
            --blue-text-color: #1976D2; /* Darker blue */
            --green-text-color: #388E3C; /* Darker green */
            --purple-text-color: #8E24AA; /* Darker purple */

            --skill-checkbox-bg: #E0E1DD;
            --skill-checkbox-border: #A0A0A0;
            --skill-checkbox-checked: #0077B6; /* Primary blue for checked */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0a0a0a; /* Azul escuro */
            color: #E0E1DD; /* Quase branco */
        }
        .font-runic {
            font-family: 'Uncial Antiqua', cursive;
        }
        .card {
            background-color: rgba(27, 38, 59, 0.8); /* Azul um pouco mais claro */
            border: 1px solid #415A77; /* Azul m√©dio */
            border-radius: 0.75rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .input-base, .select-base, .textarea-base {
            background-color: #1B263B; /* Azul mais escuro para inputs */
            border: 1px solid #415A77;
            color: #E0E1DD;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .input-base:focus, .select-base:focus, .textarea-base:focus {
            outline: none;
            border-color: #FFC300; /* Amarelo para foco */
            box-shadow: 0 0 0 3px rgba(255, 195, 0, 0.3);
        }
        .btn-primary {
            background-color: var(--primary-btn-bg);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-btn-hover-bg);
        }
        .btn-secondary {
            background-color: var(--secondary-btn-bg);
            color: var(--secondary-btn-text);
        }
        .btn-secondary:hover {
            background-color: var(--secondary-btn-hover-bg);
        }
        .btn-danger {
            background-color: var(--danger-btn-bg);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--danger-btn-hover-bg);
        }

        /* Adjusting specific rgba backgrounds to use variables */
        .bg-red-900\/50 {
            background-color: rgba(var(--red-strong-rgb), 0.5);
        }
        .bg-blue-900\/50 {
            background-color: rgba(var(--blue-strong-rgb), 0.5);
        }
        .bg-green-900\/50 {
            background-color: rgba(var(--green-strong-rgb), 0.5);
        }
        .bg-purple-900\/50 {
            background-color: rgba(var(--purple-strong-rgb), 0.5);
        }
        .bg-gray-900\/50 { /* This refers to the dracma-details box and similar */
            background-color: rgba(var(--gray-strong-rgb), 0.5);
        }
        .bg-black\/30 { /* This refers to the deaths counter */
            background-color: rgba(0,0,0,0.3); /* Keep black opacity */
        }

        .text-red-300 { color: var(--red-text-color); }
        .text-blue-300 { color: var(--blue-text-color); }
        .text-green-300 { color: var(--green-text-color); }
        .text-purple-300 { color: var(--purple-text-color); }
        .text-yellow-400 { color: var(--yellow-text-main); } 

        .choice-box {
            background-color: var(--card-bg-color); /* Use card background for choices */
            border-color: var(--card-border-color); /* Use card border for choices */
        }
        .choice-box input:checked + label {
            color: var(--primary-btn-bg); /* Highlight checked choices */
        }

        /* Skill checkboxes */
        .form-checkbox {
            background-color: var(--skill-checkbox-bg);
            border-color: var(--skill-checkbox-border);
        }
        .form-checkbox:checked {
            color: var(--skill-checkbox-checked);
            border-color: var(--skill-checkbox-checked);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--yellow-accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dice Animation Styles */
        .dice-overlay-result {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column; /* Allows stacking dice container and result box */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            gap: 30px; /* Space between dice animation and result box */
        }

        .dice-overlay-result.show {
            opacity: 1;
            visibility: visible;
        }

        .dice-animation-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px; /* Space between individual dice */
            height: 150px; /* Allocate space for dice to fall */
            margin-bottom: 20px; /* Space above result box */
        }

        .animated-die {
            position: relative;
            width: 80px;
            height: 80px;
            background-color: #f0f0f0;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Uncial Antiqua', cursive;
            font-size: 3rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            /* Initial state for falling - off screen */
            transform: translateY(-200px) rotateX(0deg) rotateY(0deg);
            opacity: 0;
        }

        .animated-die.start-roll {
            animation: die-fall 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; /* Accelerate then bounce */
            animation-timing-function: cubic-bezier(0.2, 0.8, 0.2, 1.2); /* More natural fall */
            animation-fill-mode: forwards;
            opacity: 1;
        }

        /* Keyframes for the falling and rotating dice */
        @keyframes die-fall {
            0% { transform: translateY(-300px) rotateX(0deg) rotateY(0deg) rotateZ(0deg); opacity: 0; }
            30% { opacity: 1; } /* Fade in during fall */
            80% { transform: translateY(0px) rotateX(720deg) rotateY(720deg) rotateZ(720deg); }
            100% { transform: translateY(0px) rotateX(720deg) rotateY(720deg) rotateZ(720deg); opacity: 1; } /* End at a settled state */
        }

        .animated-die.show-final-value {
            animation: none; /* Stop any previous animations */
            transform: none; /* Reset transforms for static display */
            opacity: 1;
            background-color: var(--secondary-btn-bg); /* Highlight result */
            color: var(--secondary-btn-text);
            box-shadow: 0 0 20px var(--yellow-accent);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease; /* Smooth transition to final state */
        }

        /* Result Box for messages */
        .result-box {
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transform: translateY(50px); /* Start below and slide up */
            opacity: 0;
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* Style for custom message box animation */
        #custom-message-box {
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 md:p-8 relative" data-life-rolled="false">

    <div id="character-sheet" class="max-w-7xl mx-auto space-y-6">

        <!-- CABE√áALHO -->
        <header class="card p-4 flex flex-col md:flex-row items-start gap-6">
            <div class="relative group flex-shrink-0">
                <input type="file" id="avatar-upload" class="hidden" accept="image/*">
<img id="avatar-preview" src="https://placehold.co/128x192/0D1B2A/E0E1DD?text=Avatar" alt="Avatar do Personagem" class="w-32 h-48 object-cover border-4 border-yellow-500 cursor-pointer group-hover:border-yellow-300 transition-all duration-300 rounded-lg">
                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer" onclick="document.getElementById('avatar-upload').click();">
                    <i class="fas fa-camera text-2xl"></i>
                </div>
            </div>
            <div class="flex-1 w-full">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3">
                        <label for="char-name" class="font-runic text-lg text-yellow-400">Nome do Personagem</label>
                        <input type="text" id="char-name" class="input-base w-full p-2 text-2xl" placeholder="Nome do Personagem">
                    </div>
                    <div>
                        <label for="char-class" class="font-runic text-yellow-400">Classe</label>
                        <select id="char-class" class="select-base w-full p-2">
                            <!-- Op√ß√µes de Classe inseridas via JS -->
                        </select>
                    </div>
                    <div>
                        <label for="char-race" class="font-runic text-yellow-400">Ra√ßa</label>
                        <select id="char-race" class="select-base w-full p-2">
                            <!-- Op√ß√µes de Ra√ßa inseridas via JS -->
                        </select>
                    </div>
                    <div>
                        <label for="char-devotion" class="font-runic text-yellow-400">Devo√ß√£o</label>
                        <input type="text" id="char-devotion" class="input-base w-full p-2" placeholder="Devo√ß√£o">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div id="class-description-container" class="hidden">
                        <!-- Descri√ß√£o da classe ser√° inserida aqui -->
                    </div>
                    <div id="race-description-container" class="hidden">
                        <!-- Descri√ß√£o da ra√ßa ser√° inserida aqui -->
                    </div>
                </div>
            </div>
        </header>

        <!-- CORPO PRINCIPAL -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUNA ESQUERDA -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- ATRIBUTOS E STATUS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ATRIBUTOS -->
                    <div class="card p-4">
                        <h2 class="font-runic text-2xl text-center text-yellow-400 mb-4">Atributos</h2>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="flex flex-col items-center">
                                <label for="attr-cor" class="font-runic text-lg">COR</label>
                                <input type="number" id="attr-cor" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-for" class="font-runic text-lg">FOR</label>
                                <input type="number" id="attr-for" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-des" class="font-runic text-lg">DES</label>
                                <input type="number" id="attr-des" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-men" class="font-runic text-lg">MEN</label>
                                <input type="number" id="attr-men" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-alm" class="font-runic text-lg">ALM</label>
                                <input type="number" id="attr-alm" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-car" class="font-runic text-lg">CAR</label>
                                <input type="number" id="attr-car" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <!-- STATUS BASE -->
                    <div class="card p-4">
                        <h2 class="font-runic text-2xl text-center text-yellow-400 mb-4">Status</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-900/50 p-3 rounded-lg text-center">
                                <label for="status-max-vida" class="font-runic text-lg text-red-300">Vida M√°xima</label>
                                <input type="number" id="status-max-vida" class="input-base w-full p-2 text-2xl text-center" value="0" readonly>
                            </div>
                            <div class="bg-red-900/50 p-3 rounded-lg text-center">
                                <label for="status-current-vida" class="font-runic text-lg text-red-300">Vida Atual</label>
                                <input type="number" id="status-current-vida" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="bg-blue-900/50 p-3 rounded-lg text-center">
                                <label for="status-def" class="font-runic text-lg text-blue-300">DEF</label>
                                <input type="number" id="status-def" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="bg-green-900/50 p-3 rounded-lg text-center">
                                <label for="status-rf" class="font-runic text-lg text-green-300">R.F</label>
                                <input type="number" id="status-rf" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="bg-purple-900/50 p-3 rounded-lg text-center">
                                <label for="status-rm" class="font-runic text-lg text-purple-300">R.M</label>
                                <input type="number" id="status-rm" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOT√ÉO DE ROLAGEM DE VIDA -->
                <div id="life-roll-container" class="hidden card p-4 text-center">
                    <button id="roll-life-btn" class="btn-secondary font-bold text-lg py-3 px-6 rounded-lg w-full">üé≤ Rolar Vida</button>
                    <div id="life-roll-result" class="mt-4 text-white"></div>
                </div>

                <!-- CONTAINER GEN√âRICO PARA ESCOLHAS DE RA√áA -->
                <div id="race-choices-container" class="hidden card p-4 space-y-4">
                    <!-- Conte√∫do din√¢mico ser√° injetado aqui -->
                </div>

                <!-- PER√çCIAS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Per√≠cias</h2>
                    <div id="skills-list" class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                        <!-- Per√≠cias ser√£o inseridas aqui via JS -->
                    </div>
                </div>

                <!-- √ÅPICES -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">√Åpices</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300 mb-2">√Åpice de Ra√ßa</h3>
                            <div id="race-apexes" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300 mb-2">√Åpice de Classe</h3>
                            <div id="class-apexes" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- CARACTER√çSTICAS E HIST√ìRICO -->
                    <div class="card p-4">
                     <h2 class="font-runic text-2xl text-yellow-400 mb-4">Caracter√≠sticas e Hist√≥rico</h2>
                     <div class="space-y-4">
                         <textarea id="char-personal-background" class="textarea-base w-full p-2 h-32" placeholder="Hist√≥rico Pessoal..."></textarea>
                         <button id="generate-background-btn" class="btn-primary w-full p-2 rounded-lg mt-2 flex items-center justify-center gap-2">
                             <span id="generate-background-text">Gerar Hist√≥rico ‚ú®</span>
                             <div id="generate-background-spinner" class="spinner hidden"></div>
                         </button>
                         <textarea id="char-race-features" class="textarea-base w-full p-2 h-24" placeholder="Caracter√≠sticas de Ra√ßa..."></textarea>
                         <textarea id="char-class-features" class="textarea-base w-full p-2 h-24" placeholder="Caracter√≠sticas de Classe..."></textarea>
                         <textarea id="char-talents" class="textarea-base w-full p-2 h-24" placeholder="Talentos e M√°culas de Ra√ßa..."></textarea>
                         <textarea id="char-apex-text" class="textarea-base w-full p-2 h-24" placeholder="Texto do √Åpice de Classe..."></textarea>
                     </div>
                 </div>

                    <!-- EST√ÅGIOS AVAN√áADOS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Est√°gios Avan√ßados</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300">Est√°gio 2 ‚Äì Subclasse</h3>
                            <input type="text" id="stage2-name" class="input-base w-full p-2 mb-1" placeholder="Nome da Subclasse">
                            <textarea id="stage2-benefit" class="textarea-base w-full p-2 h-20" placeholder="Benef√≠cio..."></textarea>
                        </div>
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300">Est√°gio 3 ‚Äì Heran√ßa</h3>
                            <input type="text" id="stage3-name" class="input-base w-full p-2 mb-1" placeholder="Nome da Heran√ßa">
                            <textarea id="stage3-ability" class="textarea-base w-full p-2 h-20" placeholder="Habilidade Lend√°ria..."></textarea>
                        </div>
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300">Est√°gio 4 ‚Äì Ascens√£o</h3>
                            <input type="text" id="stage4-name" class="input-base w-full p-2 mb-1" placeholder="Nome da Habilidade">
                            <textarea id="stage4-effect" class="textarea-base w-full p-2 h-20" placeholder="Efeito..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DIREITA -->
            <div class="space-y-6">
                
                <!-- DRACMAS E UTILIDADES -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Recursos</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Dracmas -->
                        <div class="flex items-center gap-2">
                            <label for="dracma-b" class="font-bold text-lg" style="color: #cd7f32;">D$B</label>
                            <input type="number" id="dracma-b" class="input-base w-full p-1 text-center" value="1">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="dracma-p" class="font-bold text-lg" style="color: #c0c0c0;">D$P</label>
                            <input type="number" id="dracma-p" class="input-base w-full p-1 text-center" value="1">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="dracma-o" class="font-bold text-lg" style="color: #ffd700;">D$O</label>
                            <input type="number" id="dracma-o" class="input-base w-full p-1 text-center" value="1">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="dracma-d" class="font-bold text-lg" style="color: #e02c2c;">D$D</label>
                            <input type="number" id="dracma-d" class="input-base w-full p-1 text-center" value="1">
                        </div> 
                    </div>
                    <div id="dracma-details" class="text-xs space-y-1 bg-gray-900/50 p-2 rounded-lg"></div>
                    <div class="col-span-2 space-y-2 mt-4">
                        <select id="armor-type" class="select-base w-full p-2">
                            <option value="nenhuma">Sem Armadura</option>
                            <option value="leve">Leve</option>
                            <option value="media">M√©dia</option>
                            <option value="pesada">Pesada</option>
                        </select>
                        <div id="armor-status-display" class="text-sm mt-1 text-center"></div>
                    </div>
                    <div class="col-span-2 space-y-2 mt-2">
                        <select id="shield-type" class="select-base w-full p-2">
                            <option value="nenhum">Sem Escudo</option>
                            <option value="pequeno">Pequeno</option>
                            <option value="grande">Grande</option>
                        </select>
                        <div id="shield-status-display" class="text-sm mt-1 text-center"></div>
                    </div>
                    <div class="col-span-2 flex items-center gap-2 bg-black/30 p-2 rounded-lg mt-4">
                            <label for="deaths" class="font-runic text-lg text-red-400">Mortes Eminentes</label>
                            <input type="number" id="deaths" class="input-base w-full p-1 text-center" value="0">
                    </div>
                </div>

                <!-- INVENT√ÅRIO -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Invent√°rio</h2>
                    <div id="inventory-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- Itens do invent√°rio -->
                    </div>
                    <button id="add-inventory-item" class="btn-primary w-full mt-4 p-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
                </div>

                <!-- CONTROLE DE RUNAS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Runas</h2>
                    <div id="runes-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Runas -->
                    </div>
                    <button id="add-rune-item" class="btn-primary w-full mt-4 p-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Runa</button>
                </div>

                <!-- CONTROLE DE RITUAIS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Rituais</h2>
                    <div id="rituals-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Rituais -->
                    </div>
                    <button id="add-ritual-item" class="btn-primary w-full mt-4 p-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Ritual</button>
                </div>
                
                <!-- ANOTA√á√ïES -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Anota√ß√µes e Objetivos</h2>
                    <textarea id="notes" class="textarea-base w-full p-2 h-32" placeholder="Planejamento, anota√ß√µes da sess√£o..."></textarea>
                    <textarea id="goals" class="textarea-base w-full p-2 h-32 mt-2" placeholder="Objetivos e focos do personagem..."></textarea>
                    <button id="generate-goals-btn" class="btn-primary w-full p-2 rounded-lg mt-2 flex items-center justify-center gap-2">
                        <span id="generate-goals-text">Gerar Ideias de Objetivos ‚ú®</span>
                        <div id="generate-goals-spinner" class="spinner hidden"></div>
                    </button>
                </div>

            </div>
        </main>
    </div>

    <!-- BOT√ïES DE A√á√ÉO ORGANIZADOS NO RODAP√â -->
    <footer class="max-w-7xl mx-auto p-4 mt-8 card flex flex-wrap justify-center items-center gap-4">
        <div class="tooltip">
            <button id="save-current-button" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-save"></i>
                <span>Salvar Ficha Atual</span>
            </button>
            <span class="tooltiptext">Salvar as altera√ß√µes na ficha carregada</span>
        </div>
        <div class="tooltip">
            <button id="save-as-button" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-file-export"></i>
                <span>Salvar Ficha (Como)</span>
            </button>
            <span class="tooltiptext">Salvar a ficha como um novo arquivo</span>
        </div>
        <div class="tooltip">
            <button id="manage-sheets-button" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-folder-open"></i>
                <span>Gerenciar Fichas</span>
            </button>
            <span class="tooltiptext">Ver, carregar ou excluir fichas salvas</span>
        </div>
        <div class="tooltip">
            <button id="pdf-button" class="btn-secondary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-file-pdf"></i>
                <span>Exportar PDF</span>
            </button>
            <span class="tooltiptext">Gerar um PDF da ficha atual</span>
        </div>
        <div class="tooltip">
            <button id="reset-button" class="btn-danger py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-redo-alt"></i>
                <span>Reiniciar Ficha</span>
            </button>
            <span class="tooltiptext">Limpar todos os campos da ficha</span>
        </div>
        <div class="tooltip">
            <button id="theme-toggle" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-sun" id="theme-icon"></i>
                <span>Alternar Tema</span>
            </button>
            <span class="tooltiptext">Mudar entre tema claro e escuro</span>
        </div>
    </footer>

    <!-- Modal para Gerenciar Fichas Salvas -->
    <div id="manage-sheets-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-md w-full mx-auto border border-gray-600">
            <h2 class="font-runic text-2xl text-yellow-400 mb-4">Gerenciar Fichas</h2>
            <div id="saved-sheets-list" class="max-h-60 overflow-y-auto space-y-2 mb-4">
                <!-- Fichas salvas ser√£o listadas aqui -->
            </div>
            <button id="close-manage-sheets-modal" class="btn-primary py-2 px-4 rounded-lg mt-4">Fechar</button>
        </div>
    </div>

    <!-- Container para a caixa de mensagem personalizada -->
    <div id="message-box-container"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELE√á√ÉO DE ELEMENTOS DO DOM ---
        const getEl = (id) => document.getElementById(id);
        const charNameInput = getEl('char-name');
        const classSelect = getEl('char-class');
        const classDescriptionContainer = getEl('class-description-container');
        const raceSelect = getEl('char-race');
        const raceDescriptionContainer = getEl('race-description-container');
        const charDevotionInput = getEl('char-devotion');
        const raceChoicesContainer = getEl('race-choices-container');
        const skillsList = getEl('skills-list');
        const raceApexesContainer = getEl('race-apexes');
        const classApexesContainer = getEl('class-apexes');
        const inventoryList = getEl('inventory-list');
        const runesList = getEl('runes-list');
        const ritualsList = getEl('rituals-list');
        const lifeRollContainer = getEl('life-roll-container');
        const rollLifeBtn = getEl('roll-life-btn');
        const lifeRollResult = getEl('life-roll-result');
        const charPersonalBackground = getEl('char-personal-background');
        const generateBackgroundBtn = getEl('generate-background-btn');
        const generateBackgroundText = getEl('generate-background-text');
        const generateBackgroundSpinner = getEl('generate-background-spinner');
        const notesTextArea = getEl('notes');
        const goalsTextArea = getEl('goals');
        const generateGoalsBtn = getEl('generate-goals-btn');
        const generateGoalsText = getEl('generate-goals-text');
        const generateGoalsSpinner = getEl('generate-goals-spinner');

        // Novos elementos para Vida e Tema
        const statusMaxVida = getEl('status-max-vida');
        const statusCurrentVida = getEl('status-current-vida');
        const themeToggleButton = getEl('theme-toggle');
        const themeIcon = getEl('theme-icon');
        const manageSheetsButton = getEl('manage-sheets-button');
        const manageSheetsModal = getEl('manage-sheets-modal');
        const savedSheetsList = getEl('saved-sheets-list');
        const closeManageSheetsModal = getEl('close-manage-sheets-modal');
        const saveCurrentButton = getEl('save-current-button'); // New button reference
        const saveAsButton = getEl('save-as-button'); // Renamed button reference


        // --- DEFINI√á√ïES DE DADOS ---
        const HUMAN_TALENTS = ['Adapt√°vel', 'Diplom√°tico', 'Conhecimento Universal', 'Estrat√©gico', 'Aprendizado Acelerado', 'Corajoso', 'Foco Impar√°vel'];
        const HUMAN_MACULAS = ['Desconfiado', 'Curioso em Excesso', 'Imprudente', 'Medroso', 'Dependente de Alian√ßas', 'Inseguro', 'Teimoso', 'Fr√°gil'];
        const VAMPIRE_TALENTS = ['Charme Vamp√≠rico', 'Regenera√ß√£o Sangu√≠nea', 'Transforma√ß√£o em N√©voa', 'Velocidade Sobrenatural', 'Imortalidade Sob o V√©u', 'For√ßa Devastadora', 'Obra Sobrenatural'];
        const VAMPIRE_MACULAS_OPTIONAL = ['Fraqueza √† Luz Solar', 'Vulner√°vel a Prata', 'Fome Incontrol√°vel', 'Controle Ancestral', 'Alvo de Ca√ßadores', 'Alergia ao Alho', 'Sombras do Passado'];
        const DAMPIRO_TALENTS = ['Regenera√ß√£o R√°pida', 'Olhar Hipn√≥tico', 'Vis√£o Noturna Aprimorada', 'Predador √Ågil', 'Ca√ßador de Sombras', 'Golpe Vamp√≠rico', 'Intui√ß√£o Sombria'];
        const DAMPIRO_MACULAS = ['Fascina√ß√£o por Sangue', 'Vulnerabilidade √† Luz Solar', 'Conflito Interno', 'Ecos Sombrio', 'Instinto Selvagem', 'Avidez pelo Poder', 'Avers√£o a S√≠mbolos Sagrados'];
        const LICANTROPO_TALENTS = ['Guardi√£o da Floresta', 'For√ßa Ancestral', 'Sentinela Selvagem', 'Rugido Primordial', 'Transforma√ß√£o √Ågil', 'Caminhante Silvestre'];
        const LICANTROPO_MACULAS = ['Marcas da Dor', 'Instinto Predat√≥rio', 'F√∫ria da Natureza', 'Sangue das Feras', 'Vulnerabilidade Espiritual', 'Liga√ß√£o Lunas'];
        const MEIO_DEMONIO_TALENTS = ['Chamas Profanas', 'L√¢mina Sombria', 'Regenera√ß√£o Profana', 'Aura de Medo', 'Lados opostos', 'Conjurador Infernal'];
        const MEIO_DEMONIO_MACULAS = [ 'Corrup√ß√£o Crescente', 'Sede de Poder', 'Vulnerabilidade a Magia Divina', 'Marca do Inferno', 'Sussurros Profanos', 'Instabilidade' ];
        const MEIO_CELESTIAL_TALENTS = [ 'For√ßa Transcendental', 'Vis√£o Sagrada', 'Vontade Inquebr√°vel', 'Guia Luminoso', 'Afinidade com Magia', 'L√¢mina de Luz', 'Presen√ßa Inspiradora', 'V√≠nculo Eterno (Cena)' ];
        const MEIO_CELESTIAL_MACULAS = [ 'Deslocado', 'Exaust√£o Divina', 'Liga√ß√£o com o Dom√≠nio', 'Presen√ßa Arrebatadora', 'Fragilidade Humana', 'Sombra do Divino', 'Rejei√ß√£o Celestial', 'Cicatrizes do Sangue Divino' ];
        const COLOSSO_TALENTS = [ 'Interfer√™ncia', 'Reator M√°gico', 'Refor√ßo Energ√©tico', '√öltima Conjura√ß√£o', 'Efici√™ncia' ];
        const COLOSSO_MACULAS = [ 'Sobrecarga Inst√°vel', 'Interfer√™ncia M√°gica', 'Desconex√£o do N√∫cleo', 'Foco Restrito', 'Depend√™ncia Energ√©tica Cr√≠tica' ];
        const ASTRIS_TALENTS = [ 'Desejo Cadente', 'Cora√ß√£o de Nebulosa', 'Pulsar Estelar', 'Viajante do V√°cuo', 'Voz do Abismo Estelar', 'Movimento Dimensional', 'Gravidade An√¥mala' ];
        const ASTRIS_MACULAS = [ 'Reflexo C√≥smico', 'Vazio Corporal', 'Pulsar Estelar', 'Antena Estelar', 'Vulnerabilidade ao Eclipse' ];
        const ECLIPTICO_TALENTS = [ 'Caminhante das Extremidades', 'Aura do Crep√∫sculo', 'Voz do Infinito', 'B√™n√ß√£o e Maldi√ß√£o', 'Reflexo do Caos', 'Asas do Falc√£o de Fogo' ];
        const ECLIPTICO_MACULAS = [ 'Instabilidade Existencial', 'Rejei√ß√£o C√≥smica', 'Fragilidade de Duas Naturezas', 'Conflito de Energias', 'Tenta√ß√£o Interna', 'Rejei√ß√£o Social' ];
        const ZALKHA_TALENTS = [ 'Toque Devorador', 'Forma Assimilada (Cena)', 'L√≠ngua Predat√≥ria', 'Grito Supers√¥nico', 'Sangue Venenoso', 'Gl√¢ndulas Regenerativas' ];
        const ZALKHA_MACULAS = [ 'Vulnerabilidade ao Fogo', 'Predadores Solit√°rios', 'Ecos da Mudan√ßa', 'Metabolismo Inst√°vel', 'Faro da Presa' ];
        const MORTALHAS_TALENTS = [ 'Golpe da D√≠vida Impag√°vel', 'Olhar da √öltima Noite', 'Garras de Execu√ß√£o (Abutre)', 'Correntes Invis√≠veis', 'Refor√ßar o Pacto', 'Rastro Espiritual' ];
        const MORTALHAS_MACULAS = [ 'Fobia Solar', 'N√£o √© bem vindo', 'Fragmentos da Outra Vida', 'Voz da Morte', 'Contrato Infame', 'Rachaduras do V√©u' ];
        const CRONIDAS_TALENTS = [ 'Consci√™ncia Temporal', 'Vis√£o do Futuro', 'Preserva√ß√£o de Forma', 'Acelera√ß√£o Mental', 'In√©rcia Desviada', 'Distor√ß√£o de Gravidade', 'Linha Quebrada' ];
        const CRONIDAS_MACULAS = [ 'Eco Temporal', 'Deslocamento Mental', 'Temporalmente Anacr√¥nico', 'Mem√≥ria Fragmentada', 'Raiva da Realidade', 'V√≠nculo com o Tempo', 'Rejeitado pelo Presente' ];
        const ELFO_NEGRO_TALENTS = [ 'Mentor do Pacto', 'L√≠ngua de Elfo', 'Sombras Silenciosas', 'Veneno Cultural', 'Olho do Traidor' ];
        const ELFO_NEGRO_MACULAS = [ 'Maldito Pela Luz', 'Rancor Ancestral', 'V√≠nculo Obsessivo', 'Eco da Promessa Quebrada', 'Sombra do Passado' ];
        
        const rollDiceExpression = (expression) => {
            if (!expression) return { total: 0, rolls: [], modifier: 0 };
            const parts = expression.split('+');
            const [diceCount, diceSides] = parts[0].split('d').map(Number);
            const modifier = Number(parts[1]) || 0;
            
            let rolls = [];
            let total = 0;
            for(let i = 0; i < diceCount; i++) {
                const roll = Math.floor(Math.random() * diceSides) + 1;
                rolls.push(roll);
                total += roll;
            }
            return { total: total + modifier, rolls, modifier };
        };

        const RACES = {
            "Humano": "Vers√°teis e adapt√°veis, os humanos compensam a aus√™ncia de talentos sobrenaturais com intelig√™ncia, for√ßa de vontade e iniciativa. Ganham b√¥nus em per√≠cias ou talentos √† escolha.",
            "Vampiro": "Criaturas amaldi√ßoadas pela sede de sangue. Possuem regenera√ß√£o sobrenatural, charme hipn√≥tico e resist√™ncia √† dor, mas s√£o vulner√°veis √† luz e fogo.",
            "Dampiro": "Nascidos da uni√£o entre humanos e vampiros, equilibram for√ßa sobrenatural com controle emocional. S√£o √°giles e intuitivos, mas carregam instabilidade interior.",
            "Licantropo": "Bestiais e poderosos, licantropos alternam entre forma humana e lupina. Recebem b√¥nus em combate f√≠sico e sentidos agu√ßados, mas lutam contra a f√∫ria interior.",
            "Meio-Dem√¥nio": "Marcados pelo inferno, possuem apar√™ncia distorcida e poderes elementais sombrios. Carregam o estigma do caos, mas tamb√©m uma for√ßa aterradora.",
            "Meio-Celestial": "Filhos de entidades divinas. Possuem aura sagrada, talentos de cura e prote√ß√£o, mas vivem sob constante julgamento moral e press√£o √©tica.",
            "Colosso": "Gigantes entre os mortais, os colossos possuem for√ßa descomunal, pele espessa e presen√ßa intimidadora. Em troca, s√£o lentos e visados.",
            "Astris": "Seres ligados √†s estrelas e ao firmamento. Mestres de magia c√≥smica e press√°gios, enxergam al√©m do tempo, mas se afastam do mundo terreno.",
            "Ecl√≠ptico": "Entidades que vivem entre luz e trevas. Inst√°veis e perigosas, controlam magia dual e possuem dupla natureza que pode mudar em combate.",
            "Zal‚ÄôKha": "Seres reptilianos de alma ancestral, dotados de armaduras naturais, l√≠nguas bifurcadas e sentidos t√©rmicos. Ex√≠mios ca√ßadores e guardi√µes.",
            "Mortalhas": "Criaturas feitas de n√©voa, sombra e lamentos. Imateriais por natureza, s√£o dif√≠ceis de ferir, mas n√£o conseguem tocar o mundo f√≠sico com facilidade.",
            "Cr√¥nidas": "Filhos do tempo, possuem consci√™ncia temporal expandida. S√£o capazes de manipular pequenos fragmentos do passado ou prever eventos pr√≥ximos.",
            "Elfo Negro": "Descendentes das profundezas. Magia, veneno e intriga correm em suas veias. Seus olhos veem no escuro, mas sua alma √© perseguida pelas sombras."
        };
        
        const RACE_DATA = {
            'Humano': { status: { lifeDice: '2d6+5', def: 7, rf: 4, rm: 1 }, featuresText: 'Vontade Indom√°vel: Uma vez por cena, podem repetir um teste de resist√™ncia mental ou emocional, ignorando penalidades tempor√°rias.\n\nVersatilidade: Podem escolher uma magia/ritual de qualquer dom√≠nio/patrono ou um talento adicional na cria√ß√£o do personagem.\n\nEsp√≠rito Cooperativo: Recebem +1 em testes para apoiar aliados (em Diplomacia ou em combate).\n\nDetermina√ß√£o Her√≥ica: Quando reduzidos a menos de 50% de Vida, recebem +1 em todos os testes at√© o final do combate.', talents: HUMAN_TALENTS, maculas: HUMAN_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Vampiro': { status: { lifeDice: '3d6+7', def: 8, rf: 2, rm: 2 }, featuresText: 'Nosferatu: Uma vez por cena, o vampiro pode atacar um inimigo para sugar seu sangue, recuperando 2d10 de Vida.\n\nFor√ßa Sobrenatural: Vampiros possuem for√ßa al√©m do humano, recebendo +1 adicional em testes de For√ßa.\n\nSede de Sangue (Heredit√°ria): Todos os vampiros come√ßam com essa m√°cula. Ao criar um personagem, escolha apenas uma m√°cula adicional.\n\nLa√ßo Nefasto: O Vampiro recebe 1 s√≠mbolo Ritual√≠stico ou recebe 1 Runa Elemental do Sangue.', talents: VAMPIRE_TALENTS, maculas: VAMPIRE_MACULAS_OPTIONAL, choiceLogic: { type: 'vampire' } },
            'Dampiro': { status: { lifeDice: '2d6+4', def: 8, rf: 3, rm: 3 }, featuresText: 'Sangue H√≠brido: Dampiro recupera 1d8 de Vida ao consumir pequenas quantidades de sangue, mas n√£o s√£o obrigados a se alimentar regularmente como vampiros.\n\nFor√ßa Sobrenatural: Vampiros possuem for√ßa al√©m do humano, recebendo +1 adicional em testes de For√ßa.\n\nResili√™ncia Sobrenatural: Recebem +2 em testes de resist√™ncia a venenos e doen√ßas, devido √† mistura de sangue humano e vamp√≠rico.\n\nProle de Nosferatu: O Dampiro pode escolher 2 Talento/M√°cula de Humano e 2 Talento/M√°cula de Vampiro em alternativa aos seus talentos convencionais. Ou podem escolher receber 2 S√≠mbolos Ritual√≠sticos ou 2 Runas de qualquer Elemento.', choiceLogic: { type: 'dampiro' } },
            'Licantropo': { status: { lifeDice: '4d6+2', def: 5, rf: 5, rm: 0 }, featuresText: 'F√∫ria Bestial: Uma vez por combate, ganha +2 em todos os testes de Corpo e For√ßa por 2 rodadas.\n\nTransforma√ß√£o Parcial: Pode manifestar garras ou sentidos lupinos, concedendo +1 em Combate ou Percep√ß√£o.\n\nResist√™ncia Ancestral: +2 em testes contra venenos, doen√ßas e efeitos de controle mental.\n\nHerdeiro da Lua: Ao realizar um ritual sob a luz da lua, recebe vantagem autom√°tica.', talents: LICANTROPO_TALENTS, maculas: LICANTROPO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Meio-Dem√¥nio': { status: { lifeDice: '2d4+10', def: 9, rf: 2, rm: 4 }, featuresText: 'Sangue do Abismo: Pode conjurar uma magia ou ritual da camada ‚ÄúIra‚Äù com +2 de b√¥nus uma vez por cena.\n\nAura Intimidante: Recebe +1 em testes de Intimida√ß√£o e +1 de dano contra alvos com medo.\n\nChamas Profanas: Pode conjurar um ataque flamejante causando 1d10 de dano extra (1x por combate).\n\nInstinto da Ru√≠na: Recebe vantagem ao identificar fraquezas m√°gicas e espirituais.', talents: MEIO_DEMONIO_TALENTS, maculas: MEIO_DEMONIO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Meio-Celestial': { status: { lifeDice: '3d6+6', def: 10, rf: 1, rm: 6 }, featuresText: 'Luz Interior: Pode curar 1d6 de Vida em si ou em um aliado pr√≥ximo uma vez por combate.\n\nB√™n√ß√£o Celestial: Concede +2 em testes de Alma e Diplomacia ao lidar com humanos e criaturas benignas.\n\nAsas Et√©reas: Pode planar ou evitar quedas com teste de Reflexo.\n\nEscudo de F√©: Concede +1 de R.M adicional enquanto estiver consciente.', talents: MEIO_CELESTIAL_TALENTS, maculas: MEIO_CELESTIAL_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Colosso': { status: { lifeDice: '2d4+8', def: 10, rf: 8, rm: 8 }, featuresText: 'Pele de Pedra: Reduz 2 de qualquer dano f√≠sico sofrido.\n\nFor√ßa Impar√°vel: Recebe +2 em testes de For√ßa e pode carregar o dobro do peso comum.\n\nPassos de Trov√£o: Causa 1d6 de dano ao redor ao pular ou cair de alturas.\n\nFirmeza de Rocha: Imune a empurr√µes, quedas for√ßadas e efeitos de derrubar.', talents: COLOSSO_TALENTS, maculas: COLOSSO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Astris': { status: { lifeDice: '1d6+12', def: 7, rf: 4, rm: 4 }, featuresText: 'Corpo Estelar: Imune a v√°cuo, frio e calor extremos.\n\nVoz do Cosmos: Pode se comunicar com seres extraplanares ou pressentir eventos c√≥smicos.\n\nChamas Negras: Conjura 1 vez por combate uma magia de dano c√≥smico (1d12 + Alma).\n\nMem√≥ria Eterna: Recebe +2 em Ci√™ncias, Conhecimentos e Ocultismo.', talents: ASTRIS_TALENTS, maculas: ASTRIS_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Ecl√≠ptico': { status: { lifeDice: '3d4+6', def: 7, rf: 6, rm: 6 }, featuresText: 'Fus√£o de Luz e Trevas: Recebe +1 em testes de Combate e Conjura√ß√£o quando alterna entre a√ß√µes ofensivas e defensivas.\n\nRitual da Penumbra: Pode usar rituais tanto de Luz quanto de Sombras com vantagem.\n\nOlhos da Dualidade: Enxerga no escuro absoluto e percebe ilus√µes com facilidade.\n\nEquil√≠brio Interno: Testes de Mente n√£o sofrem penalidades externas.', talents: ECLIPTICO_TALENTS, maculas: ECLIPTICO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Zal‚ÄôKha': { status: { lifeDice: '2d8+6', def: 9, rf: 2, rm: 5 }, featuresText: 'Pele de Escamas: Reduz em 1 qualquer dano f√≠sico sofrido.\n\nOlhos Penetrantes: Recebe +2 em testes de Intui√ß√£o e Sentidos Ocultos.\n\nL√≠ngua Venenosa: Uma vez por combate, seu ataque corpo a corpo causa 1d6 de dano venenoso adicional.\n\nRitual de Sangue Antigo: Recebe +1 em conjura√ß√£o de rituais com elementos naturais (Terra, Vento, Sangue).', talents: ZALKHA_TALENTS, maculas: ZALKHA_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Mortalhas': { status: { lifeDice: '2d8+10', def: 10, rf: 7, rm: 7 }, featuresText: 'Forma Et√©rea: Pode atravessar barreiras f√≠sicas leves uma vez por cena.\n\nToque Fantasmal: Seus ataques ignoram armaduras f√≠sicas por 1 rodada (1x por combate).\n\nMem√≥ria Fragmentada: Recebe vantagem em testes de Ocultismo e Percep√ß√£o.\n\nPresen√ßa Silenciosa: +2 em Furtividade e +1 em Reflexos ao agir nas sombras.', talents: MORTALHAS_TALENTS, maculas: MORTALHAS_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Cr√¥nidas': { status: { lifeDice: '2d6+4', def: 6, rf: 4, rm: 1 }, featuresText: 'Pulso Temporal: Pode repetir um teste de atributo uma vez por dia (revers√£o temporal).\n\nEco do Futuro: Recebe +1 em testes de Reflexo, Percep√ß√£o e Intui√ß√£o.\n\nDist√∫rbio Cronal: Pode causar lentid√£o em um inimigo com sucesso cr√≠tico em ataque.\n\nDom√≠nio do Tempo: Recebe vantagem em rituais com a camada ‚ÄúOrgulho‚Äù ou ‚ÄúServid√£o‚Äù.', talents: CRONIDAS_TALENTS, maculas: CRONIDAS_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Elfo Negro': { status: { lifeDice: '5d4+5', def: 11, rf: 5, rm: 7 }, featuresText: 'Magia Natural: Recebe +1 em conjura√ß√£o de rituais com Camadas de Lux√∫ria e Inveja.\n\nGra√ßa Sombria: Recebe +2 em testes de Furtividade e Reflexos.\n\nOlhos Noturnos: Pode enxergar na escurid√£o total sem penalidade.\n\nDom da Engana√ß√£o: +1 em Engana√ß√£o e Intimida√ß√£o em ambientes urbanos.', talents: ELFO_NEGRO_TALENTS, maculas: ELFO_NEGRO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } }
        };

        const CLASSES = {
            "Lutador": "Especialista em combate f√≠sico, o Lutador domina o campo de batalha com for√ßa bruta, t√©cnica e resist√™ncia. Ideal para enfrentar inimigos de frente e proteger aliados.",
            "Mago": "Usu√°rio de magias arcanas, manipula os elementos e as for√ßas do universo. Fr√°gil fisicamente, mas devastador √† dist√¢ncia e essencial em combates prolongados.",
            "Beserker": "Guerreiro selvagem que luta tomado pela f√∫ria. Seus ataques s√£o impulsivos e destrutivos, e quanto mais ferido, mais perigoso se torna.",
            "Sacerdote": "Canaliza o poder de divindades para curar, proteger e punir. Consegue expulsar entidades sombrias e aben√ßoar aliados com f√©.",
            "Paladino": "Guerreiro sagrado que une espada e ora√ß√£o. Serve como escudo moral e f√≠sico do grupo, combinando ataques justos com habilidades de prote√ß√£o.",
            "Atirador": "Especialista em combates √† dist√¢ncia. Usa armas de fogo, bestas ou arcos com precis√£o mortal. Possui grande mobilidade e mira certeira.",
            "Bruxo": "Portador de pactos arcanos, o Bruxo canaliza for√ßas obscuras em troca de poder. Suas magias t√™m efeitos imprevis√≠veis e perigosos.",
            "Ca√ßador": "Mestre dos ambientes naturais e rastreamento. Usa armadilhas, venenos e companheiros animais para dominar o campo e emboscar inimigos.",
            "Apostador": "Combatente do acaso. Utiliza dados, cartas e truques de sorte como armas. Habilidoso e imprevis√≠vel, sempre aposta tudo em cada jogada.",
            "Ilus√≥rio": "Manipulador da realidade sensorial. Cria ilus√µes, distor√ß√µes e duplicatas que confundem inimigos e protegem aliados sem que percebam.",
            "Necromante": "Controlador da morte. Invoca mortos, absorve energia vital e domina rituais sombrios. Poderoso, mas temido at√© por aliados.",
            "Poeta das Emo√ß√µes": "Ser m√≠stico que transforma sentimentos em magia. Usa palavras, sons e aura emocional para alterar o campo de batalha de forma inspiradora ou aterradora.",
            "Artes√£o": "Criador de armas, itens m√°gicos e engenhocas √∫nicas. Capaz de forjar artefatos em tempo real, melhorar equipamentos e at√© usar cria√ß√µes em combate.",
            "Aniquilador": "Classe destrutiva e implac√°vel. Foca em eliminar inimigos com m√°xima brutalidade, usando t√©cnicas impiedosas e habilidades devastadoras.",
            "Mateiro": "Sobrevivente nato. Especializado em emboscadas, rastreamento e terreno hostil. Usa conhecimento do ambiente para dominar qualquer campo de batalha."
        };
        
        const CLASS_DATA = {
            'Lutador': { status: { vida: 10, rf: 2, rm: 2 }, featuresText: 'ESTRAT√âGIA DE COMBATE: Vantagem em testes de For√ßa para usar o ambiente ou atacar pontos fracos.\n\nMESTRE DE ARMAS: Usa qualquer arma com maestria, +1 dado de dano corpo a corpo, troca sem penalidade.\n\nRESIST√äNCIA FEROZ: +6 Defesa tempor√°ria ap√≥s sofrer ataque cr√≠tico.\n\nMURALHA VIVA: +2 Defesa contra todos os ataques ao ser cercado por 2 ou mais inimigos por 1 rodada.\n\nMAESTRIA: Est√°gio 1: +5 de dano f√≠sico fixo.', apexText: 'DESAFIO: Fazer uma grande demonstra√ß√£o de for√ßa f√≠sica ou perseveran√ßa que impacte a narrativa (ex: derrotar inimigo forte, erguer algo monumental etc).\n\nHABILIDADE CARACTER√çSTICA: Uma vez por combate, pode executar um ataque especial que causa 3d8 + FOR de dano. Se eliminar o inimigo, recupera Vida igual a metade do dano causado.' },
            'Mago': { status: { vida: 5, rf: 2, rm: 5 }, featuresText: '‚Üí +1 Runa gratuita na cria√ß√£o\n‚Üí +1 em Conjura√ß√£o M√°gica\n‚Üí +2 em Ocultismo\n‚Üí Pode usar rituais com 1 rodada a menos\n‚Üí Ganha +2 em testes de PENSAMENTO com qualquer elemento', apexText: 'DESAFIO: Ao causar um efeito m√°gico impactante (ex: paralisar um inimigo poderoso, controlar o ambiente ou evitar uma cat√°strofe com magia).\n\nHABILIDADE: Uma vez por combate, pode lan√ßar uma magia sem custo de runa e com vantagem dupla no teste de conjura√ß√£o.' },
            'Beserker': { status: { vida: 15, rf: 2, rm: 1 }, featuresText: '‚Üí +2 em testes de Corpo durante combates\n‚Üí Pode entrar em F√∫ria por 3 turnos (+2 dano f√≠sico, -1 Defesa)\n‚Üí Ao cair abaixo de 25% da Vida, ganha +3 em testes f√≠sicos\n‚Üí +1 dado de dano em ataques f√≠sicos com armas grandes', apexText: 'DESAFIO: Ao entrar em f√∫ria contra um inimigo maior ou mais forte.\n\nHABILIDADE: Pode ignorar efeitos de dor/penalidade por 2 rodadas e causar +2d12 de dano extra em um ataque.' },
            'Sacerdote': { status: { vida: 8, rf: 3, rm: 6 }, featuresText: '‚Üí Conjura com +1 b√¥nus se for em nome da devo√ß√£o\n‚Üí Cura aliados com +1d4 adicional\n‚Üí Pode purificar ou banir entidades com ritual em metade do tempo\n‚Üí +2 em testes de Devo√ß√£o', apexText: 'DESAFIO: Ao curar um aliado em estado cr√≠tico ou expulsar um inimigo espiritual relevante.\n\nHABILIDADE: Uma vez por combate, pode realizar uma cura em √°rea (3 alvos) com 2d8 + ALM de Vida.' },
            'Paladino': { status: { vida: 10, rf: 8, rm: 6 }, featuresText: '‚Üí Pode usar magia e ataque corpo a corpo sem penalidades\n‚Üí Reduz em -2 o dano m√°gico recebido se for em nome de sua devo√ß√£o\n‚Üí +2 em testes contra corrup√ß√£o ou possess√£o\n‚Üí Pode causar +1d6 de dano sagrado 1x por combate', apexText: 'DESAFIO: Ao proteger inocentes de uma grande amea√ßa, resistindo ao mal com firmeza.\n\nHABILIDADE: Pode ativar um escudo sagrado por 2 turnos (absorve at√© 20 de dano e cura 1d6 ao final).' },
            'Atirador': { status: { vida: 5, rf: 3, rm: 3 }, featuresText: '‚Üí +2 em Pontaria\n‚Üí Pode disparar duas vezes por rodada (com penalidade de -2 no segundo tiro)\n‚Üí Recebe vantagem ao atacar inimigos em emboscada\n‚Üí +1d6 de dano adicional se estiver em posi√ß√£o elevada', apexText: 'DESAFIO: Ao eliminar um alvo importante com precis√£o em condi√ß√µes adversas.\n\nHABILIDADE: Pode disparar um ‚ÄúTiro Certeiro‚Äù que ignora cobertura e causa +3d10 de dano.' },
            'Bruxo': { status: { vida: 6, rf: 2, rm: 4 }, featuresText: '‚Üí Pode escolher um Patrono (entidade) que concede +1 em testes relacionados ao dom√≠nio escolhido\n‚Üí +2 em Conjura√ß√£o Ritual√≠stica\n‚Üí Ao conjurar com sucesso, pode invocar um efeito adicional uma vez por cena\n‚Üí Ganha +1 Runa ou S√≠mbolo Ritual√≠stico gratuito', apexText: 'DESAFIO: Ao invocar com sucesso um efeito de um patrono que altera o curso da cena ou hist√≥ria.\n\nHABILIDADE: Uma vez por combate, conjura um ritual instant√¢neo sem teste, escolhendo entre dano, controle ou cura (escolha ao usar).' },
            'Ca√ßador': { status: { vida: 7, rf: 3, rm: 2 }, featuresText: '‚Üí +2 em Sobreviv√™ncia e Percep√ß√£o\n‚Üí Pode seguir rastros m√°gicos e naturais\n‚Üí Causa +1d6 contra alvos previamente observados\n‚Üí Recebe vantagem contra monstros e aberra√ß√µes naturais', apexText: 'DESAFIO: Ao rastrear e eliminar uma criatura amea√ßadora sem ajuda direta.\n\nHABILIDADE: Pode marcar um inimigo como "presa" ‚Äì ganha +2 em todos os testes contra ele por 3 turnos e +1d12 de dano.' },
            'Apostador': { status: { vida: 7, rf: 7, rm: 7 }, featuresText: '‚Üí Pode rolar 1d6 por cena e escolher aplicar o n√∫mero como b√¥nus em qualquer teste\n‚Üí Ganha vantagem em qualquer teste de sorte, blefe ou jogos\n‚Üí Ao obter sucesso cr√≠tico, pode jogar novamente e escolher o melhor\n‚Üí +2 em Engana√ß√£o e Reflexos', apexText: 'DESAFIO: Ao virar uma situa√ß√£o desesperadora a seu favor com sorte ou manipula√ß√£o.\n\nHABILIDADE: Uma vez por combate, pode transformar uma falha em sucesso com um teste de Carisma (D.A 10 + grau da falha).' },
            'Ilus√≥rio': { status: { vida: 5, rf: 4, rm: 3 }, featuresText: '‚Üí +2 em testes de Engana√ß√£o e Manipula√ß√£o\n‚Üí Ilus√µes t√™m D.A aumentada em +2\n‚Üí Pode criar duplicatas, vozes, ou imagens com 1 a√ß√£o r√°pida\n‚Üí Recebe +1 Runa do Pensamento', apexText: 'DESAFIO: Ao enganar completamente um inimigo, grupo ou multid√£o com uma ilus√£o poderosa.\n\nHABILIDADE: Uma vez por cena, cria uma ilus√£o realista que dura 2 rodadas e confunde todos os oponentes (testes com desvantagem).' },
            'Necromante': { status: { vida: 4, rf: 1, rm: 6 }, featuresText: '‚Üí +2 em Ocultismo\n‚Üí Pode conjurar magias relacionadas √† morte, esp√≠ritos e decad√™ncia com +1\n‚Üí Pode animar 1 esqueleto/zumbi por dia (padr√£o, fraco)\n‚Üí +1 Runa de Sangue gratuita', apexText: 'DESAFIO: Ao invocar ou controlar um morto para alterar o equil√≠brio da cena.\n\nHABILIDADE: Uma vez por combate, pode reanimar temporariamente 1 aliado ca√≠do por 1 turno com 1d12 de Vida e defesa m√≠nima.' },
            'Poeta das Emo√ß√µes': { status: { vida: 3, rf: 3, rm: 3 }, featuresText: '‚Üí Escolhe uma emo√ß√£o (Raiva, Tristeza, Amor, Medo etc.) ao criar o personagem\n‚Üí +2 em testes relacionados √† emo√ß√£o escolhida\n‚Üí Pode inspirar aliados, dando +2 em testes sociais ou +1d6 de dano\n‚Üí Pode anular um medo, trauma ou efeito emocional com uma performance', apexText: 'DESAFIO: Ao comover, curar ou enfurecer um grupo ou inimigo com sua performance.\n\nHABILIDADE: Uma vez por combate, pode aplicar o efeito de sua emo√ß√£o em todos os aliados e inimigos numa √°rea de 10m.' },
            'Artes√£o': { status: { vida: 8, rf: 6, rm: 7 }, featuresText: '‚Üí Pode construir ou reparar armas, itens ou prote√ß√µes entre cenas\n‚Üí +2 em testes de Profiss√£o e Conhecimentos Gerais\n‚Üí Armas criadas pelo Artes√£o causam +1d4 de dano\n‚Üí Pode adicionar efeitos extras a itens com runas ou materiais raros', apexText: 'DESAFIO: Ao criar um item lend√°rio, uma arma simb√≥lica ou salvar o grupo com uma cria√ß√£o.\n\nHABILIDADE: Uma vez por sess√£o, pode criar instantaneamente um equipamento (b√°sico) de sua escolha com b√¥nus especial.' },
            'Aniquilador': { status: { vida: 7, rf: 7, rm: 2 }, featuresText: '‚Üí +2 em testes de Intimida√ß√£o\n‚Üí Causa +1d6 de dano em qualquer ataque contra estruturas, objetos ou grupos\n‚Üí Ganha vantagem contra inimigos com armadura ou defesa elevada\n‚Üí Pode escolher destruir armas e escudos com 1 ataque cr√≠tico', apexText: 'DESAFIO: Ao destruir um obst√°culo significativo, fortaleza, prote√ß√£o ou eliminar um grupo de inimigos.\n\nHABILIDADE: Uma vez por combate, pode realizar um golpe que ignora armadura e reduz em 1 o R.F do inimigo permanentemente.' },
            'Mateiro': { status: { vida: 6, rf: 4, rm: 4 }, featuresText: '‚Üí +2 em testes de Sobreviv√™ncia, Medicina e Montaria\n‚Üí N√£o sofre penalidade em terrenos dif√≠ceis\n‚Üí Pode se camuflar naturalmente, ganhando vantagem em Furtividade\n‚Üí Ganha resist√™ncia natural contra venenos (+2 nos testes)', apexText: 'DESAFIO: Ao salvar um grupo em ambiente hostil com conhecimento da natureza ou eliminar uma criatura natural poderosa.\n\nHABILIDADE: Uma vez por combate, pode invocar um ‚ÄúAspecto da Natureza‚Äù que fornece +2 em todos os testes f√≠sicos e +2 R.F por 3 turnos.' }
        };
        const EQUIPMENT_DATA = {
            armor: {
                leve: { def: 2, thresholds: { damaged: 1, broken: 2 } },
                media: { def: 5, thresholds: { damaged: 2, broken: 4 } },
                pesada: { def: 10, thresholds: { damaged: 3, broken: 6 } }
            },
            shield: {
                pequeno: { rf: 2, thresholds: { damaged: 1, broken: 2 } },
                grande: { rf: 5, thresholds: { damaged: 2, broken: 4 } }
            }
        };

        const SKILLS = ['Arremesso[FOR]', 'Arrombamento[FOR]', 'Atletismo[COR]', 'Ci√™ncias[MEN]', 'Combate[FOR]', 'Conjura√ß√£o M√°gica[MEN]', 'Conjura√ß√£o Ritual√≠stica[ALM]', 'Investigar[MEN]', 'Medicina[MEN]', 'Montaria[DES]', 'Ocultismo[MEN]', 'Percep√ß√£o[MEN]', 'Pontaria[DEST]', 'Profiss√£o[MEN]', 'Reflexos[DES]', 'Resist√™ncia F√≠sica[COR]', 'Resistir Influ√™ncia[ALM]', 'Sentidos Ocultos[ALM]', 'Sobreviv√™ncia[MEN]', 'Conhecimentos Gerais[MEN]', 'Devo√ß√£o[ALM]', 'Diplomacia[CAR]', 'Engana√ß√£o[CAR]', 'Furtividade[DES]', 'Intimida√ß√£o[CAR]', 'Intui√ß√£o[ALM]'];
        const RUNE_ELEMENTS = ['Fogo', 'Gelo', '√Ågua', 'Rel√¢mpago', 'Vento', 'Alma', 'Ferro', 'Terra', 'Sangue'];
        const RUNE_SIGILS = ['Poder', 'Prote√ß√£o', 'Pensamento'];
        const RITUAL_LAYERS = ['Lux√∫ria', 'Gula', 'Avareza', 'Ira', 'Inveja', 'Pregui√ßa', 'Orgulho', 'Pecado', 'Servid√£o'];
        

        // --- FUN√á√ïES DE INICIALIZA√á√ÉO E L√ìGICA ---
        function initDropdown(select, options) { select.innerHTML = `<option value="">Selecione...</option>` + Object.keys(options).map(opt => `<option value="${opt}">${opt}</option>`).join(''); }
        function updateDescriptionBox(container, options, value) { if(options[value]) { container.innerHTML = `<div class="parchment-box">${options[value]}</div>`; container.classList.remove('hidden'); } else { container.classList.add('hidden'); } }
        function initSkills() { skillsList.innerHTML = SKILLS.map(skill => { const id = `skill-${skill.toLowerCase().replace(/[\s\/]/g, '-')}`; return `<div class="flex items-center gap-2"><input type="checkbox" id="${id}" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500"><label for="${id}" class="flex-1">${skill}</label><input type="number" id="${id}-level" class="input-base w-16 p-1 text-center" value="0"></div>`; }).join(''); }
        function createApexes(container, prefix, count) { for (let i = 0; i < count; i++) { container.innerHTML += `<div class="flex flex-col gap-1 apex-item"><input type="text" id="${prefix}-${i}-name" class="input-base w-full p-2" placeholder="Nome do √Åpice ${i+1}"><textarea id="${prefix}-${i}-desc" class="textarea-base w-full p-2 h-16" placeholder="Descri√ß√£o..."></textarea></div>`; } }

        function rollLife() {
            const raceData = RACE_DATA[raceSelect.value];
            const classData = CLASS_DATA[classSelect.value];
            if (!raceData || !classData) {
                displayMessageBox("Por favor, selecione uma Ra√ßa e uma Classe primeiro.");
                return;
            }

            const lifeDiceExpression = raceData.status.lifeDice; // e.g., "2d6+5"
            const parts = lifeDiceExpression.split('+');
            const [diceCountStr, diceSidesStr] = parts[0].split('d');
            const diceCount = Number(diceCountStr);
            const diceSides = Number(diceSidesStr);
            const modifier = Number(parts[1]) || 0;

            let rolls = [];
            let totalRollsValue = 0;

            // Create the main overlay for the animation and results
            const diceOverlay = document.createElement('div');
            diceOverlay.className = 'dice-overlay-result'; // Start hidden
            document.body.appendChild(diceOverlay);

            // Create container for the animated dice
            const diceAnimationContainer = document.createElement('div');
            diceAnimationContainer.className = 'dice-animation-container';
            diceOverlay.appendChild(diceAnimationContainer);

            // Create and append animated die elements
            const animatedDiceElements = [];
            for (let i = 0; i < diceCount; i++) {
                const dieEl = document.createElement('div');
                dieEl.className = 'animated-die';
                dieEl.textContent = 'üé≤'; // Initial emoji for rolling effect
                diceAnimationContainer.appendChild(dieEl);
                animatedDiceElements.push(dieEl);
            }

            // Show the overlay and trigger initial fall animation
            diceOverlay.classList.add('show');
            animatedDiceElements.forEach((dieEl, index) => {
                // Stagger the animation slightly for better effect
                setTimeout(() => {
                    dieEl.classList.add('start-roll');
                }, index * 150); // Small delay for each die
            });

            // After animation, calculate and show results
            // This timeout should be slightly longer than the die-fall animation duration (1.5s)
            setTimeout(() => {
                animatedDiceElements.forEach((dieEl, index) => {
                    const roll = Math.floor(Math.random() * diceSides) + 1;
                    rolls.push(roll);
                    totalRollsValue += roll;

                    // Stop animation and show final value
                    dieEl.classList.add('show-final-value');
                    dieEl.textContent = roll;
                });

                const finalLife = totalRollsValue + modifier + classData.status.vida;

                // Update character sheet inputs
                statusMaxVida.value = finalLife;
                statusCurrentVida.value = finalLife;

                let resultText = `<p class="text-xl"><strong>üé≤ Rolagens:</strong> ${rolls.join(", ")}`;
                if (modifier > 0) resultText += ` + ${modifier} (Ra√ßa)`;
                if (classData.status.vida > 0) resultText += ` + ${classData.status.vida} (Classe)`;
                resultText += `</p><p class="text-4xl font-bold mt-4 text-yellow-400">‚ù§Ô∏è Vida Total: ${finalLife}</p>`;

                // Create a result box within the overlay
                const resultBox = document.createElement('div');
                resultBox.className = 'result-box';
                resultBox.innerHTML = resultText + `<button class="btn-primary py-2 px-4 rounded-lg mt-4" id="close-roll-result">Entendido</button>`;

                // Append the result box after the dice animation has settled
                diceOverlay.appendChild(resultBox);

                // Add event listener to close button
                getEl('close-roll-result').addEventListener('click', () => {
                    diceOverlay.classList.remove('show');
                    // Remove the overlay from DOM after it fades out
                    setTimeout(() => diceOverlay.remove(), 500);
                });

                // Set life as rolled and hide the roll button
                document.body.dataset.lifeRolled = 'true';
                lifeRollContainer.classList.add('hidden');
            }, 2000); // Give 2 seconds for the dice animation to play
        }
        
        function updateAllStats() {
            const raceData = RACE_DATA[raceSelect.value];
            const classData = CLASS_DATA[classSelect.value];
            
            let def = 0, rf = 0, rm = 0;

            if (raceData) { def += raceData.status.def; rf += raceData.status.rf; rm += raceData.status.rm; }
            if (classData) { def += classData.status.def || 0; rf += classData.status.rf || 0; rm += classData.status.rm || 0; }
            
            const deaths = parseInt(getEl('deaths').value, 10) || 0;
            
            const armorType = getEl('armor-type').value;
            const armorData = EQUIPMENT_DATA.armor[armorType];
            const armorDisplay = getEl('armor-status-display');
            if(armorData) {
                let state = 'Inteira';
                if(deaths >= armorData.thresholds.broken) state = 'Quebrada';
                else if(deaths >= armorData.thresholds.damaged) state = 'Danificada';
                armorDisplay.textContent = `Estado: ${state} (+${state === 'Quebrada' ? 0 : armorData.def} DEF)`;
                armorDisplay.className = `text-sm mt-1 text-center state-${state.toLowerCase()}`;
                if(state !== 'Quebrada') def += armorData.def;
            } else {
                armorDisplay.textContent = '';
            }
            
            const shieldType = getEl('shield-type').value;
            const shieldData = EQUIPMENT_DATA.shield[shieldType];
            const shieldDisplay = getEl('shield-status-display');
             if(shieldData) {
                let state = 'Inteiro';
                if(deaths >= shieldData.thresholds.broken) state = 'Quebrado';
                else if(deaths >= shieldData.thresholds.damaged) state = 'Danificado';
                shieldDisplay.textContent = `Estado: ${state} (+${state === 'Quebrado' ? 0 : shieldData.rf} RF)`;
                shieldDisplay.className = `text-sm mt-1 text-center state-${state.toLowerCase().replace('o', '')}`;
                if(state !== 'Quebrado') rf += shieldData.rf;
            } else {
                shieldDisplay.textContent = '';
            }
            getEl('status-def').value = def;
            getEl('status-rf').value = rf;
            getEl('status-rm').value = rm;
        }
        
        function handleClassSelection() {
            updateDescriptionBox(classDescriptionContainer, CLASSES, classSelect.value);
            const classData = CLASS_DATA[classSelect.value];
            if (classData && !window.loadingData) {
                getEl('char-class-features').value = classData.featuresText;
                getEl('char-apex-text').value = classData.apexText;
            }
            document.body.dataset.previousClass = classSelect.value;
            if (raceSelect.value && classSelect.value && document.body.dataset.lifeRolled === 'false') {
                lifeRollContainer.classList.remove('hidden');
                lifeRollResult.innerHTML = '';
            }
            updateAllStats();
        }

        function handleRaceSelection() {
            const selectedRace = raceSelect.value;
            const raceData = RACE_DATA[selectedRace];
            
            updateDescriptionBox(raceDescriptionContainer, RACES, selectedRace);
            raceChoicesContainer.innerHTML = '';  
            raceChoicesContainer.classList.add('hidden');
            document.body.dataset.lifeRolled = 'false'; // Resetar a rolagem ao trocar de ra√ßa

            if (!raceData) { updateAllStats(); return; }

            if (!window.loadingData) {
                getEl('char-race-features').value = raceData.featuresText;
                getEl('char-talents').value = '';  
                if (classSelect.value) { // Mostrar bot√£o de rolar apenas se a classe j√° estiver selecionada
                    lifeRollContainer.classList.remove('hidden');
                    lifeRollResult.innerHTML = '';
                }
            }
            
            updateAllStats();   

            if (!getEl('char-talents').value && raceData.choiceLogic) {
                raceChoicesContainer.classList.remove('hidden');
                setupRaceChoices(raceData);
            }
        }

        function setupRaceChoices(raceData) {
            const { type } = raceData.choiceLogic;
            if (type === 'standard') {
                setupStandardChoices(raceData);
            } else if (type === 'vampire') {
                setupVampireChoices(raceData);
            } else if (type === 'dampiro') {
                setupDampiroChoices();
            }
        }
        
        function createChoiceHTML(list, title, max, type) {
            let content = `<div data-type="${type}"><h3 class="font-runic text-xl text-yellow-300 mb-2">${title}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-2" data-max="${max}">`;
            list.forEach(item => {
                const choiceId = `choice-${type}-${item.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                content += `<div class="flex items-center gap-2 choice-box p-2 rounded"><input type="checkbox" id="${choiceId}" data-name="${item}" class="choice-checkbox form-checkbox h-5 w-5 rounded"><label for="${choiceId}">${item}</label></div>`;
            });
            content += '</div></div>';
            return content;
        }

        function setupStandardChoices(raceData) {
            const { talents, maculas, choiceLogic } = raceData;
            raceChoicesContainer.innerHTML = 
                createChoiceHTML(talents, `Escolha ${choiceLogic.talents} Talentos`, choiceLogic.talents, 'talent') +
                `<div class="mt-4">${createChoiceHTML(maculas, `Escolha ${choiceLogic.maculas} M√°culas`, choiceLogic.maculas, 'macula')}</div>`;
        }

        function setupVampireChoices(raceData) {
            const { talents, maculas } = raceData;
            let maculaHTML = `<div data-type="macula"><h3 class="font-runic text-xl text-yellow-300 mb-2">Escolha 1 M√°cula Adicional</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-2" data-max="2">`;
            maculaHTML += `<div class="flex items-center gap-2 choice-box p-2 rounded bg-blue-900/50"><input type="checkbox" data-name="Sede de Sangue (Heredit√°ria)" checked disabled class="form-checkbox"><label>Sede de Sangue (Heredit√°ria)</label></div>`;
            maculas.forEach(item => {
                const choiceId = `choice-macula-${item.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                maculaHTML += `<div class="flex items-center gap-2 choice-box p-2 rounded"><input type="checkbox" id="${choiceId}" data-name="${item}" class="choice-checkbox form-checkbox h-5 w-5 rounded"><label for="${choiceId}">${item}</label></div>`;
            });
               maculaHTML += `</div></div>`;

            raceChoicesContainer.innerHTML = createChoiceHTML(talents, `Escolha 2 Talentos`, 2, 'talent') + `<div class="mt-4">${maculaHTML}</div>`;
        }

        function setupDampiroChoices() {
            raceChoicesContainer.innerHTML = `
                <h3 class="font-runic text-xl text-yellow-300 mb-2">Prole de Nosferatu: Escolha seu Legado</h3>
                <div class="flex gap-4 mb-4">
                    <button id="dampiro-path-default" class="btn-primary p-2 rounded-lg flex-1">Legado de Dampiro</button>
                    <button id="dampiro-path-hybrid" class="btn-secondary p-2 rounded-lg flex-1">Legado H√≠brido</button>
                </div>
                <div id="dampiro-default-choices">${createChoiceHTML(DAMPIRO_TALENTS, 'Escolha 2 Talentos de Dampiro', 2, 'talent')} <div class="mt-4">${createChoiceHTML(DAMPIRO_MACULAS, 'Escolha 2 M√°culas de Dampiro', 2, 'macula')}</div></div>
                <div id="dampiro-hybrid-choices" class="hidden">${createChoiceHTML(HUMAN_TALENTS.concat(VAMPIRE_TALENTS), 'Escolha 2 Talento (Humano ou Vampiro)', 2, 'talent')} <div class="mt-4">${createChoiceHTML(HUMAN_MACULAS.concat(VAMPIRE_MACULAS_OPTIONAL), 'Escolha 2 M√°cula (Humana ou Vampiro)', 2, 'macula')}</div></div>
            `;
            getEl('dampiro-path-default').addEventListener('click', () => { getEl('dampiro-default-choices').classList.remove('hidden'); getEl('dampiro-hybrid-choices').classList.add('hidden'); });
            getEl('dampiro-path-hybrid').addEventListener('click', () => { getEl('dampiro-default-choices').classList.add('hidden'); getEl('dampiro-hybrid-choices').classList.remove('hidden'); });
        }
        
        raceChoicesContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('choice-checkbox')) {
                const container = e.target.closest('[data-max]');
                if (!container) return;
                const max = parseInt(container.dataset.max, 10);
                
                const totalChecked = container.querySelectorAll('input:checked').length;
                
                container.querySelectorAll('input:not(:checked)').forEach(cb => cb.disabled = totalChecked >= max);
                updateTalentsAndMaculasText();
            }
        });

        function updateTalentsAndMaculasText() {
            const talentDivs = raceChoicesContainer.querySelectorAll('[data-type="talent"]');
            const maculaDivs = raceChoicesContainer.querySelectorAll('[data-type="macula"]');
            
            let selectedTalents = [];
            let selectedMaculas = [];

            talentDivs.forEach(container => {
                if (!container.closest('.hidden')) {
                    selectedTalents.push(...Array.from(container.querySelectorAll('input:checked')).map(cb => cb.dataset.name));
                }
            });
            maculaDivs.forEach(container => {
                if (!container.closest('.hidden')) {
                    selectedMaculas.push(...Array.from(container.querySelectorAll('input:checked')).map(cb => cb.dataset.name));
                }
            });
            
            let text = '';
            if (selectedTalents.length > 0) text += 'Talentos: ' + selectedTalents.join(', ') + '.\n\n';
            if (selectedMaculas.length > 0) text += 'M√°culas: ' + selectedMaculas.join(', ') + '.';
            getEl('char-talents').value = text;
            
            const raceData = RACE_DATA[raceSelect.value];
            if (!raceData || !raceData.choiceLogic) return;
            
            const { choiceLogic } = raceData;
            let talentsDone = false, maculasDone = false;

            if (choiceLogic.type === 'standard') {
                talentsDone = selectedTalents.length === choiceLogic.talents;
                maculasDone = selectedMaculas.length === choiceLogic.maculas;
            } else if (choiceLogic.type === 'vampire') {
                talentsDone = selectedTalents.length === 2;
                maculasDone = selectedMaculas.length === 2; // 1 default + 1 escolhida
            } else if (choiceLogic.type === 'dampiro') {
                const isHybrid = getEl('dampiro-hybrid-choices') && !getEl('dampiro-hybrid-choices').classList.contains('hidden');
                talentsDone = selectedTalents.length === (isHybrid ? 2 : 2); // Dampiro always picks 2 talents, hybrid or not
                maculasDone = selectedMaculas.length === (isHybrid ? 2 : 2); // Dampiro always picks 2 maculas, hybrid or not
            }

            if (talentsDone && maculasDone) {
                raceChoicesContainer.classList.add('hidden');
            }
        }

        // --- FUN√á√ïES DIN√ÇMICAS E UTILIT√ÅRIAS ---
        function addDynamicListItem(listElement, itemClass, innerHTML) {
            const itemId = `item-${Date.now()}`;
            const itemEl = document.createElement('div');
            itemEl.id = itemId;
            itemEl.className = itemClass;
            itemEl.innerHTML = innerHTML.replace(/{{itemId}}/g, itemId);
            listElement.appendChild(itemEl);
        }

        function addInventoryItem() { addDynamicListItem(inventoryList, 'p-2 card flex flex-col gap-2', `<div class="flex gap-2"><input type="text" class="input-base flex-grow p-1" placeholder="Nome do Item"><button class="btn-danger p-1 px-2 rounded" onclick="document.getElementById('{{itemId}}').remove()"><i class="fas fa-trash"></i></button></div><textarea class="textarea-base w-full p-1 h-12" placeholder="Descri√ß√£o"></textarea><div class="grid grid-cols-2 gap-2"><input type="text" class="input-base p-1" placeholder="Dano"><input type="text" class="input-base p-1" placeholder="Efeito/Cr√≠tico"></div>`); }
        function addRune() { addDynamicListItem(runesList, 'p-2 card flex items-center gap-2', `<div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-2"><select class="select-base p-1">${RUNE_ELEMENTS.map(e => `<option>${e}</option>`).join('')}</select><select class="select-base p-1">${RUNE_SIGILS.map(s => `<option>${s}</option>`).join('')}</select><input type="number" class="input-base p-1 text-center" placeholder="Ac√∫mulos" value="0"></div><button class="btn-danger p-1 px-2 rounded" onclick="document.getElementById('{{itemId}}').remove()"><i class="fas fa-trash"></i></button>`); }
        function addRitual() { addDynamicListItem(ritualsList, 'p-2 card flex flex-col', `<div class="flex gap-2 items-center mb-2"><input type="text" class="input-base flex-grow p-1" placeholder="Nome do Ritual"><button class="btn-danger p-1 px-2 rounded" onclick="document.getElementById('{{itemId}}').remove()"><i class="fas fa-trash"></i></button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2"><select class="select-base p-1">${RITUAL_LAYERS.map(l => `<option>${l}</option>`).join('')}</select><input type="number" class="input-base p-1 text-center" placeholder="Usos" value="0"></div><textarea class="textarea-base w-full p-1 h-16" placeholder="Descri√ß√£o do Ritual..."></textarea>`); }
        
        function handleDracmaConversion() {
            let b = parseInt(getEl('dracma-b').value) || 0;
            let p = parseInt(getEl('dracma-p').value) || 0;
            let o = parseInt(getEl('dracma-o').value) || 0;
            let d = parseInt(getEl('dracma-d').value) || 0;

            p += Math.floor(b / 10); b %= 10;
            o += Math.floor(p / 10); p %= 10;
            d += Math.floor(o / 100); o %= 100;

            getEl('dracma-b').value = b; getEl('dracma-p').value = p;
            getEl('dracma-o').value = o; getEl('dracma-d').value = d;
            
            const totalBronze = b + (p * 10) + (o * 100) + (d * 10000);
            getEl('dracma-details').innerHTML = `
                <p>‚ô¶Ô∏è ${d} (equivale a ${d*100} ü™ô)</p>
                <p>ü™ô ${o} (equivale a ${o*10} ü•à)</p>
                <p>ü•à ${p} (equivale a ${p*10} üü§)</p>
                <p class="pt-1 mt-1 border-t border-gray-600"><strong>Total:</strong> ${totalBronze.toLocaleString('pt-BR')} em Bronze</p>
            `;
        }

        // Custom message box function (updated to remove existing before creating new)
        function displayMessageBox(message) {
            const messageBoxContainer = getEl('message-box-container');
            // Remove any existing message boxes first
            while (messageBoxContainer.firstChild) {
                messageBoxContainer.removeChild(messageBoxContainer.firstChild);
            }

            const messageBoxId = 'custom-message-box';
            let messageBox = document.createElement('div');
            messageBox.id = messageBoxId;
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
            messageBox.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                    <p class="text-white text-lg mb-4">${message}</p>
                    <button class="btn-primary py-2 px-4 rounded-lg" id="message-box-ok-btn">OK</button>
                </div>
            `;
            messageBoxContainer.appendChild(messageBox);

            // Add event listener to the dynamically created OK button
            getEl('message-box-ok-btn').addEventListener('click', () => {
                messageBox.remove();
            });
        }

        // Nova fun√ß√£o para lidar com a mudan√ßa na vida atual
        function handleCurrentVidaChange() {
            let current = parseInt(statusCurrentVida.value, 10);
            const max = parseInt(statusMaxVida.value, 10);
            if (isNaN(current)) current = 0; // Treat non-numbers as 0

            if (current > max) {
                statusCurrentVida.value = max;
            } else if (current < 0) {
                statusCurrentVida.value = 0;
            }
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            } else {
                document.body.classList.remove('light-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            localStorage.setItem('draemoraTheme', theme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('draemoraTheme') || 'dark';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }

        // --- Multi-Sheet Management ---
        let allCharacterSheets = {};
        let currentLoadedSheetName = null; // To keep track of the currently loaded sheet

        function loadAllSheetsFromLocalStorage() {
            const storedSheets = localStorage.getItem('draemoraCharacterSheets');
            if (storedSheets) {
                allCharacterSheets = JSON.parse(storedSheets);
            } else {
                allCharacterSheets = {};
            }
        }

        function displaySavedSheets() {
            savedSheetsList.innerHTML = '';
            const sheetNames = Object.keys(allCharacterSheets);
            if (sheetNames.length === 0) {
                savedSheetsList.innerHTML = '<p class="text-gray-400">Nenhuma ficha salva.</p>';
                return;
            }

            sheetNames.forEach(name => {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'flex items-center justify-between p-2 card';
                sheetItem.innerHTML = `
                    <span class="font-bold">${name}</span>
                    <div class="flex gap-2">
                        <button class="btn-primary p-2 rounded-lg text-sm" data-sheet-name="${name}" data-action="load">Carregar</button>
                        <button class="btn-danger p-2 rounded-lg text-sm" data-sheet-name="${name}" data-action="delete">Excluir</button>
                    </div>
                `;
                savedSheetsList.appendChild(sheetItem);
            });
        }

        function loadSheet(sheetName) {
            if (allCharacterSheets[sheetName]) {
                clearAllSheetFields(); // Clear current sheet before loading new one

                // Re-initialize dropdowns and skills before loading data
                initDropdown(classSelect, CLASSES);
                initDropdown(raceSelect, RACE_DATA);
                initSkills();
                raceApexesContainer.innerHTML = '';
                classApexesContainer.innerHTML = '';
                createApexes(raceApexesContainer, 'race-apex', 4);
                createApexes(classApexesContainer, 'class-apex', 4);

                window.loadingData = true; // Prevent reactive updates during load
                
                const data = allCharacterSheets[sheetName];

                charNameInput.value = data.name || '';
                classSelect.value = data.class || '';
                raceSelect.value = data.race || '';
                charDevotionInput.value = data.devotion || '';
                getEl('avatar-preview').src = data.avatar || 'https://placehold.co/128x192/0D1B2A/E0E1DD?text=Avatar';
                
                if(data.attrs) Object.entries(data.attrs).forEach(([k,v]) => getEl(`attr-${k}`).value = v);
                if(data.stats) {
                    statusMaxVida.value = data.stats.maxVida || 0;
                    statusCurrentVida.value = data.stats.currentVida || 0;
                    getEl('status-def').value = data.stats.def || 0;
                    getEl('status-rf').value = data.stats.rf || 0;
                    getEl('status-rm').value = data.stats.rm || 0;
                }
                if(data.features) {
                    getEl('char-race-features').value = data.features.race || '';
                    getEl('char-class-features').value = data.features.class || '';
                    getEl('char-talents').value = data.features.talents || '';
                    getEl('char-apex-text').value = data.features.apexText || '';
                    charPersonalBackground.value = data.features.personalBackground || '';
                }
                if(data.equipment) {
                    getEl('armor-type').value = data.equipment.armor || 'nenhuma';
                    getEl('shield-type').value = data.equipment.shield || 'nenhum';
                    getEl('deaths').value = data.equipment.deaths || 0;
                }
                if(data.dracmas) {
                    getEl('dracma-b').value = data.dracmas.b || 0; getEl('dracma-p').value = data.dracmas.p || 0;
                    getEl('dracma-o').value = data.dracmas.o || 0; getEl('dracma-d').value = data.dracmas.d || 0;
                    handleDracmaConversion();
                }
                if(data.skills) data.skills.forEach((s, i) => { const id = `skill-${SKILLS[i].toLowerCase().replace(/[\s\/]/g, '-')}`; if(getEl(id)) { getEl(id).checked = s.trained; getEl(`${id}-level`).value = s.level; } });
                
                inventoryList.innerHTML = '';
                if(data.inventory) data.inventory.forEach(item => { addInventoryItem(); const i = inventoryList.lastChild; i.querySelector('input[type=text]').value = item.name; i.querySelector('textarea').value = item.desc; if (item.dmg) i.querySelectorAll('input[type=text]')[1].value = item.dmg; if (item.crit) i.querySelectorAll('input[type=text]')[2].value = item.crit; });
                
                runesList.innerHTML = '';
                if(data.runes) data.runes.forEach(item => { addRune(); const r = runesList.lastChild; r.querySelectorAll('select')[0].value = item.element; r.querySelectorAll('select')[1].value = item.sigil; r.querySelector('input').value = item.stacks; });
                
                ritualsList.innerHTML = '';
                if(data.rituals) data.rituals.forEach(item => { addRitual(); const r = ritualsList.lastChild; r.querySelector('input[type=text]').value = item.name; r.querySelector('select').value = item.layer; r.querySelector('input[type=number]').value = item.uses; r.querySelector('textarea').value = item.desc; });
                
                if (data.stage2) { getEl('stage2-name').value = data.stage2.name || ''; getEl('stage2-benefit').value = data.stage2.benefit || ''; }
                if (data.stage3) { getEl('stage3-name').value = data.stage3.name || ''; getEl('stage3-ability').value = data.stage3.ability || ''; }
                if (data.stage4) { getEl('stage4-name').value = data.stage4.name || ''; getEl('stage4-effect').value = data.stage4.effect || ''; }
                
                notesTextArea.value = data.notes || '';
                goalsTextArea.value = data.goals || '';

                document.body.dataset.lifeRolled = data.lifeRolled || 'false';
                if (data.lifeRolled === 'true') {
                    lifeRollContainer.classList.add('hidden');
                } else {
                    lifeRollContainer.classList.remove('hidden');
                }
                
                handleClassSelection();
                handleRaceSelection();

                if (data.features && data.features.talents) {
                    raceChoicesContainer.classList.add('hidden');
                } else if (RACE_DATA[data.race] && RACE_DATA[data.race].choiceLogic) {
                    raceChoicesContainer.classList.remove('hidden');
                    setupRaceChoices(RACE_DATA[data.race]);
                    // Re-check selected choices if any
                    if (data.features && data.features.talents) {
                        const loadedTalents = data.features.talents.match(/Talentos: (.*?)\./)?.[1]?.split(', ') || [];
                        const loadedMaculas = data.features.talents.match(/M√°culas: (.*?)\./)?.[1]?.split(', ') || [];
                        loadedTalents.forEach(t => {
                            const cb = getEl(`choice-talent-${t.toLowerCase().replace(/[^a-z0-9]/g, '')}`);
                            if (cb) cb.checked = true;
                        });
                        loadedMaculas.forEach(m => {
                            const cb = getEl(`choice-macula-${m.toLowerCase().replace(/[^a-z0-9]/g, '')}`);
                            if (cb) cb.checked = true;
                        });
                        updateTalentsAndMaculasText(); // Re-run to update disabled states
                    }
                }
                if(data.race === 'Dampiro' && data.dampiroPath) {
                   const dampiroDefault = getEl('dampiro-default-choices');
                   const dampiroHybrid = getEl('dampiro-hybrid-choices');
                    if(dampiroDefault && dampiroHybrid) {
                       if(data.dampiroPath === 'hybrid') {
                            dampiroDefault.classList.add('hidden');
                            dampiroHybrid.classList.remove('hidden');
                        } else {
                            dampiroDefault.classList.remove('hidden');
                            dampiroHybrid.classList.add('hidden');
                        }
                    }
                }
                
                window.loadingData = false;
                currentLoadedSheetName = sheetName;
                localStorage.setItem('lastLoadedSheet', sheetName); // Save last loaded sheet
                displayMessageBox(`Ficha "${sheetName}" carregada com sucesso!`);
                manageSheetsModal.classList.add('hidden'); // Close modal after loading
            } else {
                displayMessageBox(`Ficha "${sheetName}" n√£o encontrada.`);
            }
        }

        function deleteSheet(sheetName) {
            const messageBoxId = 'confirm-delete-box';
            let confirmBox = document.getElementById(messageBoxId);

            if (!confirmBox) {
                confirmBox = document.createElement('div');
                confirmBox.id = messageBoxId;
                confirmBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
                confirmBox.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                        <p class="text-white text-lg mb-4">Tem certeza que deseja excluir a ficha "${sheetName}"? Esta a√ß√£o √© irrevers√≠vel.</p>
                        <div class="flex justify-center gap-4">
                            <button class="btn-danger py-2 px-4 rounded-lg" id="confirm-delete-yes">Sim, Excluir</button>
                            <button class="btn-primary py-2 px-4 rounded-lg" onclick="document.getElementById('${messageBoxId}').remove()">Cancelar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                getEl('confirm-delete-yes').addEventListener('click', () => {
                    document.body.removeChild(confirmBox); // Close the confirmation box
                    delete allCharacterSheets[sheetName];
                    localStorage.setItem('draemoraCharacterSheets', JSON.stringify(allCharacterSheets));
                    displayMessageBox(`Ficha "${sheetName}" exclu√≠da com sucesso!`);
                    displaySavedSheets(); // Refresh the list
                    if (currentLoadedSheetName === sheetName) {
                        clearAllSheetFields(); // Clear current sheet if it was the one deleted
                        currentLoadedSheetName = null;
                        localStorage.removeItem('lastLoadedSheet');
                    }
                });
            } else {
                confirmBox.querySelector('p').textContent = `Tem certeza que deseja excluir a ficha "${sheetName}"? Esta a√ß√£o √© irrevers√≠vel.`;
                confirmBox.style.display = 'flex';
            }
        }


        function saveDataPrompt() {
            const sheetName = prompt("Digite um nome para salvar a ficha:");
            if (sheetName) {
                if (allCharacterSheets[sheetName]) {
                    const overwriteConfirmBoxId = 'confirm-overwrite-box';
                    let overwriteConfirmBox = document.getElementById(overwriteConfirmBoxId);

                    if (!overwriteConfirmBox) {
                        overwriteConfirmBox = document.createElement('div');
                        overwriteConfirmBox.id = overwriteConfirmBoxId;
                        overwriteConfirmBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
                        overwriteConfirmBox.innerHTML = `
                            <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                                <p class="text-white text-lg mb-4">J√° existe uma ficha com o nome "${sheetName}". Deseja substitu√≠-la?</p>
                                <div class="flex justify-center gap-4">
                                    <button class="btn-danger py-2 px-4 rounded-lg" id="confirm-overwrite-yes">Sim, Substituir</button>
                                    <button class="btn-primary py-2 px-4 rounded-lg" onclick="document.getElementById('${overwriteConfirmBoxId}').remove()">Cancelar</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(overwriteConfirmBox);

                        getEl('confirm-overwrite-yes').addEventListener('click', () => {
                            document.body.removeChild(overwriteConfirmBox);
                            saveCurrentSheetData(sheetName);
                        });
                    } else {
                        overwriteConfirmBox.querySelector('p').textContent = `J√° existe uma ficha com o nome "${sheetName}". Deseja substitu√≠-la?`;
                        overwriteConfirmBox.style.display = 'flex';
                    }
                } else {
                    saveCurrentSheetData(sheetName);
                }
            } else {
                displayMessageBox("Nome da ficha n√£o pode ser vazio.");
            }
        }

        function saveCurrentSheetData(sheetName) {
            const dampiroPath = raceSelect.value === 'Dampiro' && getEl('dampiro-hybrid-choices') ? (getEl('dampiro-hybrid-choices').classList.contains('hidden') ? 'default' : 'hybrid') : null;
            const data = {
                avatar: getEl('avatar-preview').src,
                name: charNameInput.value,
                class: classSelect.value,
                race: raceSelect.value,
                devotion: charDevotionInput.value,
                dampiroPath: dampiroPath,
                attrs: { cor: getEl('attr-cor').value, for: getEl('attr-for').value, des: getEl('attr-des').value, men: getEl('attr-men').value, alm: getEl('attr-alm').value, car: getEl('attr-car').value },
                stats: { maxVida: statusMaxVida.value, currentVida: statusCurrentVida.value, def: getEl('status-def').value, rf: getEl('status-rf').value, rm: getEl('status-rm').value },
                features: { race: getEl('char-race-features').value, class: getEl('char-class-features').value, talents: getEl('char-talents').value, apexText: getEl('char-apex-text').value, personalBackground: charPersonalBackground.value },
                equipment: { armor: getEl('armor-type').value, shield: getEl('shield-type').value, deaths: getEl('deaths').value },
                dracmas: { b: getEl('dracma-b').value, p: getEl('dracma-p').value, o: getEl('dracma-o').value, d: getEl('dracma-d').value },
                skills: SKILLS.map(skill => { const id = `skill-${skill.toLowerCase().replace(/[\s\/]/g, '-')}`; return { trained: getEl(id).checked, level: getEl(`${id}-level`).value }; }),
                inventory: Array.from(inventoryList.children).map(item => ({ name: item.querySelector('input[type=text]').value, desc: item.querySelector('textarea').value, dmg: item.querySelectorAll('input[type=text]')[1] ? item.querySelectorAll('input[type=text]')[1].value : '', crit: item.querySelectorAll('input[type=text]')[2] ? item.querySelectorAll('input[type=text]')[2].value : '' })),
                runes: Array.from(runesList.children).map(item => ({ element: item.querySelectorAll('select')[0].value, sigil: item.querySelectorAll('select')[1].value, stacks: item.querySelector('input').value })),
                rituals: Array.from(ritualsList.children).map(item => ({ name: item.querySelectorAll('input[type=text]')[0].value, layer: item.querySelector('select').value, uses: item.querySelector('input[type=number]').value, desc: item.querySelector('textarea').value })),
                lifeRolled: document.body.dataset.lifeRolled === 'true',
                stage2: { name: getEl('stage2-name').value, benefit: getEl('stage2-benefit').value },
                stage3: { name: getEl('stage3-name').value, ability: getEl('stage3-ability').value },
                stage4: { name: getEl('stage4-name').value, effect: getEl('stage4-effect').value },
                notes: notesTextArea.value,
                goals: goalsTextArea.value
            };
            allCharacterSheets[sheetName] = data;
            localStorage.setItem('draemoraCharacterSheets', JSON.stringify(allCharacterSheets));
            currentLoadedSheetName = sheetName;
            localStorage.setItem('lastLoadedSheet', sheetName); // Save last loaded sheet
            displayMessageBox(`Ficha "${sheetName}" salva com sucesso!`);
        }

        function saveCurrentSheet() {
            if (currentLoadedSheetName) {
                saveCurrentSheetData(currentLoadedSheetName);
            } else {
                saveDataPrompt(); // If no sheet is loaded, prompt for a new name
            }
        }

        function clearAllSheetFields() {
            getEl('avatar-preview').src = 'https://placehold.co/128x192/0D1B2A/E0E1DD?text=Avatar';
            
            document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                input.value = '';
            });

            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            getEl('armor-type').value = 'nenhuma';
            getEl('shield-type').value = 'nenhum';

            const attrs = ['cor', 'for', 'des', 'men', 'alm', 'car'];
            attrs.forEach(attr => getEl(`attr-${attr}`).value = 0);

            statusMaxVida.value = 0;
            statusCurrentVida.value = 0;
            getEl('status-def').value = 0;
            getEl('status-rf').value = 0;
            getEl('status-rm').value = 0;
            getEl('deaths').value = 0;

            inventoryList.innerHTML = '';
            runesList.innerHTML = '';
            ritualsList.innerHTML = '';

            SKILLS.forEach(skill => {
                const id = `skill-${skill.toLowerCase().replace(/[\s\/]/g, '-')}`;
                const checkbox = getEl(id);
                const levelInput = getEl(`${id}-level`);
                if (checkbox) checkbox.checked = false;
                if (levelInput) levelInput.value = 0;
            });

            classDescriptionContainer.innerHTML = '';
            classDescriptionContainer.classList.add('hidden');
            raceDescriptionContainer.innerHTML = '';
            raceDescriptionContainer.classList.add('hidden');
            raceChoicesContainer.innerHTML = '';
            raceChoicesContainer.classList.add('hidden');

            document.body.dataset.lifeRolled = 'false';
            lifeRollContainer.classList.add('hidden');
            lifeRollResult.innerHTML = '';
            
            getEl('dracma-b').value = 1;
            getEl('dracma-p').value = 1;
            getEl('dracma-o').value = 1;
            getEl('dracma-d').value = 1;
            handleDracmaConversion();

            initDropdown(classSelect, CLASSES);
            initDropdown(raceSelect, RACE_DATA);
            initSkills();
            raceApexesContainer.innerHTML = '';
            classApexesContainer.innerHTML = '';
            createApexes(raceApexesContainer, 'race-apex', 4);
            createApexes(classApexesContainer, 'class-apex', 4);
            updateAllStats();
            currentLoadedSheetName = null;
            localStorage.removeItem('lastLoadedSheet');
        }


        function resetData() {
            const messageBoxId = 'confirm-reset-box';
            let confirmBox = document.getElementById(messageBoxId);

            if (!confirmBox) {
                confirmBox = document.createElement('div');
                confirmBox.id = messageBoxId;
                confirmBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
                confirmBox.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                        <p class="text-white text-lg mb-4">Tem certeza que deseja reiniciar a ficha? Todos os dados atuais ser√£o perdidos, mas as fichas salvas permanecer√£o.</p>
                        <div class="flex justify-center gap-4">
                            <button class="btn-danger py-2 px-4 rounded-lg" id="confirm-reset-yes">Sim, Reiniciar</button>
                            <button class="btn-primary py-2 px-4 rounded-lg" onclick="document.getElementById('${messageBoxId}').remove()">Cancelar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                getEl('confirm-reset-yes').addEventListener('click', () => {
                    document.body.removeChild(confirmBox); // Close the confirmation box
                    clearAllSheetFields();
                    displayMessageBox('Ficha reiniciada com sucesso!');
                });
            } else {
                confirmBox.querySelector('p').textContent = `Tem certeza que deseja reiniciar a ficha? Todos os dados atuais ser√£o perdidos, mas as fichas salvas permanecer√£o.`;
                confirmBox.style.display = 'flex';
            }
        }

        async function generateCharacterBackground() {
            const charName = charNameInput.value;
            const charRace = raceSelect.value;
            const charClass = classSelect.value;
            const charDevotion = charDevotionInput.value;

            if (!charName || !charRace || !charClass) {
                displayMessageBox("Por favor, preencha o Nome, Ra√ßa e Classe do personagem para gerar um hist√≥rico.");
                return;
            }

            generateBackgroundText.textContent = "Gerando...";
            generateBackgroundSpinner.classList.remove('hidden');
            generateBackgroundBtn.disabled = true;

            const prompt = `Crie um hist√≥rico de personagem de RPG detalhado para um personagem chamado ${charName}, da ra√ßa ${charRace} e da classe ${charClass}. Se a devo√ß√£o for "${charDevotion}", inclua-a no hist√≥rico. O hist√≥rico deve ser imersivo, com elementos de drama, motiva√ß√£o e como o personagem chegou ao seu ponto atual no mundo de fantasia. Deve ter entre 200 e 300 palavras.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave as-is for Canvas to provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    charPersonalBackground.value = generatedText;
                } else {
                    displayMessageBox("N√£o foi poss√≠vel gerar um hist√≥rico. Tente novamente.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                displayMessageBox("Ocorreu um erro ao conectar-se com o servi√ßo de gera√ß√£o de hist√≥rico. Verifique sua conex√£o ou tente novamente mais tarde.");
            } finally {
                generateBackgroundText.textContent = "Gerar Hist√≥rico ‚ú®";
                generateBackgroundSpinner.classList.add('hidden');
                generateBackgroundBtn.disabled = false;
            }
        }

        async function generateGoalIdeas() {
            const charName = charNameInput.value;
            const charRace = raceSelect.value;
            const charClass = classSelect.value;
            const currentGoals = goalsTextArea.value;
            const charDevotion = charDevotionInput.value;
            const personalBackground = charPersonalBackground.value;

            if (!charName || !charRace || !charClass) {
                displayMessageBox("Por favor, preencha o Nome, Ra√ßa e Classe do personagem para gerar ideias de objetivos.");
                return;
            }

            generateGoalsText.textContent = "Gerando...";
            generateGoalsSpinner.classList.remove('hidden');
            generateGoalsBtn.disabled = true;

            let prompt = `Com base no personagem a seguir, gere 3-5 ideias de objetivos de RPG que sejam interessantes e que possam impulsionar a narrativa. Os objetivos devem ser curtos e diretos, focando em miss√µes ou aspira√ß√µes que o personagem possa ter.`;
            prompt += `\n\nNome: ${charName}\nRa√ßa: ${charRace}\nClasse: ${charClass}`;
            if (charDevotion) prompt += `\nDevo√ß√£o: ${charDevotion}`;
            if (personalBackground) prompt += `\nHist√≥rico Pessoal: ${personalBackground}`;
            if (currentGoals) prompt += `\nObjetivos Atuais: ${currentGoals}`;
            prompt += `\n\nFormato da resposta: Uma lista numerada de objetivos.`;


            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave as-is for Canvas to provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    goalsTextArea.value += (goalsTextArea.value ? "\n\n--- Novas Ideias ---\n" : "") + generatedText;
                } else {
                    displayMessageBox("N√£o foi poss√≠vel gerar ideias de objetivos. Tente novamente.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini para objetivos:", error);
                displayMessageBox("Ocorreu um erro ao conectar-se com o servi√ßo de gera√ß√£o de objetivos. Verifique sua conex√£o ou tente novamente mais tarde.");
            } finally {
                generateGoalsText.textContent = "Gerar Ideias de Objetivos ‚ú®";
                generateGoalsSpinner.classList.add('hidden');
                generateGoalsBtn.disabled = false;
            }
        }


        function exportPDF() {  
            const sheet = document.getElementById('character-sheet');
            const charName = charNameInput.value || 'personagem_draemora';
            const options = { margin: 0.5, filename: `${charName.replace(/\s+/g, '_').toLowerCase()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, backgroundColor: '#0D1B2A' }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(sheet).set(options).save();
           }

        // --- EVENT LISTENERS ---
        getEl('avatar-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => getEl('avatar-preview').src = e.target.result;
                reader.readAsDataURL(file);
            }
        });
        classSelect.addEventListener('change', handleClassSelection);
        raceSelect.addEventListener('change', handleRaceSelection);
        ['armor-type', 'shield-type', 'deaths'].forEach(id => getEl(id).addEventListener('change', updateAllStats));
        ['dracma-b', 'dracma-p', 'dracma-o', 'dracma-d'].forEach(id => getEl(id).addEventListener('input', handleDracmaConversion));
        rollLifeBtn.addEventListener('click', rollLife);
        
        saveCurrentButton.addEventListener('click', saveCurrentSheet); // New event listener for "Salvar Ficha Atual"
        saveAsButton.addEventListener('click', saveDataPrompt);        // Renamed event listener for "Salvar Ficha (Como)"

        getEl('pdf-button').addEventListener('click', exportPDF);
        getEl('reset-button').addEventListener('click', resetData);
        getEl('add-inventory-item').addEventListener('click', addInventoryItem);
        getEl('add-rune-item').addEventListener('click', addRune);
        getEl('add-ritual-item').addEventListener('click', addRitual);
        generateBackgroundBtn.addEventListener('click', generateCharacterBackground);
        generateGoalsBtn.addEventListener('click', generateGoalIdeas);

        // Event listener for current life input
        statusCurrentVida.addEventListener('input', handleCurrentVidaChange);
        
        // Event listener for theme toggle
        themeToggleButton.addEventListener('click', toggleTheme);

        // Event listeners for manage sheets modal
        manageSheetsButton.addEventListener('click', () => {
            displaySavedSheets();
            manageSheetsModal.classList.remove('hidden');
        });
        closeManageSheetsModal.addEventListener('click', () => {
            manageSheetsModal.classList.add('hidden');
        });

        // Delegated event listener for load/delete buttons inside the modal
        savedSheetsList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                const sheetName = button.dataset.sheetName;
                const action = button.dataset.action;
                if (action === 'load') {
                    loadSheet(sheetName);
                } else if (action === 'delete') {
                    deleteSheet(sheetName);
                }
            }
        });

        
        // --- INITIALIZATION ---
        // Load all sheets and apply theme on startup
        loadAllSheetsFromLocalStorage();
        const savedTheme = localStorage.getItem('draemoraTheme') || 'dark';
        applyTheme(savedTheme);

        // Load the last loaded sheet, or a blank one if none selected/available
        const lastLoaded = localStorage.getItem('lastLoadedSheet');
        if (lastLoaded && allCharacterSheets[lastLoaded]) {
            loadSheet(lastLoaded);
        } else if (Object.keys(allCharacterSheets).length > 0) {
            // If no specific last loaded, load the first available sheet
            loadSheet(Object.keys(allCharacterSheets)[0]);
        } else {
            // Otherwise, initialize a fresh sheet
            initDropdown(classSelect, CLASSES);
            initDropdown(raceSelect, RACE_DATA);
            initSkills();
            createApexes(raceApexesContainer, 'race-apex', 4);
            createApexes(classApexesContainer, 'class-apex', 4);
            clearAllSheetFields(); // Ensures a completely fresh start
        }
    });
    </script>
</body>
</html>
