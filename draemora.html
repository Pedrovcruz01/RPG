<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem - Draemora RPG</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Uncial+Antiqua&display=swap" rel="stylesheet">
    
    <!-- Font Awesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Biblioteca html2pdf para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Estilos customizados e fontes */
        :root {
            --bg-color: #0a0a0a;
            --text-color: #E0E1DD;
            --card-bg-color: rgba(27, 38, 59, 0.8);
            --card-border-color: #415A77;
            --input-bg-color: #1B263B;
            --input-border-color: #415A77;
            --primary-btn-bg: #0077B6;
            --primary-btn-hover-bg: #0096C7;
            --secondary-btn-bg: #FFB703;
            --secondary-btn-hover-bg: #FFC300;
            --secondary-btn-text: #1B263B;
            --danger-btn-bg: #b71c1c;
            --danger-btn-hover-bg: #d32f2f;
            --yellow-accent: #FFC300;
            --yellow-text-main: #FFC300; /* Used for font-runic text, original yellow */
            
            /* RGB values for rgba backgrounds, if needed for transparency */
            --red-strong-rgb: 183, 28, 28; /* #b71c1c */
            --blue-strong-rgb: 25, 118, 210; /* #1976D2 */
            --green-strong-rgb: 56, 142, 60; /* #388E3C */
            --purple-strong-rgb: 142, 36, 170; /* #8E24AA */
            --gray-strong-rgb: 27, 38, 59; /* For dark theme gray backgrounds */

            --red-text-color: #FF7777; /* Default light red for text */
            --blue-text-color: #77B6FF; /* Default light blue for text */
            --green-text-color: #77FF77; /* Default light green for text */
            --purple-text-color: #DDAAFF; /* Default light purple for text */

            --skill-checkbox-bg: #4b5563; /* Tailwind gray-700 */
            --skill-checkbox-border: #4b5563; /* Tailwind gray-600 */
            --skill-checkbox-checked: #9333ea; /* Tailwind purple-600 */
        }

        body.light-theme {
            --bg-color: #FFFFFF; /* White */
            --text-color: #1B263B; /* Dark blue/almost black */
            --card-bg-color: rgba(189, 212, 231, 0.8); /* Light blue from instructions */
            --card-border-color: #778DA9; /* Medium blue */
            --input-bg-color: #E0E1DD; /* Lighter grey-blue */
            --input-border-color: #778DA9;
            --primary-btn-bg: #0077B6; /* Keep primary blue */
            --primary-btn-hover-bg: #0096C7;
            --secondary-btn-bg: #FFD700; /* Yellow */
            --secondary-btn-hover-bg: #FFC300;
            --secondary-btn-text: #1B263B;
            --danger-btn-bg: #d32f2f;
            --danger-btn-hover-bg: #e57373;
            --yellow-accent: #FFC300; /* Accent yellow */
            --yellow-text-main: #DAA520; /* Darker yellow for contrast */
            
            /* Light theme specific RGBs for rgba backgrounds */
            --red-strong-rgb: 183, 28, 28; /* Same as dark for strong colors */
            --blue-strong-rgb: 25, 118, 210;
            --green-strong-rgb: 56, 142, 60;
            --purple-strong-rgb: 142, 36, 170;
            --gray-strong-rgb: 189, 212, 231; /* Use light blue for light theme gray */

            --red-text-color: #B71C1C; /* Darker red */
            --blue-text-color: #1976D2; /* Darker blue */
            --green-text-color: #388E3C; /* Darker green */
            --purple-text-color: #8E24AA; /* Darker purple */

            --skill-checkbox-bg: #E0E1DD;
            --skill-checkbox-border: #A0A0A0;
            --skill-checkbox-checked: #0077B6; /* Primary blue for checked */
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0a0a0a; /* Azul escuro */
            color: #E0E1DD; /* Quase branco */
        }
        .font-runic {
            font-family: 'Uncial Antiqua', cursive;
        }
        .card {
            background-color: rgba(27, 38, 59, 0.8); /* Azul um pouco mais claro */
            border: 1px solid #415A77; /* Azul médio */
            border-radius: 0.75rem;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .input-base, .select-base, .textarea-base {
            background-color: #1B263B; /* Azul mais escuro para inputs */
            border: 1px solid #415A77;
            color: #E0E1DD;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .input-base:focus, .select-base:focus, .textarea-base:focus {
            outline: none;
            border-color: #FFC300; /* Amarelo para foco */
            box-shadow: 0 0 0 3px rgba(255, 195, 0, 0.3);
        }
        .btn-primary {
            background-color: var(--primary-btn-bg);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-btn-hover-bg);
        }
        .btn-secondary {
            background-color: var(--secondary-btn-bg);
            color: var(--secondary-btn-text);
        }
        .btn-secondary:hover {
            background-color: var(--secondary-btn-hover-bg);
        }
        .btn-danger {
            background-color: var(--danger-btn-bg);
            color: white;
        }
        .btn-danger:hover {
            background-color: var(--danger-btn-hover-bg);
        }

        /* Adjusting specific rgba backgrounds to use variables */
        .bg-red-900\/50 {
            background-color: rgba(var(--red-strong-rgb), 0.5);
        }
        .bg-blue-900\/50 {
            background-color: rgba(var(--blue-strong-rgb), 0.5);
        }
        .bg-green-900\/50 {
            background-color: rgba(var(--green-strong-rgb), 0.5);
        }
        .bg-purple-900\/50 {
            background-color: rgba(var(--purple-strong-rgb), 0.5);
        }
        .bg-gray-900\/50 { /* This refers to the dracma-details box and similar */
            background-color: rgba(var(--gray-strong-rgb), 0.5);
        }
        .bg-black\/30 { /* This refers to the deaths counter */
            background-color: rgba(0,0,0,0.3); /* Keep black opacity */
        }

        .text-red-300 { color: var(--red-text-color); }
        .text-blue-300 { color: var(--blue-text-color); }
        .text-green-300 { color: var(--green-text-color); }
        .text-purple-300 { color: var(--purple-text-color); }
        .text-yellow-400 { color: var(--yellow-text-main); } 

        .choice-box {
            background-color: var(--card-bg-color); /* Use card background for choices */
            border-color: var(--card-border-color); /* Use card border for choices */
        }
        .choice-box input:checked + label {
            color: var(--primary-btn-bg); /* Highlight checked choices */
        }

        /* Skill checkboxes */
        .form-checkbox {
            background-color: var(--skill-checkbox-bg);
            border-color: var(--skill-checkbox-border);
        }
        .form-checkbox:checked {
            color: var(--skill-checkbox-checked);
            border-color: var(--skill-checkbox-checked);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--yellow-accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dice Animation Styles */
        .dice-overlay-result {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column; /* Allows stacking dice container and result box */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            gap: 30px; /* Space between dice animation and result box */
        }

        .dice-overlay-result.show {
            opacity: 1;
            visibility: visible;
        }

        .dice-animation-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px; /* Space between individual dice */
            height: 150px; /* Allocate space for dice to fall */
            margin-bottom: 20px; /* Space above result box */
        }

        .animated-die {
            position: relative;
            width: 80px;
            height: 80px;
            background-color: #f0f0f0;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Uncial Antiqua', cursive;
            font-size: 3rem;
            font-weight: bold;
            color: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            /* Initial state for falling - off screen */
            transform: translateY(-200px) rotateX(0deg) rotateY(0deg);
            opacity: 0;
        }

        .animated-die.start-roll {
            animation: die-fall 1.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; /* Accelerate then bounce */
            animation-timing-function: cubic-bezier(0.2, 0.8, 0.2, 1.2); /* More natural fall */
            animation-fill-mode: forwards;
            opacity: 1;
        }

        /* Keyframes for the falling and rotating dice */
        @keyframes die-fall {
            0% { transform: translateY(-300px) rotateX(0deg) rotateY(0deg) rotateZ(0deg); opacity: 0; }
            30% { opacity: 1; } /* Fade in during fall */
            80% { transform: translateY(0px) rotateX(720deg) rotateY(720deg) rotateZ(720deg); }
            100% { transform: translateY(0px) rotateX(720deg) rotateY(720deg) rotateZ(720deg); opacity: 1; } /* End at a settled state */
        }

        .animated-die.show-final-value {
            animation: none; /* Stop any previous animations */
            transform: none; /* Reset transforms for static display */
            opacity: 1;
            background-color: var(--secondary-btn-bg); /* Highlight result */
            color: var(--secondary-btn-text);
            box-shadow: 0 0 20px var(--yellow-accent);
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease; /* Smooth transition to final state */
        }

        /* Result Box for messages */
        .result-box {
            background-color: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transform: translateY(50px); /* Start below and slide up */
            opacity: 0;
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* Style for custom message box animation */
        #custom-message-box {
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Estilo para o botão do olho */
        .info-eye-button {
            background: none;
            border: none;
            color: var(--yellow-accent); /* Cor do olho */
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
            padding: 0;
            transition: color 0.2s ease;
        }
        .info-eye-button:hover {
            color: var(--primary-btn-bg); /* Mudar cor ao passar o mouse */
        }
        /* Estilo para o modal de descrição */
        #description-modal {
            animation: fadeIn 0.3s forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 md:p-8 relative" data-life-rolled="false">

    <div id="character-sheet" class="max-w-7xl mx-auto space-y-6">

        <!-- CABEÇALHO -->
        <header class="card p-4 flex flex-col md:flex-row items-start gap-6">
            <div class="relative group flex-shrink-0">
                <input type="file" id="avatar-upload" class="hidden" accept="image/*">
                <img id="avatar-preview" src="https://placehold.co/128x192/0D1B2A/E0E1DD?text=Avatar" alt="Avatar do Personagem" class="w-32 h-48 object-cover border-4 border-yellow-500 cursor-pointer group-hover:border-yellow-300 transition-all duration-300 rounded-lg">
                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 cursor-pointer" onclick="document.getElementById('avatar-upload').click();">
                    <i class="fas fa-camera text-2xl"></i>
                </div>
            </div>
            <div class="flex-1 w-full">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-3">
                        <label for="char-name" class="font-runic text-lg text-yellow-400">Nome do Personagem</label>
                        <input type="text" id="char-name" class="input-base w-full p-2 text-2xl" placeholder="Nome do Personagem">
                    </div>
                    <div>
                        <label for="char-class" class="font-runic text-yellow-400">Classe</label>
                        <select id="char-class" class="select-base w-full p-2">
                            <!-- Opções de Classe inseridas via JS -->
                        </select>
                    </div>
                    <div>
                        <label for="char-race" class="font-runic text-yellow-400">Raça</label>
                        <select id="char-race" class="select-base w-full p-2">
                            <!-- Opções de Raça inseridas via JS -->
                        </select>
                    </div>
                    <div>
                        <label for="char-devotion" class="font-runic text-yellow-400">Devoção</label>
                        <input type="text" id="char-devotion" class="input-base w-full p-2" placeholder="Devoção">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div id="class-description-container" class="hidden">
                        <!-- Descrição da classe será inserida aqui -->
                    </div>
                    <div id="race-description-container" class="hidden">
                        <!-- Descrição da raça será inserida aqui -->
                    </div>
                </div>
            </div>
        </header>

        <!-- CORPO PRINCIPAL -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUNA ESQUERDA -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- ATRIBUTOS E STATUS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ATRIBUTOS -->
                    <div class="card p-4">
                        <h2 class="font-runic text-2xl text-center text-yellow-400 mb-4">Atributos</h2>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="flex flex-col items-center">
                                <label for="attr-cor" class="font-runic text-lg">COR</label>
                                <input type="number" id="attr-cor" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-for" class="font-runic text-lg">FOR</label>
                                <input type="number" id="attr-for" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-des" class="font-runic text-lg">DES</label>
                                <input type="number" id="attr-des" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-men" class="font-runic text-lg">MEN</label>
                                <input type="number" id="attr-men" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-alm" class="font-runic text-lg">ALM</label>
                                <input type="number" id="attr-alm" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="flex flex-col items-center">
                                <label for="attr-car" class="font-runic text-lg">CAR</label>
                                <input type="number" id="attr-car" class="input-base w-20 p-2 text-2xl text-center" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <!-- STATUS BASE -->
                    <div class="card p-4">
                        <h2 class="font-runic text-2xl text-center text-yellow-400 mb-4">Status</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-900/50 p-3 rounded-lg text-center">
                                <label for="status-max-vida" class="font-runic text-lg text-red-300">Vida Máxima</label>
                                <input type="number" id="status-max-vida" class="input-base w-full p-2 text-2xl text-center" value="0" >
                            </div>
                            <div class="bg-red-900/50 p-3 rounded-lg text-center">
                                <label for="status-current-vida" class="font-runic text-lg text-red-300">Vida Atual</label>
                                <input type="number" id="status-current-vida" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="bg-blue-900/50 p-3 rounded-lg text-center">
                                <label for="status-def" class="font-runic text-lg text-blue-300">DEF</label>
                                <input type="number" id="status-def" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="bg-green-900/50 p-3 rounded-lg text-center">
                                <label for="status-rf" class="font-runic text-lg text-green-300">R.F</label>
                                <input type="number" id="status-rf" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                            <div class="bg-purple-900/50 p-3 rounded-lg text-center">
                                <label for="status-rm" class="font-runic text-lg text-purple-300">R.M</label>
                                <input type="number" id="status-rm" class="input-base w-full p-2 text-2xl text-center" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOTÃO DE ROLAGEM DE VIDA -->
                <div id="life-roll-container" class="hidden card p-4 text-center">
                    <button id="roll-life-btn" class="btn-secondary font-bold text-lg py-3 px-6 rounded-lg w-full">🎲 Rolar Vida</button>
                    <div id="life-roll-result" class="mt-4 text-white"></div>
                </div>

                <!-- CONTAINER GENÉRICO PARA ESCOLHAS DE RAÇA -->
                <div id="race-choices-container" class="hidden card p-4 space-y-4">
                    <!-- Conteúdo dinâmico será injetado aqui -->
                </div>

                <!-- PERÍCIAS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Perícias</h2>
                    <div id="skills-list" class="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                        <!-- Perícias serão inseridas aqui via JS -->
                    </div>
                </div>

                <!-- ÁPICES -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Ápices</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300 mb-2">Ápice de Raça</h3>
                            <div id="race-apexes" class="space-y-2"></div>
                        </div>
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300 mb-2">Ápice de Classe</h3>
                            <div id="class-apexes" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <!-- CARACTERÍSTICAS E HISTÓRICO -->
                    <div class="card p-4">
                     <h2 class="font-runic text-2xl text-yellow-400 mb-4">Características e Histórico</h2>
                     <div class="space-y-4">
                         <textarea id="char-personal-background" class="textarea-base w-full p-2 h-32" placeholder="Histórico Pessoal..."></textarea>
                         <button id="generate-background-btn" class="btn-primary w-full p-2 rounded-lg mt-2 flex items-center justify-center gap-2">
                             <span id="generate-background-text">Gerar Histórico ✨</span>
                             <div id="generate-background-spinner" class="spinner hidden"></div>
                         </button>
                         <textarea id="char-race-features" class="textarea-base w-full p-2 h-24" placeholder="Características de Raça..."></textarea>
                         <textarea id="char-class-features" class="textarea-base w-full p-2 h-24" placeholder="Características de Classe..."></textarea>
                         <textarea id="char-talents" class="textarea-base w-full p-2 h-24" placeholder="Talentos e Máculas de Raça..."></textarea>
                         <textarea id="char-apex-text" class="textarea-base w-full p-2 h-24" placeholder="Texto do Ápice de Classe..."></textarea>
                     </div>
                 </div>

                    <!-- ESTÁGIOS AVANÇADOS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Estágios Avançados</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300">Estágio 2 – Subclasse</h3>
                            <input type="text" id="stage2-name" class="input-base w-full p-2 mb-1" placeholder="Nome da Subclasse">
                            <textarea id="stage2-benefit" class="textarea-base w-full p-2 h-20" placeholder="Benefício..."></textarea>
                        </div>
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300">Estágio 3 – Herança</h3>
                            <input type="text" id="stage3-name" class="input-base w-full p-2 mb-1" placeholder="Nome da Herança">
                            <textarea id="stage3-ability" class="textarea-base w-full p-2 h-20" placeholder="Habilidade Lendária..."></textarea>
                        </div>
                        <div>
                            <h3 class="font-runic text-xl text-yellow-300">Estágio 4 – Ascensão</h3>
                            <input type="text" id="stage4-name" class="input-base w-full p-2 mb-1" placeholder="Nome da Habilidade">
                            <textarea id="stage4-effect" class="textarea-base w-full p-2 h-20" placeholder="Efeito..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DIREITA -->
            <div class="space-y-6">
                
                <!-- DRACMAS E UTILIDADES -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Recursos</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Dracmas -->
                        <div class="flex items-center gap-2">
                            <label for="dracma-b" class="font-bold text-lg" style="color: #cd7f32;">D$B</label>
                            <input type="number" id="dracma-b" class="input-base w-full p-1 text-center" value="1">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="dracma-p" class="font-bold text-lg" style="color: #c0c0c0;">D$P</label>
                            <input type="number" id="dracma-p" class="input-base w-full p-1 text-center" value="1">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="dracma-o" class="font-bold text-lg" style="color: #ffd700;">D$O</label>
                            <input type="number" id="dracma-o" class="input-base w-full p-1 text-center" value="1">
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="dracma-d" class="font-bold text-lg" style="color: #e02c2c;">D$D</label>
                            <input type="number" id="dracma-d" class="input-base w-full p-1 text-center" value="1">
                        </div> 
                    </div>
                    <div id="dracma-details" class="text-xs space-y-1 bg-gray-900/50 p-2 rounded-lg"></div>
                    <div class="col-span-2 space-y-2 mt-4">
                        <select id="armor-type" class="select-base w-full p-2">
                            <option value="nenhuma">Sem Armadura</option>
                            <option value="leve">Leve</option>
                            <option value="media">Média</option>
                            <option value="pesada">Pesada</option>
                        </select>
                        <div id="armor-status-display" class="text-sm mt-1 text-center"></div>
                    </div>
                    <div class="col-span-2 space-y-2 mt-2">
                        <select id="shield-type" class="select-base w-full p-2">
                            <option value="nenhum">Sem Escudo</option>
                            <option value="pequeno">Pequeno</option>
                            <option value="grande">Grande</option>
                        </select>
                        <div id="shield-status-display" class="text-sm mt-1 text-center"></div>
                    </div>
                    <div class="col-span-2 flex items-center gap-2 bg-black/30 p-2 rounded-lg mt-4">
                            <label for="deaths" class="font-runic text-lg text-red-400">Mortes Eminentes</label>
                            <input type="number" id="deaths" class="input-base w-full p-1 text-center" value="0">
                    </div>
                </div>

                <!-- INVENTÁRIO -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Inventário</h2>
                    <div id="inventory-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <!-- Itens do inventário -->
                    </div>
                    <button id="add-inventory-item" class="btn-primary w-full mt-4 p-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
                </div>

                <!-- CONTROLE DE RUNAS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Runas</h2>
                    <div id="runes-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Runas -->
                    </div>
                    <button id="add-rune-item" class="btn-primary w-full mt-4 p-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Runa</button>
                </div>

                <!-- CONTROLE DE RITUAIS -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Rituais</h2>
                    <div id="rituals-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        <!-- Rituais -->
                    </div>
                    <button id="add-ritual-item" class="btn-primary w-full mt-4 p-2 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar Ritual</button>
                </div>
                
                <!-- ANOTAÇÕES -->
                <div class="card p-4">
                    <h2 class="font-runic text-2xl text-yellow-400 mb-4">Anotações e Objetivos</h2>
                    <textarea id="notes" class="textarea-base w-full p-2 h-32" placeholder="Planejamento, anotações da sessão..."></textarea>
                    <textarea id="goals" class="textarea-base w-full p-2 h-32 mt-2" placeholder="Objetivos e focos do personagem..."></textarea>
                    <button id="generate-goals-btn" class="btn-primary w-full p-2 rounded-lg mt-2 flex items-center justify-center gap-2">
                        <span id="generate-goals-text">Gerar Ideias de Objetivos ✨</span>
                        <div id="generate-goals-spinner" class="spinner hidden"></div>
                    </button>
                </div>

            </div>
        </main>
    </div>

    <!-- BOTÕES DE AÇÃO ORGANIZADOS NO RODAPÉ -->
    <footer class="max-w-7xl mx-auto p-4 mt-8 card flex flex-wrap justify-center items-center gap-4">
        <div class="tooltip">
            <button id="save-current-button" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-save"></i>
                <span>Salvar Ficha Atual</span>
            </button>
            <span class="tooltiptext">Salvar as alterações na ficha carregada</span>
        </div>
        <div class="tooltip">
            <button id="save-as-button" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-file-export"></i>
                <span>Salvar Ficha (Como)</span>
            </button>
            <span class="tooltiptext">Salvar a ficha como um novo arquivo</span>
        </div>
        <div class="tooltip">
            <button id="manage-sheets-button" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-folder-open"></i>
                <span>Gerenciar Fichas</span>
            </button>
            <span class="tooltiptext">Ver, carregar ou excluir fichas salvas</span>
        </div>
        <div class="tooltip">
            <button id="pdf-button" class="btn-secondary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-file-pdf"></i>
                <span>Exportar PDF</span>
            </button>
            <span class="tooltiptext">Gerar um PDF da ficha atual</span>
        </div>
        <div class="tooltip">
            <button id="reset-button" class="btn-danger py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-redo-alt"></i>
                <span>Reiniciar Ficha</span>
            </button>
            <span class="tooltiptext">Limpar todos os campos da ficha</span>
        </div>
        <div class="tooltip">
            <button id="theme-toggle" class="btn-primary py-3 px-6 rounded-lg text-lg shadow-lg flex items-center gap-2">
                <i class="fas fa-sun" id="theme-icon"></i>
                <span>Alternar Tema</span>
            </button>
            <span class="tooltiptext">Mudar entre tema claro e escuro</span>
        </div>
    </footer>

    <!-- Modal para Gerenciar Fichas Salvas -->
    <div id="manage-sheets-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-md w-full mx-auto border border-gray-600">
            <h2 class="font-runic text-2xl text-yellow-400 mb-4">Gerenciar Fichas</h2>
            <div id="saved-sheets-list" class="max-h-60 overflow-y-auto space-y-2 mb-4">
                <!-- Fichas salvas serão listadas aqui -->
            </div>
            <button id="close-manage-sheets-modal" class="btn-primary py-2 px-4 rounded-lg mt-4">Fechar</button>
        </div>
    </div>

    <!-- Container para a caixa de mensagem personalizada -->
    <div id="message-box-container"></div>

    <!-- Modal para Descrição de Talentos/Máculas -->
    <div id="description-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000] hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-md w-full mx-auto border border-gray-600">
            <h2 id="description-modal-title" class="font-runic text-2xl text-yellow-400 mb-4"></h2>
            <p id="description-modal-content" class="text-white text-lg mb-4 text-left whitespace-pre-wrap"></p>
            <button class="btn-primary py-2 px-4 rounded-lg" id="close-description-modal">Fechar</button>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELEÇÃO DE ELEMENTOS DO DOM ---
        const getEl = (id) => document.getElementById(id);
        const charNameInput = getEl('char-name');
        const classSelect = getEl('char-class');
        const classDescriptionContainer = getEl('class-description-container');
        const raceSelect = getEl('char-race');
        const raceDescriptionContainer = getEl('race-description-container');
        const charDevotionInput = getEl('char-devotion');
        const raceChoicesContainer = getEl('race-choices-container');
        const skillsList = getEl('skills-list');
        const raceApexesContainer = getEl('race-apexes');
        const classApexesContainer = getEl('class-apexes');
        const inventoryList = getEl('inventory-list');
        const runesList = getEl('runes-list');
        const ritualsList = getEl('rituals-list');
        const lifeRollContainer = getEl('life-roll-container');
        const rollLifeBtn = getEl('roll-life-btn');
        const lifeRollResult = getEl('life-roll-result');
        const charPersonalBackground = getEl('char-personal-background');
        const generateBackgroundBtn = getEl('generate-background-btn');
        const generateBackgroundText = getEl('generate-background-text');
        const generateBackgroundSpinner = getEl('generate-background-spinner');
        const notesTextArea = getEl('notes');
        const goalsTextArea = getEl('goals');
        const generateGoalsBtn = getEl('generate-goals-btn');
        const generateGoalsText = getEl('generate-goals-text');
        const generateGoalsSpinner = getEl('generate-goals-spinner');

        // Novos elementos para Vida e Tema
        const statusMaxVida = getEl('status-max-vida');
        const statusCurrentVida = getEl('status-current-vida');
        const themeToggleButton = getEl('theme-toggle');
        const themeIcon = getEl('theme-icon');
        const manageSheetsButton = getEl('manage-sheets-button');
        const manageSheetsModal = getEl('manage-sheets-modal');
        const savedSheetsList = getEl('saved-sheets-list');
        const closeManageSheetsModal = getEl('close-manage-sheets-modal');
        const saveCurrentButton = getEl('save-current-button'); // New button reference
        const saveAsButton = getEl('save-as-button'); // Renamed button reference

        // Elementos do novo modal de descrição
        const descriptionModal = getEl('description-modal');
        const descriptionModalTitle = getEl('description-modal-title');
        const descriptionModalContent = getEl('description-modal-content');
        const closeDescriptionModalBtn = getEl('close-description-modal');


        // --- DEFINIÇÕES DE DADOS ---
        const HUMAN_TALENTS = ['Adaptável', 'Diplomático', 'Conhecimento Universal', 'Estratégico', 'Aprendizado Acelerado', 'Corajoso', 'Foco Imparável'];
        const HUMAN_MACULAS = ['Desconfiado', 'Curioso em Excesso', 'Imprudente', 'Medroso', 'Dependente de Alianças', 'Inseguro', 'Teimoso', 'Frágil'];
        const VAMPIRE_TALENTS = ['Charme Vampírico', 'Regeneração Sanguínea', 'Transformação em Névoa', 'Velocidade Sobrenatural', 'Imortalidade Sob o Véu', 'Força Devastadora', 'Obra Sobrenatural'];
        const VAMPIRE_MACULAS_OPTIONAL = ['Fraqueza à Luz Solar', 'Vulnerável a Prata', 'Fome incontrolável', 'Controle Ancestral', 'Alvo de Caçadores', 'Alergia ao Alho', 'Sombras do Passado'];
        const DAMPIRO_TALENTS = ['Regeneração Rápida', 'Olhar Hipnótico', 'Visão Noturna Aprimorada', 'Predador Ágil', 'Caçador de Sombras', 'Golpe Vampírico', 'Intuição Sombria'];
        const DAMPIRO_MACULAS = ['Fascinação por Sangue', 'Vulnerabilidade à Luz Solar', 'Conflito Interno', 'Ecos Sombrio', 'Instinto Selvagem', 'Avidez pelo Poder', 'Aversão a Símbolos Sagrados'];
        const LICANTROPO_TALENTS = ['Guardião da Floresta', 'Força Ancestral', 'Sentinela Selvagem', 'Rugido Primordial', 'Transformação Ágil', 'Caminhante Silvestre'];
        const LICANTROPO_MACULAS = ['Marcas da Dor', 'Instinto Predatório', 'Fúria da Natureza', 'Sangue das Feras', 'Vulnerabilidade Espiritual', 'Ligação Lunar']; // Fixed typo Lunas to Lunar
        const MEIO_DEMONIO_TALENTS = ['Chamas Profanas', 'Lâmina Sombria', 'Regeneração Profana', 'Aura de Medo', 'Lados opostos', 'Conjurador Infernal'];
        const MEIO_DEMONIO_MACULAS = [ 'Corrupção Crescente', 'Sede de Poder', 'Vulnerabilidade a Magia Divina', 'Marca do Inferno', 'Sussurros Profanos', 'Instabilidade' ];
        const MEIO_CELESTIAL_TALENTS = [ 'Força Transcendental', 'Visão Sagrada', 'Vontade Inquebrável', 'Guia Luminoso', 'Afinidade com Magia', 'Lâmina de Luz', 'Presença Inspiradora', 'Vínculo Eterno(Cena)' ];
        const MEIO_CELESTIAL_MACULAS = [ 'Deslocado', 'Exaustão Divina', 'Ligação com o Domínio', 'Presença Arrebatadora', 'Fragilidade Humana', 'Sombra do Divino', 'Rejeição Celestial', 'Cicatrizes do Sangue Divino' ];
        const COLOSSO_TALENTS = [ 'Interferência', 'Reator Mágico', 'Reforço Energético', 'Ultima Conjuração', 'Eficiência' ];
        const COLOSSO_MACULAS = [ 'Sobrecarga Instável', 'Interferência Mágica', 'Desconexão do Núcleo', 'Foco Restrito', 'Dependência Energética Crítica' ];
        // Updated Astris talents as per user prompt
        const ASTRIS_TALENTS = [ 'Desejo Cadente', 'Coração de Nebulosa', 'Pulso Estelar', 'Viajor do Vácuo', 'Voz do Abismo Estelar' ];
        const ASTRIS_MACULAS = [ 'Reflexo Cósmico', 'Vazio Corporal', 'Antena Estelar', 'Vulnerabilidade ao Eclipse' ]; // Pulso Estelar removed from Maculas
        const ECLIPTICO_TALENTS = [ 'Caminhante das Extremidades', 'Aura do Crepúsculo', 'Voz do Infinito', 'Bênção e Maldição', 'Reflexo do Caos', 'Asas do falcão de fogo' ];
        const ECLIPTICO_MACULAS = [ 'Instabilidade Existencial', 'Rejeição Cósmica', 'Fragilidade de Duas Naturezas', 'Conflito de Energias', 'Tentação Interna', 'Rejeição Social' ];
        const ZALKHA_TALENTS = [ 'Toque Devorador', 'Forma Assimilada (cena)', 'Língua Predatória', 'Grito Supersônico', 'Sangue Venenoso', 'Glândulas Regenerativas' ];
        const ZALKHA_MACULAS = [ 'Vulnerabilidade ao Fogo', 'Predadores Solitários', 'Ecos da Mudança', 'Metabolismo Instável', 'Faro da Presa' ];
        const MORTALHAS_TALENTS = [ 'Golpe da Dívida Impagável', 'Olhar da Última Noite', 'Garras de Execução (Abutre)', 'Correntes Invisíveis', 'Reforçar o Pacto', 'Rastro Espiritual' ];
        const MORTALHAS_MACULAS = [ 'Fobia Solar', 'Não é bem vindo', 'Fragmentos da Outra Vida', 'Voz da Morte', 'Contrato Infame', 'Rachaduras do Véu' ];
        // Updated Crônidas talents and maculas as per user prompt
        const CRONIDAS_TALENTS = [ 'Salto no Tempo (1 uso por cena)', 'Passo Fora do Tempo (1 uso por cena)', 'Memória Perfeita', 'Reversão Instantânea (1 uso por cena)', 'Intuição Futura (passiva, mas só funciona 1 vez por cena)' ];
        const CRONIDAS_MACULAS = [ 'Corpo Preso no Presente', 'Fluxo Inconstante', 'Ecos Perdidos', 'Paradoxo Crescente', 'Distorção da Realidade' ];
        const ELFO_NEGRO_TALENTS = [ 'Mentor do Pacto', 'Língua de Elfo', 'Sombras Silenciosas', 'Veneno Cultural', 'Olho do Traidor' ];
        const ELFO_NEGRO_MACULAS = [ 'Maldito Pela Luz', 'Rancor Ancestral', 'Vínculo Obsessivo', 'Eco da Promessa Quebrada', 'Sombra do Passado' ];
        
        // Objeto com todas as descrições de Talentos e Máculas
        const TALENT_MACULA_DESCRIPTIONS = {
            'Adaptável': 'Receba +2 em um teste de atributo à sua escolha, uma vez por cena.',
            'Diplomático': 'Ganha +2 em testes de Diplomacia e Enganação, tornando-se mais eficaz em negociações.',
            'Conhecimento Universal': 'Pode aprender uma magia de qualquer Domínio ou um ritual de qualquer Patrono durante a criação do personagem.',
            'Estratégico': 'Ao analisar uma situação por 1 turno, ganha vantagem no próximo teste relacionado a essa ação.',
            'Aprendizado Acelerado': 'Toda vez que cumprir um momento ápice de classe, aprende uma nova perícia.',
            'Corajoso': 'Ganha +3 em testes para resistir a efeitos de medo ou intimidação.',
            'Foco Imparável': 'Uma vez por cena, pode ignorar penalidades em testes de Mente ou Alma por 2 rodadas.',
            'Frágil': 'Recebe +1 de dano de qualquer fonte física.',
            'Desconfiado': 'Sofre -2 em interações sociais com desconhecidos ou novas alianças.',
            'Curioso em Excesso': 'Ao encontrar algo desconhecido, deve fazer um teste de Mente. Se falhar, será compelido a investigar, mesmo em situações perigosas.',
            'Imprudente': 'Sofre -1 em testes de resistência contra armadilhas ou situações perigosas devido à sua tendência de agir sem pensar.',
            'Medroso': 'Em situações de terror extremo, sofre -3 em testes de resistência mental.',
            'Dependente de Alianças': 'Quando sozinho, recebe -1 em todos os testes até formar uma parceria novamente.',
            'Inseguro': 'Após falhar em um teste, sofre -1 em todos os testes até obter um sucesso crítico.',
            'Teimoso': 'Ignora conselhos de aliados e sofre penalidade de -2 em testes sociais relacionados a trabalho em equipe.',
            'Charme Vampírico': 'A habilidade de manipular mentes dá +2 em testes de Persuasão e Enganação.',
            'Regeneração Sanguínea': 'Seus ataques corpo a corpo bem executados recuperam 1d4 de vida, se for crítico recebe 1d12.',
            'Transformação em Névoa': 'Uma vez por cena, transforma-se em névoa para escapar ou se mover furtivamente, ganhando +2 em testes de Furtividade e Reflexos.',
            'Velocidade Sobrenatural': 'Ganha +2 em testes de Reflexos e Destreza em combates.',
            'Imortalidade Sob o Véu': 'Pode sobreviver a ferimentos fatais com um teste de Corpo bem-sucedido, retornando com 1d6 de Vida.',
            'Força Devastadora': 'Em combate corpo a corpo, adiciona +1d6 de dano aos ataques físicos.',
            'Obra Sobrenatural': 'Os rituais da Camada da Luxuria e Runas de sangue recebem vantagem em suas conjurações',
            'Sede de Sangue (Hereditária)': 'Necessita beber sangue regularmente; falhar em saciar essa necessidade causa -2 em todos os testes até se alimentar',
            'Fraqueza à Luz Solar': 'Sob exposição direta à luz solar, sofre 1d6 de dano por rodada.',
            'Vulnerável a Prata': 'Recebe +2 de dano ao ser atingido por armas ou objetos de prata.',
            'Fome incontrolável': 'Em situações de estresse, deve-se realizar um teste de Mente para não atacar o aliado mais próximo.',
            'Controle Ancestral': 'Vampiros mais antigos podem subjugar sua vontade, forçando ações contra sua vontade com um teste resistido.',
            'Alvo de Caçadores': 'Organizações caçam incessantemente vampiros, dificultando viagens e interações sociais.',
            'Alergia ao Alho': 'Estar próximo a alho reduz -1 em todos os testes devido ao desconforto causado.',
            'Sombras do Passado': 'A memória de séculos de vida pesa na mente, causando penalidades em testes de Mente em situações de pressão emocional.',
            'Regeneração Rápida': 'Recupera 1d6 de Vida temporária ao final de cada turno.',
            'Olhar Hipnótico': 'Uma vez por cena, force um inimigo a realizar um teste de Alma (D.A 7+ sua Mente ou Alma) . Se falhar, ele fica desorientado por 1 rodada.',
            'Visão Noturna Aprimorada': 'Ignora penalidades por escuridão e pode detectar presenças ocultas em um raio de 10 metros.',
            'Predador Ágil': 'Recebe +2 em testes de Destreza para Esquivas e manobras acrobáticas.',
            'Caçador de Sombras': 'Ganha vantagem em testes de rastreamento e perseguição durante a noite.',
            'Golpe Vampírico': 'Três vez por combate, pode causar +1d12 de dano adicional em um ataque corpo a corpo.',
            'Intuição Sombria': 'Recebe +2 em testes de Intuição para detectar mentiras ou intenções hostis.',
            'Fascinação por Sangue': 'Diante de ferimentos abertos ou cheiros fortes de sangue, deve passar em um teste de Mente (D.A 10) para não agir de forma impulsiva.',
            'Vulnerabilidade à Luz Solar': 'Embora não queime, sofre -2 em testes físicos durante o dia.',
            'Conflito Interno': 'Em momentos de decisões críticas, deve-se realizar um teste de Alma (D.A 10) para evitar hesitar.',
            'Ecos Sombrio': 'Sussurros de ancestrais vampíricos ocasionalmente interferem em seus pensamentos, impondo -1 em testes de concentração (conjurações estão inclusas).',
            'Instinto Selvagem': 'Em situações de perigo extremo, deve passar em um teste de Mente (D.A 7) para não atacar impulsivamente.',
            'Avidez pelo Poder': 'Tem dificuldade em aceitar ordens de figuras de autoridade, sofrendo -2 em testes de Diplomacia com líderes.',
            'Aversão a Símbolos Sagrados': 'Fica desconfortável próximo a símbolos sagrados, sofrendo -1 em todos os testes enquanto estiver a até 3 metros deles.',
            'Guardião da Floresta': 'Pode invocar raízes ou cipós para imobilizar um inimigo uma vez por cena (teste de Alma contra Destreza do alvo).',
            'Força Ancestral': 'Quando assume a Forma Ancestral, seus ataques corpo a corpo causam +1d8 de dano adicional.',
            'Sentinela Selvagem': 'Pode detectar intrusos ou ameaças naturais num raio de 10 metros, mesmo através de obstáculos.',
            'Rugido Primordial': 'Uma vez por cena, solta um rugido que impõe medo. Inimigos devem passar em um teste de Alma (D.A 7+ seu Corpo), se falharem ficam amedrontados por 1 rodada.',
            'Transformação Ágil': 'Pode alternar entre forma humana e Ancestral sem custo de ação.',
            'Caminhante Silvestre': 'Ignora terreno difícil e recebe +2 em testes de Atletismo e Furtividade em áreas naturais.',
            'Marcas da Dor': 'A transformação Bestial é dolorosa e consome energia. Perde 1d6 de Vida ao assumir essa forma.',
            'Instinto Predatório': 'Deve passar em um teste de Mente para não atacar criaturas feridas ou mais fracas.',
            'Fúria da Natureza': 'Ao ver a natureza sendo destruída, entra em estado de raiva, sofrendo -2 em testes de Mente para manter o controle.',
            'Sangue das Feras': 'Sua aparência selvagem e comportamento instintivo causam -2 em interações sociais com humanos.',
            'Vulnerabilidade Espiritual': 'Magias de proteção contra feras ou espíritos afetam você, impondo -2 em testes de resistência.',
            'Ligação Lunar': 'Em noites de lua cheia, deve passar em um teste de Alma para não se transformar involuntariamente.',
            'Chamas Profanas': 'Conjura uma explosão de fogo infernal, causando 2d10 de dano em área, como ação bônus, o limite é igual a sua Alma ou Mente o que for maior.',
            'Lâmina Sombria': 'Cria uma arma feita de pura escuridão (1d12+Alma/Mente de dano extra) que ignora armaduras Leves, durante (Alma) rodadas.',
            'Regeneração Profana': 'Recupera metade dos pontos de Vida ao eliminar um inimigo.',
            'Aura de Medo': 'Inimigos a até 3 metros devem passar em um teste de Alma (Dificuldade 10+ Sua mente/alma) ou ficam amedrontados (-2 em testes de Carisma, Mente e Alma).',
            'Lados opostos': 'Escolha um talento da raça Humano. Alternativamente você pode escolher rolar ataques físicos com Alma (2d6+Alma).',
            'Conjurador Infernal': 'Sempre que conjurar um ritual com a Coesão o ritual recebe +1 dado de dano ou cura.',
            'Corrupção Crescente': 'A cada uso de magia infernal, sofre -1 em testes sociais até o próximo descanso.',
            'Sede de Poder': 'Deve passar em um teste de Alma (Dificuldade 9) para resistir a pactos fáceis.',
            'Vulnerabilidade a Magia Divina': 'Sofre +2 de dano de fontes sagradas.',
            'Marca do Inferno': 'Sua aparência demoníaca impõe -2 em interações sociais com humanos.',
            'Sussurros Profanos': 'Constantemente ouve vozes demoníacas, impondo -1 em Concentração.',
            'Instabilidade': 'Falhar em rituais pode causar efeitos aleatórios e perigosos.',
            'Força Transcendental': 'Adicione +2 em testes de Força ou Corpo relacionados a ações físicas e atléticas por duas rodadas.',
            'Visão Sagrada': 'Enxerga além do véu mortal, detectando presenças invisíveis ou mágicas em até 9 metros.',
            'Vontade Inquebrável': 'Receba +2 em resistências contra controle mental ou medo, duas vezes por cena.',
            'Guia Luminoso': 'Uma vez por cena, conceda a um aliado próximo +2 em um teste de Alma ou Mente.',
            'Afinidade com Magia': 'Recebe uma Runa Elemental adicional.',
            'Lâmina de Luz': 'Uma vez por cena, o Meio-Celestial pode invocar uma arma luminosa (espada ou lança, por exemplo). Essa arma causa 1d10+6 de dano mágico e ignora 4 de resistência contra seus ataques, Se fizer isso seus ataques passam a serem realizados com Mente + Luta, essa arma pode ser usada (Mente) vezes por cena.',
            'Presença Inspiradora': 'Aliados em um raio de 5 metros recebem +1 em todos os testes relacionados a Alma enquanto estiverem na presença do Meio-Celestial.',
            'Vínculo Eterno(Cena)': 'Escolha um aliado. ambos recuperam +2d4 Vida adicional, durante 2 rodadas.',
            'Deslocado': 'O Meio-Celestial sofre -2 em interações sociais com mortais que o consideram alienígena ou ameaçador.',
            'Exaustão Divina': 'Usar Runas sobrecarregadas causam -1 ponto de Vida adicional por conjuração.',
            'Ligação com o Domínio': 'A conexão com o divino impede o Meio-Celestial de acessar e realizar rituais infernais',
            'Presença Arrebatadora': 'A intensidade de sua presença causa desconforto em aliados, impondo -1 em testes sociais quando tenta liderar,motivar, acalmar um grupo.',
            'Fragilidade Humana': 'Sua mortalidade o torna mais vulnerável a doenças ou venenos, recebendo +1 de dano de fontes não mágicas.',
            'Sombra do Divino': 'Criaturas malignas ou e profanas detectam sua presença a até 15 metros, dificultando a furtividade ou emboscadas.',
            'Rejeição Celestial': 'Você é constantemente atormentado por sonhos ou visões de julgamento divino, sofrendo -1 em testes de Mente para resistir a estresse emocional.',
            'Cicatrizes do Sangue Divino': 'Sempre que sofre um ataque mágico de ritual, o Meio-Celestial recebe +3 de dano adicional, refletindo a tensão entre seu sangue mortal e divino.',
            'Interferência': 'Sempre que uma magia elemental for conjurada dentro de um raio de 10 metros, o Colosso pode provocar uma interferência arcana, impondo desvantagem no teste de conjuração — desde que o elemento conjurado coincida com o elemento do seu Núcleo.',
            'Reator Mágico': 'Ao ser reduzido a menos de 50% de sua Vida, o Núcleo do Colosso entra em Modo de Sobrevivência, regenerando 2 PE por rodada durante 3 rodadas. Após esse período, o Núcleo entra em estado de resfriamento, desabilitando a conjuração de magias por 1 rodada.',
            'Reforço Energético': 'O Colosso pode gastar 2 PE para conceder a si mesmo ou a um aliado adjacente +2 em Defesa ou +1 em testes de resistência por 2 rodadas.',
            'Ultima Conjuração': 'O Colosso pode ativar a runa em seu peito para realizar uma Última Conjuração. Ele pode gastar todos os seus Pontos de Energia (PE) para potencializar essa magia final, adicionando +2 dados de dano para cada 10 PE gastos.',
            'Eficiência': 'Uma vez por dia, o Colosso pode escolher uma Runa para ser conjurada como Ação Bônus.',
            'Sobrecarga Instável': 'Sempre que o Colosso realizar uma magia crítica (12 no teste de conjuração), seu núcleo sofre estresse, causando 1d4 de dano ao próprio Colosso.',
            'Interferência Mágica': 'Em ambientes com magia instável (como zonas corrompidas ou de alta densidade mágica), o Colosso sofre -4 em testes de conjuração e resistência.',
            'Desconexão do Núcleo': 'Se ficar sem recarregar PE por mais de 3 cenas, o Núcleo do colosso começa a quebrar…',
            'Foco Restrito': 'O núcleo do Colosso está tão sintonizado ao seu Elemento Runico que ele sofre desvantagem em resistência contra magias de Elementos Runicos opostos',
            'Dependência Energética Crítica': 'Recuperar PE requer mais esforço. Em vez de recuperar automaticamente ao se conectar a fontes mágicas, o Colosso precisa passar em um teste de Núcleo (dificuldade variável).',
            'Desejo Cadente': 'Uma vez por sessão, ao conjurar uma magia ou realizar um feito grandioso, um aliado próximo pode fazer um pedido ao Astris. O pedido concede: +2 em um teste. Cura de 2d4. Vislumbre do futuro (o mestre pode dar um aviso ou dica extra).',
            'Coração de Nebulosa': 'Você pode brilhar com força e ofuscar todos os inimigos próximos, impondo -2 em testes de ataque por 1 rodada. Se fizer isso, fica visível mesmo através de paredes ou portais por 1 cena.',
            'Pulso Estelar': 'Após ser ferido, você pode liberar uma onda de poeira cósmica. Inimigos a até 3 metros sofrem 1d6 de dano e recuam 1 metro.',
            'Viajor do Vácuo': 'Você ignora terrenos difíceis e pode caminhar em superfícies verticais enquanto sob a luz das estrelas. Em ambientes fechados, tem +2 em Furtividade devido à sua leveza antigravitacional.',
            'Voz do Abismo Estelar': 'Uma vez por cena, pode invocar ecos de uma estrela morta. O alvo deve fazer um teste de Mente (D.A 9) ou ficará paralisado em terror existencial por 1 turno.',
            'Reflexo Cósmico': 'Espelhos, câmeras ou magias de detecção não mostram seu rosto — apenas uma imagem distorcida do cosmos. Isso causa desconfiança (-2 em interações com quem vê isso).',
            'Vazio Corporal': 'Seu corpo não mantém estrutura estável por muito tempo. Em cenas longas, você sofre -1 em testes físicos até descansar.',
            'Antena Estelar': 'Você capta vozes de estrelas mortas — às vezes no meio de uma conversa normal. Role 1d6 ao fazer testes sociais: em resultado 1, sua resposta é incompreensível (mesmo se for genial).',
            'Vulnerabilidade ao Eclipse': 'Durante cenas sob eclipses (ou escuridão total), você sofre -4 em todos os testes até se afastar da zona.',
            'Caminhante das Extremidades': 'Se conjurar Arma Sagrada do Bem e do Mal você pode fazer seus ataques usando Alma ou Mente o que for maior.',
            'Aura do Crepúsculo': 'Uma vez por cena, o Eclíptico cria uma aura de 5 metros que reduz a precisão de ataques inimigos em -2 e concede +1 de Defesa aos aliados na área.',
            'Voz do Infinito': 'A voz do Eclíptico reverbera tanto com a autoridade celestial quanto com a malícia demoníaca, concedendo +2 em testes de Diplomacia ou Intimidação.',
            'Bênção e Maldição': 'Se escolheu Segredos Profanados Pela Luz, suas magias e rituais causam mais 1 dado de dano.',
            'Reflexo do Caos': 'Sempre que o Eclíptico sofre um ataque crítico, ele pode imediatamente contra-atacar, recebendo vantagem em seu ataque.',
            'Asas do falcão de fogo': 'Até duas vezes por cena o Eclíptico pode erguer asas mágicas, podendo assim conseguir voar livremente pelo dobro do seu movimento para cima ou para baixo, podendo também ser usada livremente em uma cena desde que seja narrativo e não mecânico.',
            'Instabilidade Existencial': 'O Eclíptico sofre -2 em testes de Alma sempre que enfrenta situações de estresse emocional extremo.',
            'Rejeição Cósmica': 'Criaturas ligadas aos céus ou inferno frequentemente o percebem como uma ameaça ou aberração, atacando-o ou rejeitando-o automaticamente.',
            'Fragilidade de Duas Naturezas': 'Sempre que o Eclíptico recebe dano mágico de criaturas celestes ou infernais, ele sofre +1d4 de dano adicional, independente da fonte.',
            'Conflito de Energias': 'Usar magias e rituais em uma mesma cena causa -2 em todos os testes até que o Eclíptico realize um descanso.',
            'Tentação Interna': 'O Eclíptico ouve sussurros constantes de suas metades opostas, tentando-o a ceder completamente a uma delas. Em momentos críticos, deve realizar um teste de Mente para resistir ao caos ou à ordem absoluta.',
            'Rejeição Social': 'Humanos e outras raças mortais frequentemente o veem como antinatural, impondo -2 em interações sociais com aqueles que não o conhecem bem.',
            'Toque Devorador': 'Suas escamas secretam ácido ao comando. seus golpes corpo à corpo causam +4 de dano físico (ácido).',
            'Forma Assimilada (cena)': 'Após estudar um alvo por alguns minutos, podem replicar sua aparência e habilidades perfeitamente, a depender da raça-alvo você recebe um talento ou característica hereditária depois de 1 rodada analisando',
            'Língua Predatória': 'Sua língua bifurcada pode se estender até 2 metros e agarrar pequenos objetos ou imobilizar alvos frágeis por um turno.',
            'Grito Supersônico': 'Soltam um rugido em alta frequência que desorienta inimigos em um raio de 5 metros, impondo penalidade em testes de percepção e ataque por 1 rodada.',
            'Sangue Venenoso': 'Se forem feridos em combate corpo a corpo, o agressor sofre 1d8 de dano ácido como reação.',
            'Glândulas Regenerativas': 'Podem regenerar ferimentos rapidamente, restaurando 1d10 de Vida por uma quantidade de rodadas igual a seu Corpo.',
            'Vulnerabilidade ao Fogo': 'Seus corpos são altamente sensíveis a queimaduras. Dano por fogo e calor intenso é dobrado contra eles.',
            'Predadores Solitários': 'Zal\'kha não confiam facilmente e possuem dificuldade em trabalho em equipe, sofrendo -2 em testes sociais que exijam cooperação.',
            'Ecos da Mudança': 'Seu corpo periodicamente se renova, trocando de pele. Durante esse processo, ficam extremamente vulneráveis por algumas horas.',
            'Metabolismo Instável': 'Devido às suas mutações, precisam consumir mais alimento do que o normal. Se passarem muito tempo sem comer, sofrem penalidade em testes físicos.',
            'Faro da Presa': 'São caçadores naturais, mas também possuem instintos que os forçam a reagir agressivamente quando sentem o cheiro de sangue. Precisam fazer um teste de Mente (D.A base 8) para resistir a atacar alvos feridos.',
            'Golpe da Dívida Impagável': 'Se o inimigo possui qualquer pacto, maldição ou vínculo mágico, seus ataques contra ele causam +1d8 de dano adicional.',
            'Olhar da Última Noite': 'Ao derrotar um inimigo, você pode perguntar ao Mestre qual foi o último arrependimento ou dívida não paga dessa criatura.',
            'Garras de Execução (Abutre)': 'Enquanto na forma de abutre, seus ataques com garras causam 1d8 + Força, e podem causar sangramento (1d4/rodada) se o inimigo falhar num teste de Corpo.',
            'Correntes Invisíveis': 'Você pode criar laços espirituais invisíveis. Uma vez por cena, escolha uma criatura até 5m: Ela está “atada” a você: sofre -1 em testes contra você. Se tentar fugir, sofre 1d6 de dano por esforço.',
            'Reforçar o Pacto': 'Uma vez por cena, você pode invocar fragmentos da vontade demoníaca que te mantém de pé. Você rola com vantagem para intimidar, coagir ou ameaçar alguém que tema forças do além.',
            'Rastro Espiritual': 'Rastreia locais, pessoas ou itens que envolvam mentiras, traições ou rompimentos mágicos, mesmo com falsificação ou ilusões.',
            'Fobia Solar': 'Mesmo em forma de abutre, a luz solar causa desconforto profundo. Você sofre -4 em Mente e testes de resistência enquanto estiver sob luz direta.',
            'Não é bem vindo': 'Você não é aceito na maioria dos lugares em que entrar, você apenas pode entrar em lugares em que não há proteções, além disso você sofre - 5 em testes sociais',
            'Fragmentos da Outra Vida': 'Você recebe flashes aleatórios de sua vida anterior. Em cenas tensas, role 1d6. Em 1, você se distrai com a memória, sofrendo -2 no próximo teste.',
            'Voz da Morte': 'Sua voz soa como várias sobrepostas, como se fosse um eco entre mundos. Sempre que fala em voz alta, impõe medo ou desconforto (reação social negativa, a critério do mestre).',
            'Contrato Infame': 'Alguém no mundo sabe que você existe e quer te destruir ou controlar. Essa pessoa (ou entidade) tem influência oculta e pode interferir em momentos críticos (a critério do mestre).',
            'Rachaduras do Véu': 'Você é uma falha na realidade. Magias de cura funcionam apenas com metade da eficácia em você.',
            'Salto no Tempo (1 uso por cena)': 'Os Crônidas podem atrasar ou adiantar sua ação em um turno de combate, agindo antes ou depois de qualquer personagem na ordem da iniciativa.',
            'Passo Fora do Tempo (1 uso por cena)': 'Pode se tornar intangível por 1 rodada, evitando ataques físicos e mágicos enquanto sua consciência desliza entre os instantes. Após usar essa habilidade, sofre -2 em Reflexos até o final da cena.',
            'Memória Perfeita': 'O Crônidas nunca esquece nada. Pode lembrar-se de detalhes precisos de qualquer cena que já viveu, incluindo diálogos e ações. (Uso ilimitado, mas sujeito à interpretação do Mestre.)',
            'Reversão Instantânea (1 uso por cena)': 'Pode desfazer a última ação realizada (dele ou de um aliado), mas sofre -2 em todos os testes na rodada seguinte devido ao desgaste temporal.',
            'Intuição Futura (passiva, mas só funciona 1 vez por cena)': 'Se estiver prestes a cair em uma armadilha ou perigo inesperado, o Cronidas recebe um pressentimento e pode fazer um teste de Mente para evitar a situação antes que aconteça.',
            'Corpo Preso no Presente': 'Sempre que usa uma habilidade temporal, seu corpo fica imóvel e vulnerável a ataques físicos.',
            'Fluxo Inconstante': 'Se usar mais de 2 habilidades temporais na mesma cena, sofre 1d4 de dano devido ao desgaste mental.',
            'Ecos Perdidos': 'Às vezes, o Crônidas não retorna sozinho... criaturas ou memórias do passado/futuro podem persegui-lo, causando penalidades (-2) em testes sociais ou mentais em momentos de tensão.',
            'Paradoxo Crescente': 'Se interferir diretamente em eventos que já vivenciou, pode sofrer um efeito imprevisto, como uma falha automática no próximo teste de Alma. (Cabe ao Mestre definir o impacto dessa interferência.)',
            'Distorção da Realidade': 'Pessoas comuns tendem a desconfiar ou sentir medo dos Cronidas. Sofrem -4 em testes sociais com NPCs que não conhecem sua verdadeira natureza.',
            'Mentor do Pacto': 'Você é capaz de compartilhar o bônus de uma perícia sua com um aliado de juramento caso ele não possua essa perícia',
            'Língua de Elfo': '+2 em testes de Persuasão e Manipulação com qualquer criatura além de conseguir se comunicar em dialetos antigos inerentes ao seu.',
            'Sombras Silenciosas': 'Pode se mover sem ser detectado em qualquer escuridão (mágica ou não) por 1 rodada, 1x por cena.',
            'Veneno Cultural': 'Pode aplicar veneno em armas com uma ação de movimento. O primeiro ataque causa +1d6 de dano e -1 em testes do alvo.',
            'Olho do Traidor': 'Uma vez por cena, pode detectar se um aliado está escondendo intenções contrárias a você ou ao seu grupo.',
            'Maldito Pela Luz': 'Em luz solar direta, sofre -1 em todos os testes de Mente e Alma, “mas porque?”.',
            'Rancor Ancestral': 'Sofre -2 em testes sociais com Elfos de outras linhagens. Eles o sentem como uma aberração, “existem outros de nós?”.',
            'Vínculo Obsessivo': 'Se o aliado pactuado for ferido ou desonrado, o Elfo Negro sofre -4 em todos os testes até confrontar a causa disso.',
            'Eco da Promessa Quebrada': 'Sempre que um pacto for rompido, o Elfo tem pesadelos recorrentes. Sofre -5 em Percepção no dia seguinte.',
            'Sombra do Passado': 'Um antigo pacto selado no passado volta a assombrar o Elfo — com um NPC, entidade ou mestre do mundo que deseja cobrá-lo, “eu não lembro de você”.'
        };


        const rollDiceExpression = (expression) => {
            if (!expression) return { total: 0, rolls: [], modifier: 0 };
            const parts = expression.split('+');
            const [diceCount, diceSides] = parts[0].split('d').map(Number);
            const modifier = Number(parts[1]) || 0;
            
            let rolls = [];
            let total = 0;
            for(let i = 0; i < diceCount; i++) {
                const roll = Math.floor(Math.random() * diceSides) + 1;
                rolls.push(roll);
                total += roll;
            }
            return { total: total + modifier, rolls, modifier };
        };

        const RACES = {
            "Humano": "Versáteis e adaptáveis, os humanos compensam a ausência de talentos sobrenaturais com inteligência, força de vontade e iniciativa. Ganham bônus em perícias ou talentos à escolha.",
            "Vampiro": "Criaturas amaldiçoadas pela sede de sangue. Possuem regeneração sobrenatural, charme hipnótico e resistência à dor, mas são vulneráveis à luz e fogo.",
            "Dampiro": "Nascidos da união entre humanos e vampiros, equilibram força sobrenatural com controle emocional. São ágiles e intuitivos, mas carregam instabilidade interior.",
            "Licantropo": "Bestiais e poderosos, licantropos alternam entre forma humana e lupina. Recebem bônus em combate físico e sentidos aguçados, mas lutam contra a fúria interior.",
            "Meio-Demônio": "Marcados pelo inferno, possuem aparência distorcida e poderes elementais sombrios. Carregam o estigma do caos, mas também uma força aterradora.",
            "Meio-Celestial": "Filhos de entidades divinas. Possuem aura sagrada, talentos de cura e proteção, mas vivem sob constante julgamento moral e pressão ética.",
            "Colosso": "Gigantes entre os mortais, os colossos possuem força descomunal, pele espessa e presença intimidadora. Em troca, são lentos e visados.",
            "Astris": "Seres ligados às estrelas e ao firmamento. Mestres de magia cósmica e presságios, enxergam além do tempo, mas se afastam do mundo terreno.",
            "Eclíptico": "Entidades que vivem entre luz e trevas. Instáveis e perigosas, controlam magia dual e possuem dupla natureza que pode mudar em combate.",
            "Zal’Kha": "Seres reptilianos de alma ancestral, dotados de armaduras naturais, línguas bifurcadas e sentidos térmicos. Exímios caçadores e guardiões.",
            "Mortalhas": "Criaturas feitas de névoa, sombra e lamentos. Imateriais por natureza, são difíceis de ferir, mas não conseguem tocar o mundo físico com facilidade.",
            "Crônidas": "Filhos do tempo, possuem consciência temporal expandida. São capazes de manipular pequenos fragmentos do passado ou prever eventos próximos.",
            "Elfo Negro": "Descendentes das profundezas. Magia, veneno e intriga correm em suas veias. Seus olhos veem no escuro, mas sua alma é perseguida pelas sombras."
        };
        
        const RACE_DATA = {
            'Humano': { status: { lifeDice: '2d6+5', def: 7, rf: 4, rm: 1 }, featuresText: 'Vontade Indomável: Uma vez por cena, podem repetir um teste de resistência mental ou emocional, ignorando penalidades temporárias.\n\nVersatilidade: Podem escolher uma magia/ritual de qualquer domínio/patrono ou um talento adicional na criação do personagem.\n\nEspírito Cooperativo: Recebem +1 em testes para apoiar aliados (em Diplomacia ou em combate).\n\nDeterminação Heróica: Quando reduzidos a menos de 50% de Vida, recebem +1 em todos os testes até o final do combate.', talents: HUMAN_TALENTS, maculas: HUMAN_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Vampiro': { status: { lifeDice: '3d6+7', def: 8, rf: 2, rm: 2 }, featuresText: 'Nosferatu: Uma vez por cena, o vampiro pode atacar um inimigo para sugar seu sangue, recuperando 2d10 de Vida.\n\nForça Sobrenatural: Vampiros possuem força além do humano, recebendo +1 adicional em testes de Força.\n\nSede de Sangue (Hereditária): Todos os vampiros começam com essa mácula. Ao criar um personagem, escolha apenas uma mácula adicional.\n\nLaço Nefasto: O Vampiro recebe 1 símbolo Ritualístico ou recebe 1 Runa Elemental do Sangue.', talents: VAMPIRE_TALENTS, maculas: VAMPIRE_MACULAS_OPTIONAL, choiceLogic: { type: 'vampire' } },
            'Dampiro': { status: { lifeDice: '2d6+4', def: 8, rf: 3, rm: 3 }, featuresText: 'Sangue Híbrido: Dampiro recupera 1d8 de Vida ao consumir pequenas quantidades de sangue, mas não são obrigados a se alimentar regularmente como vampiros.\n\nForça Sobrenatural: Vampiros possuem força além do humano, recebendo +1 adicional em testes de Força.\n\nResiliência Sobrenatural: Recebem +2 em testes de resistência a venenos e doenças, devido à mistura de sangue humano e vampírico.\n\nProle de Nosferatu: O Dampiro pode escolher 2 Talento/Mácula de Humano e 2 Talento/Mácula de Vampiro em alternativa aos seus talentos convencionais. Ou podem escolher receber 2 Símbolos Ritualísticos ou 2 Runas de qualquer Elemento.', choiceLogic: { type: 'dampiro' } },
            'Licantropo': { status: { lifeDice: '4d6+2', def: 5, rf: 5, rm: 0 }, featuresText: 'Fúria Bestial: Uma vez por combate, ganha +2 em todos os testes de Corpo e Força por 2 rodadas.\n\nTransformação Parcial: Pode manifestar garras ou sentidos lupinos, concedendo +1 em Combate ou Percepção.\n\nResistência Ancestral: +2 em testes contra venenos, doenças e efeitos de controle mental.\n\nHerdeiro da Lua: Ao realizar um ritual sob a luz da lua, recebe vantagem automática.', talents: LICANTROPO_TALENTS, maculas: LICANTROPO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Meio-Demônio': { status: { lifeDice: '2d4+10', def: 9, rf: 2, rm: 4 }, featuresText: 'Sangue do Abismo: Pode conjurar uma magia ou ritual da camada “Ira” com +2 de bônus uma vez por cena.\n\nAura Intimidante: Recebe +1 em testes de Intimidação e +1 de dano contra alvos com medo.\n\nChamas Profanas: Pode conjurar um ataque flamejante causando 1d10 de dano extra (1x por combate).\n\nInstinto da Ruína: Recebe vantagem ao identificar fraquezas mágicas e espirituais.', talents: MEIO_DEMONIO_TALENTS, maculas: MEIO_DEMONIO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Meio-Celestial': { status: { lifeDice: '3d6+6', def: 10, rf: 1, rm: 6 }, featuresText: 'Luz Interior: Pode curar 1d6 de Vida em si ou em um aliado próximo uma vez por combate.\n\nBênção Celestial: Concede +2 em testes de Alma e Diplomacia ao lidar com humanos e criaturas benignas.\n\nAsas Etéreas: Pode planar ou evitar quedas com teste de Reflexo.\n\nEscudo de Fé: Concede +1 de R.M adicional enquanto estiver consciente.', talents: MEIO_CELESTIAL_TALENTS, maculas: MEIO_CELESTIAL_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Colosso': { status: { lifeDice: '2d4+8', def: 10, rf: 8, rm: 8 }, featuresText: 'Pele de Pedra: Reduz 2 de qualquer dano físico sofrido.\n\nForça Imparável: Recebe +2 em testes de Força e pode carregar o dobro do peso comum.\n\nPassos de Trovão: Causa 1d6 de dano ao redor ao pular ou cair de alturas.\n\nFirmeza de Rocha: Imune a empurrões, quedas forçadas e efeitos de derrubar.', talents: COLOSSO_TALENTS, maculas: COLOSSO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Astris': { status: { lifeDice: '1d6+12', def: 7, rf: 4, rm: 4 }, featuresText: 'Corpo Estelar: Imune a vácuo, frio e calor extremos.\n\nVoz do Cosmos: Pode se comunicar com seres extraplanares ou pressentir eventos cósmicos.\n\nChamas Negras: Conjura 1 vez por combate uma magia de dano cósmico (1d12 + Alma).\n\nMemória Eterna: Recebe +2 em Ciências, Conhecimentos e Ocultismo.', talents: ASTRIS_TALENTS, maculas: ASTRIS_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Eclíptico': { status: { lifeDice: '3d4+6', def: 7, rf: 6, rm: 6 }, featuresText: 'Fusão de Luz e Trevas: Recebe +1 em testes de Combate e Conjuração quando alterna entre ações ofensivas e defensivas.\n\nRitual da Penumbra: Pode usar rituais tanto de Luz quanto de Sombras com vantagem.\n\nOlhos da Dualidade: Enxerga no escuro absoluto e percebe ilusões com facilidade.\n\nEquilíbrio Interno: Testes de Mente não sofrem penalidades externas.', talents: ECLIPTICO_TALENTS, maculas: ECLIPTICO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Zal’Kha': { status: { lifeDice: '2d8+6', def: 9, rf: 2, rm: 5 }, featuresText: 'Pele de Escamas: Reduz em 1 qualquer dano físico sofrido.\n\nOlhos Penetrantes: Recebe +2 em testes de Intuição e Sentidos Ocultos.\n\nLíngua Venenosa: Uma vez por combate, seu ataque corpo a corpo causa 1d6 de dano venenoso adicional.\n\nRitual de Sangue Antigo: Recebe +1 em conjuração de rituais com elementos naturais (Terra, Vento, Sangue).', talents: ZALKHA_TALENTS, maculas: ZALKHA_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Mortalhas': { status: { lifeDice: '2d8+10', def: 10, rf: 7, rm: 7 }, featuresText: 'Forma Etérea: Pode atravessar barreiras físicas leves uma vez por cena.\n\nToque Fantasmal: Seus ataques ignoram armaduras físicas por 1 rodada (1x por combate).\n\nMemória Fragmentada: Recebe vantagem em testes de Ocultismo e Percepção.\n\nPresença Silenciosa: +2 em Furtividade e +1 em Reflexos ao agir nas sombras.', talents: MORTALHAS_TALENTS, maculas: MORTALHAS_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Crônidas': { status: { lifeDice: '2d6+4', def: 6, rf: 4, rm: 1 }, featuresText: 'Pulso Temporal: Pode repetir um teste de atributo uma vez por dia (reversão temporal).\n\nEco do Futuro: Recebe +1 em testes de Reflexo, Percepção e Intuição.\n\nDistúrbio Cronal: Pode causar lentidão em um inimigo com sucesso crítico em ataque.\n\nDomínio do Tempo: Recebe vantagem em rituais com a camada “Orgulho” ou “Servidão”.', talents: CRONIDAS_TALENTS, maculas: CRONIDAS_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } },
            'Elfo Negro': { status: { lifeDice: '5d4+5', def: 11, rf: 5, rm: 7 }, featuresText: 'Magia Natural: Recebe +1 em conjuração de rituais com Camadas de Luxúria e Inveja.\n\nGraça Sombria: Recebe +2 em testes de Furtividade e Reflexos.\n\nOlhos Noturnos: Pode enxergar na escuridão total sem penalidade.\n\nDom da Enganação: +1 em Enganação e Intimidação em ambientes urbanos.', talents: ELFO_NEGRO_TALENTS, maculas: ELFO_NEGRO_MACULAS, choiceLogic: { type: 'standard', talents: 2, maculas: 2 } }
        };

        const CLASSES = {
            "Lutador": "Especialista em combate físico, o Lutador domina o campo de batalha com força bruta, técnica e resistência. Ideal para enfrentar inimigos de frente e proteger aliados.",
            "Mago": "Usuário de magias arcanas, manipula os elementos e as forças do universo. Frágil fisicamente, mas devastador à distância e essencial em combates prolongados.",
            "Beserker": "Guerreiro selvagem que luta tomado pela fúria. Seus ataques são impulsivos e destrutivos, e quanto mais ferido, mais perigoso se torna.",
            "Sacerdote": "Canaliza o poder de divindades para curar, proteger e punir. Consegue expulsar entidades sombrias e abençoar aliados com fé.",
            "Paladino": "Guerreiro sagrado que une espada e oração. Serve como escudo moral e físico do grupo, combinando ataques justos com habilidades de proteção.",
            "Atirador": "Especialista em combates à distância. Usa armas de fogo, bestas ou arcos com precisão mortal. Possui grande mobilidade e mira certeira.",
            "Bruxo": "Portador de pactos arcanos, o Bruxo canaliza forças obscuras em troca de poder. Suas magias têm efeitos imprevisíveis e perigosos.",
            "Caçador": "Mestre dos ambientes naturais e rastreamento. Usa armadilhas, venenos e companheiros animais para dominar o campo e emboscar inimigos.",
            "Apostador": "Combatente do acaso. Utiliza dados, cartas e truques de sorte como armas. Habilidoso e imprevisível, sempre aposta tudo em cada jogada.",
            "Ilusório": "Manipulador da realidade sensorial. Cria ilusões, distorções e duplicatas que confundem inimigos e protegem aliados sem que percebam.",
            "Necromante": "Controlador da morte. Invoca mortos, absorve energia vital e domina rituais sombrios. Poderoso, mas temido até por aliados.",
            "Poeta das Emoções": "Ser místico que transforma sentimentos em magia. Usa palavras, sons e aura emocional para alterar o campo de batalha de forma inspiradora ou aterradora.",
            "Artesão": "Criador de armas, itens mágicos e engenhocas únicas. Capaz de forjar artefatos em tempo real, melhorar equipamentos e até usar criações em combate.",
            "Aniquilador": "Classe destrutiva e implacável. Foca em eliminar inimigos com máxima brutalidade, usando técnicas impiedosas e habilidades devastadoras.",
            "Mateiro": "Sobrevivente nato. Especializado em emboscadas, rastreamento e terreno hostil. Usa conhecimento do ambiente para dominar qualquer campo de batalha."
        };
        
        const CLASS_DATA = {
            'Lutador': { status: { vida: 10, rf: 2, rm: 2 }, featuresText: 'ESTRATÉGIA DE COMBATE: Vantagem em testes de Força para usar o ambiente ou atacar pontos fracos.\n\nMESTRE DE ARMAS: Usa qualquer arma com maestria, +1 dado de dano corpo a corpo, troca sem penalidade.\n\nRESISTÊNCIA FEROZ: +6 Defesa temporária após sofrer ataque crítico.\n\nMURALHA VIVA: +2 Defesa contra todos os ataques ao ser cercado por 2 ou mais inimigos por 1 rodada.\n\nMAESTRIA: Estágio 1: +5 de dano físico fixo.', apexText: 'DESAFIO: Fazer uma grande demonstração de força física ou perseverança que impacte a narrativa (ex: derrotar inimigo forte, erguer algo monumental etc).\n\nHABILIDADE CARACTERÍSTICA: Uma vez por combate, pode executar um ataque especial que causa 3d8 + FOR de dano. Se eliminar o inimigo, recupera Vida igual a metade do dano causado.' },
            'Mago': { status: { vida: 5, rf: 2, rm: 5 }, featuresText: '→ +1 Runa gratuita na criação\n→ +1 em Conjuração Mágica\n→ +2 em Ocultismo\n→ Pode usar rituais com 1 rodada a menos\n→ Ganha +2 em testes de PENSAMENTO com qualquer elemento', apexText: 'DESAFIO: Ao causar um efeito mágico impactante (ex: paralisar um inimigo poderoso, controlar o ambiente ou evitar uma catástrofe com magia).\n\nHABILIDADE: Uma vez por combate, pode lançar uma magia sem custo de runa e com vantagem dupla no teste de conjuração.' },
            'Beserker': { status: { vida: 15, rf: 2, rm: 1 }, featuresText: '→ +2 em testes de Corpo durante combates\n→ Pode entrar em Fúria por 3 turnos (+2 dano físico, -1 Defesa)\n→ Ao cair abaixo de 25% da Vida, ganha +3 em testes físicos\n→ +1 dado de dano em ataques físicos com armas grandes', apexText: 'DESAFIO: Ao entrar em fúria contra um inimigo maior ou mais forte.\n\nHABILIDADE: Pode ignorar efeitos de dor/penalidade por 2 rodadas e causar +2d12 de dano extra em um ataque.' },
            'Sacerdote': { status: { vida: 8, rf: 3, rm: 6 }, featuresText: '→ Conjura com +1 bônus se for em nome da devoção\n→ Cura aliados com +1d4 adicional\n→ Pode purificar ou banir entidades com ritual em metade do tempo\n→ +2 em testes de Devoção', apexText: 'DESAFIO: Ao curar um aliado em estado crítico ou expulsar um inimigo espiritual relevante.\n\nHABILIDADE: Uma vez por combate, pode realizar uma cura em área (3 alvos) com 2d8 + ALM de Vida.' },
            'Paladino': { status: { vida: 10, rf: 8, rm: 6 }, featuresText: '→ Pode usar magia e ataque corpo a corpo sem penalidades\n→ Reduz em -2 o dano mágico recebido se for em nome de sua devoção\n→ +2 em testes contra corrupção ou possessão\n→ Pode causar +1d6 de dano sagrado 1x por combate', apexText: 'DESAFIO: Ao proteger inocentes de uma grande ameaça, resistindo ao mal com firmeza.\n\nHABILIDADE: Pode ativar um escudo sagrado por 2 turnos (absorve até 20 de dano e cura 1d6 ao final).' },
            'Atirador': { status: { vida: 5, rf: 3, rm: 3 }, featuresText: '→ +2 em Pontaria\n→ Pode disparar duas vezes por rodada (com penalidade de -2 no segundo tiro)\n→ Recebe vantagem ao atacar inimigos em emboscada\n→ +1d6 de dano adicional se estiver em posição elevada', apexText: 'DESAFIO: Ao eliminar um alvo importante com precisão em condições adversas.\n\nHABILIDADE: Pode disparar um “Tiro Certeiro” que ignora cobertura e causa +3d10 de dano.' },
            'Bruxo': { status: { vida: 6, rf: 2, rm: 4 }, featuresText: '→ Pode escolher um Patrono (entidade) que concede +1 em testes relacionados ao domínio escolhido\n→ +2 em Conjuração Ritualística\n→ Ao conjurar com sucesso, pode invocar um efeito adicional uma vez por cena\n→ Ganha +1 Runa ou Símbolo Ritualístico gratuito', apexText: 'DESAFIO: Ao invocar com sucesso um efeito de um patrono que altera o curso da cena ou história.\n\nHABILIDADE: Uma vez por combate, conjura um ritual instantâneo sem teste, escolhendo entre dano, controle ou cura (escolha ao usar).' },
            'Caçador': { status: { vida: 7, rf: 3, rm: 2 }, featuresText: '→ +2 em Sobrevivência e Percepção\n→ Pode seguir rastros mágicos e naturais\n→ Causa +1d6 contra alvos previamente observados\n→ Recebe vantagem contra monstros e aberrações naturais', apexText: 'DESAFIO: Ao rastrear e eliminar uma criatura ameaçadora sem ajuda direta.\n\nHABILIDADE: Pode marcar um inimigo como "presa" – ganha +2 em todos os testes contra ele por 3 turnos e +1d12 de dano.' },
            'Apostador': { status: { vida: 7, rf: 7, rm: 7 }, featuresText: '→ Pode rolar 1d6 por cena e escolher aplicar o número como bônus em qualquer teste\n→ Ganha vantagem em qualquer teste de sorte, blefe ou jogos\n→ Ao obter sucesso crítico, pode jogar novamente e escolher o melhor\n→ +2 em Enganação e Reflexos', apexText: 'DESAFIO: Ao virar uma situação desesperadora a seu favor com sorte ou manipulação.\n\nHABILIDADE: Uma vez por combate, pode transformar uma falha em sucesso com um teste de Carisma (D.A 10 + grau da falha).' },
            'Ilusório': { status: { vida: 5, rf: 4, rm: 3 }, featuresText: '→ +2 em testes de Enganação e Manipulação\n→ Ilusões têm D.A aumentada em +2\n→ Pode criar duplicatas, vozes, ou imagens com 1 ação rápida\n→ Recebe +1 Runa do Pensamento', apexText: 'DESAFIO: Ao enganar completamente um inimigo, grupo ou multidão com uma ilusão poderosa.\n\nHABILIDADE: Uma vez por cena, cria uma ilusão realista que dura 2 rodadas e confunde todos os oponentes (testes com desvantagem).' },
            'Necromante': { status: { vida: 4, rf: 1, rm: 6 }, featuresText: '→ +2 em Ocultismo\n→ Pode conjurar magias relacionadas à morte, espíritos e decadência com +1\n→ Pode animar 1 esqueleto/zumbi por dia (padrão, fraco)\n→ +1 Runa de Sangue gratuita', apexText: 'DESAFIO: Ao invocar ou controlar um morto para alterar o equilíbrio da cena.\n\nHABILIDADE: Uma vez por combate, pode reanimar temporariamente 1 aliado caído por 1 turno com 1d12 de Vida e defesa mínima.' },
            'Poeta das Emoções': { status: { vida: 3, rf: 3, rm: 3 }, featuresText: '→ Escolhe uma emoção (Raiva, Tristeza, Amor, Medo etc.) ao criar o personagem\n→ +2 em testes relacionados à emoção escolhida\n→ Pode inspirar aliados, dando +2 em testes sociais ou +1d6 de dano\n→ Pode anular um medo, trauma ou efeito emocional com uma performance', apexText: 'DESAFIO: Ao comover, curar ou enfurecer um grupo ou inimigo com sua performance.\n\nHABILIDADE: Uma vez por combate, pode aplicar o efeito de sua emoção em todos os aliados e inimigos numa área de 10m.' },
            'Artesão': { status: { vida: 8, rf: 6, rm: 7 }, featuresText: '→ Pode construir ou reparar armas, itens ou proteções entre cenas\n→ +2 em testes de Profissão e Conhecimentos Gerais\n→ Armas criadas pelo Artesão causam +1d4 de dano\n→ Pode adicionar efeitos extras a itens com runas ou materiais raros', apexText: 'DESAFIO: Ao criar um item lendário, uma arma simbólica ou salvar o grupo com uma criação.\n\nHABILIDADE: Uma vez por sessão, pode criar instantaneamente um equipamento (básico) de sua escolha com bônus especial.' },
            'Aniquilador': { status: { vida: 7, rf: 7, rm: 2 }, featuresText: '→ +2 em testes de Intimidação\n→ Causa +1d6 de dano em qualquer ataque contra estruturas, objetos ou grupos\n→ Ganha vantagem contra inimigos com armadura ou defesa elevada\n→ Pode escolher destruir armas e escudos com 1 ataque crítico', apexText: 'DESAFIO: Ao destruir um obstáculo significativo, fortaleza, proteção ou eliminar um grupo de inimigos.\n\nHABILIDADE: Uma vez por combate, pode realizar um golpe que ignora armadura e reduz em 1 o R.F do inimigo permanentemente.' },
            'Mateiro': { status: { vida: 6, rf: 4, rm: 4 }, featuresText: '→ +2 em testes de Sobrevivência, Medicina e Montaria\n→ Não sofre penalidade em terrenos difíceis\n→ Pode se camuflar naturalmente, ganhando vantagem em Furtividade\n→ Ganha resistência natural contra venenos (+2 nos testes)', apexText: 'DESAFIO: Ao salvar um grupo em ambiente hostil com conhecimento da natureza ou eliminar uma criatura natural poderosa.\n\nHABILIDADE: Uma vez por combate, pode invocar um “Aspecto da Natureza” que fornece +2 em todos os testes físicos e +2 R.F por 3 turnos.' }
        };
        const EQUIPMENT_DATA = {
            armor: {
                leve: { def: 2, thresholds: { damaged: 1, broken: 2 } },
                media: { def: 5, thresholds: { damaged: 2, broken: 4 } },
                pesada: { def: 10, thresholds: { damaged: 3, broken: 6 } }
            },
            shield: {
                pequeno: { rf: 2, rm: 2, thresholds: { damaged: 1, broken: 2 } }, // Added rm
                grande: { rf: 5, rm: 5, thresholds: { damaged: 2, broken: 4 } } // Added rm
            }
        };

        const SKILLS = ['Arremesso[FOR]', 'Arrombamento[FOR]', 'Atletismo[COR]', 'Ciências[MEN]', 'Combate[FOR]', 'Conjuração Mágica[MEN]', 'Conjuração Ritualística[ALM]', 'Investigar[MEN]', 'Medicina[MEN]', 'Montaria[DES]', 'Ocultismo[MEN]', 'Percepção[MEN]', 'Pontaria[DEST]', 'Profissão[MEN]', 'Reflexos[DES]', 'Resistência Física[COR]', 'Resistir Influência[ALM]', 'Sentidos Ocultos[ALM]', 'Sobrevivência[MEN]', 'Conhecimentos Gerais[MEN]', 'Devoção[ALM]', 'Diplomacia[CAR]', 'Enganação[CAR]', 'Furtividade[DES]', 'Intimidação[CAR]', 'Intuição[ALM]'];
        const RUNE_ELEMENTS = ['Fogo', 'Gelo', 'Água', 'Relâmpago', 'Vento', 'Alma', 'Ferro', 'Terra', 'Sangue'];
        const RUNE_SIGILS = ['Poder', 'Proteção', 'Pensamento'];
        const RITUAL_LAYERS = ['Luxúria', 'Gula', 'Avareza', 'Ira', 'Inveja', 'Preguiça', 'Orgulho', 'Pecado', 'Servidão'];
        

        // --- FUNÇÕES DE INICIALIZAÇÃO E LÓGICA ---
        function initDropdown(select, options) { select.innerHTML = `<option value="">Selecione...</option>` + Object.keys(options).map(opt => `<option value="${opt}">${opt}</option>`).join(''); }
        function updateDescriptionBox(container, options, value) { if(options[value]) { container.innerHTML = `<div class="parchment-box">${options[value]}</div>`; container.classList.remove('hidden'); } else { container.classList.add('hidden'); } }
        function initSkills() { skillsList.innerHTML = SKILLS.map(skill => { const id = `skill-${skill.toLowerCase().replace(/[\s\/]/g, '-')}`; return `<div class="flex items-center gap-2"><input type="checkbox" id="${id}" class="form-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500"><label for="${id}" class="flex-1">${skill}</label><input type="number" id="${id}-level" class="input-base w-16 p-1 text-center" value="0"></div>`; }).join(''); }
        function createApexes(container, prefix, count) { for (let i = 0; i < count; i++) { container.innerHTML += `<div class="flex flex-col gap-1 apex-item"><input type="text" id="${prefix}-${i}-name" class="input-base w-full p-2" placeholder="Nome do Ápice ${i+1}"><textarea id="${prefix}-${i}-desc" class="textarea-base w-full p-2 h-16" placeholder="Descrição..."></textarea></div>`; } }

        function rollLife() {
            const raceData = RACE_DATA[raceSelect.value];
            const classData = CLASS_DATA[classSelect.value];
            if (!raceData || !classData) {
                displayMessageBox("Por favor, selecione uma Raça e uma Classe primeiro.");
                return;
            }

            const lifeDiceExpression = raceData.status.lifeDice; // e.g., "2d6+5"
            const parts = lifeDiceExpression.split('+');
            const [diceCountStr, diceSidesStr] = parts[0].split('d');
            const diceCount = Number(diceCountStr);
            const diceSides = Number(diceSidesStr);
            const modifier = Number(parts[1]) || 0;

            let rolls = [];
            let totalRollsValue = 0;

            // Create the main overlay for the animation and results
            const diceOverlay = document.createElement('div');
            diceOverlay.className = 'dice-overlay-result'; // Start hidden
            document.body.appendChild(diceOverlay);

            // Create container for the animated dice
            const diceAnimationContainer = document.createElement('div');
            diceAnimationContainer.className = 'dice-animation-container';
            diceOverlay.appendChild(diceAnimationContainer);

            // Create and append animated die elements
            const animatedDiceElements = [];
            for (let i = 0; i < diceCount; i++) {
                const dieEl = document.createElement('div');
                dieEl.className = 'animated-die';
                dieEl.textContent = '🎲'; // Initial emoji for rolling effect
                diceAnimationContainer.appendChild(dieEl);
                animatedDiceElements.push(dieEl);
            }

            // Show the overlay and trigger initial fall animation
            diceOverlay.classList.add('show');
            animatedDiceElements.forEach((dieEl, index) => {
                // Stagger the animation slightly for better effect
                setTimeout(() => {
                    dieEl.classList.add('start-roll');
                }, index * 150); // Small delay for each die
            });

            // After animation, calculate and show results
            // This timeout should be slightly longer than the die-fall animation duration (1.5s)
            setTimeout(() => {
                animatedDiceElements.forEach((dieEl, index) => {
                    const roll = Math.floor(Math.random() * diceSides) + 1;
                    rolls.push(roll);
                    totalRollsValue += roll;

                    // Stop animation and show final value
                    dieEl.classList.add('show-final-value');
                    dieEl.textContent = roll;
                });

                const finalLife = totalRollsValue + modifier + classData.status.vida;

                // Update character sheet inputs
                statusMaxVida.value = finalLife;
                statusCurrentVida.value = finalLife;

                let resultText = `<p class="text-xl"><strong>🎲 Rolagens:</strong> ${rolls.join(", ")}`;
                if (modifier > 0) resultText += ` + ${modifier} (Raça)`;
                if (classData.status.vida > 0) resultText += ` + ${classData.status.vida} (Classe)`;
                resultText += `</p><p class="text-4xl font-bold mt-4 text-yellow-400">❤️ Vida Total: ${finalLife}</p>`;

                // Create a result box within the overlay
                const resultBox = document.createElement('div');
                resultBox.className = 'result-box';
                resultBox.innerHTML = resultText + `<button class="btn-primary py-2 px-4 rounded-lg mt-4" id="close-roll-result">Entendido</button>`;

                // Append the result box after the dice animation has settled
                diceOverlay.appendChild(resultBox);

                // Add event listener to close button
                getEl('close-roll-result').addEventListener('click', () => {
                    diceOverlay.classList.remove('show');
                    // Remove the overlay from DOM after it fades out
                    setTimeout(() => diceOverlay.remove(), 500);
                });

                // Set life as rolled and hide the roll button
                document.body.dataset.lifeRolled = 'true';
                lifeRollContainer.classList.add('hidden');
            }, 2000); // Give 2 seconds for the dice animation to play
        }
        
        function updateAllStats() {
            const raceData = RACE_DATA[raceSelect.value];
            const classData = CLASS_DATA[classSelect.value];
            
            let def = 0, rf = 0, rm = 0;

            if (raceData) { def += raceData.status.def; rf += raceData.status.rf; rm += raceData.status.rm; }
            if (classData) { def += classData.status.def || 0; rf += classData.status.rf || 0; rm += classData.status.rm || 0; }
            
            const deaths = parseInt(getEl('deaths').value, 10) || 0;
            
            const armorType = getEl('armor-type').value;
            const armorData = EQUIPMENT_DATA.armor[armorType];
            const armorDisplay = getEl('armor-status-display');
            if(armorData) {
                let state = 'Inteira';
                if(deaths >= armorData.thresholds.broken) state = 'Quebrada';
                else if(deaths >= armorData.thresholds.damaged) state = 'Danificada';
                armorDisplay.textContent = `Estado: ${state} (+${state === 'Quebrada' ? 0 : armorData.def} DEF)`;
                armorDisplay.className = `text-sm mt-1 text-center state-${state.toLowerCase()}`;
                if(state !== 'Quebrada') def += armorData.def;
            } else {
                armorDisplay.textContent = '';
            }
            
            const shieldType = getEl('shield-type').value;
            const shieldData = EQUIPMENT_DATA.shield[shieldType];
            const shieldDisplay = getEl('shield-status-display');
             if(shieldData) {
                let state = 'Inteiro';
                if(deaths >= shieldData.thresholds.broken) state = 'Quebrado';
                else if(deaths >= shieldData.thresholds.damaged) state = 'Danificado';
                // Updated to show both RF and RM for shields
                shieldDisplay.textContent = `Estado: ${state} (+${state === 'Quebrado' ? 0 : shieldData.rf} RF, +${state === 'Quebrado' ? 0 : shieldData.rm} RM)`;
                shieldDisplay.className = `text-sm mt-1 text-center state-${state.toLowerCase().replace('o', '')}`;
                if(state !== 'Quebrado') {
                    rf += shieldData.rf;
                    rm += shieldData.rm; // Add shield RM to total RM
                }
            } else {
                shieldDisplay.textContent = '';
            }
            getEl('status-def').value = def;
            getEl('status-rf').value = rf;
            getEl('status-rm').value = rm;
        }
        
        function handleClassSelection() {
            updateDescriptionBox(classDescriptionContainer, CLASSES, classSelect.value);
            const classData = CLASS_DATA[classSelect.value];
            if (classData && !window.loadingData) {
                getEl('char-class-features').value = classData.featuresText;
                getEl('char-apex-text').value = classData.apexText;
            }
            document.body.dataset.previousClass = classSelect.value;
            if (raceSelect.value && classSelect.value && document.body.dataset.lifeRolled === 'false') {
                lifeRollContainer.classList.remove('hidden');
                lifeRollResult.innerHTML = '';
            }
            updateAllStats();
        }

        function handleRaceSelection() {
            const selectedRace = raceSelect.value;
            const raceData = RACE_DATA[selectedRace];
            
            updateDescriptionBox(raceDescriptionContainer, RACES, selectedRace);
            raceChoicesContainer.innerHTML = '';  
            raceChoicesContainer.classList.add('hidden');
            document.body.dataset.lifeRolled = 'false'; // Resetar a rolagem ao trocar de raça

            if (!raceData) { updateAllStats(); return; }

            if (!window.loadingData) {
                getEl('char-race-features').value = raceData.featuresText;
                getEl('char-talents').value = '';  
                if (classSelect.value) { // Mostrar botão de rolar apenas se a classe já estiver selecionada
                    lifeRollContainer.classList.remove('hidden');
                    lifeRollResult.innerHTML = '';
                }
            }
            
            updateAllStats();   

            if (!getEl('char-talents').value && raceData.choiceLogic) {
                raceChoicesContainer.classList.remove('hidden');
                setupRaceChoices(raceData);
            }
        }

        function setupRaceChoices(raceData) {
            const { type } = raceData.choiceLogic;
            if (type === 'standard') {
                setupStandardChoices(raceData);
            } else if (type === 'vampire') {
                setupVampireChoices(raceData);
            } else if (type === 'dampiro') {
                setupDampiroChoices();
            }
        }
        
        // Modificado para incluir o botão de olho
        function createChoiceHTML(list, title, max, type) {
            let content = `<div data-type="${type}"><h3 class="font-runic text-xl text-yellow-300 mb-2">${title}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-2" data-max="${max}">`;
            list.forEach(item => {
                const choiceId = `choice-${type}-${item.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                content += `
                    <div class="flex items-center gap-2 choice-box p-2 rounded">
                        <input type="checkbox" id="${choiceId}" data-name="${item}" class="choice-checkbox form-checkbox h-5 w-5 rounded">
                        <label for="${choiceId}" class="flex-1">${item}</label>
                        <button type="button" class="info-eye-button" data-description-key="${item}" title="Ver Descrição">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>`;
            });
            content += '</div></div>';
            return content;
        }

        function setupStandardChoices(raceData) {
            const { talents, maculas, choiceLogic } = raceData;
            raceChoicesContainer.innerHTML = 
                createChoiceHTML(talents, `Escolha ${choiceLogic.talents} Talentos`, choiceLogic.talents, 'talent') +
                `<div class="mt-4">${createChoiceHTML(maculas, `Escolha ${choiceLogic.maculas} Máculas`, choiceLogic.maculas, 'macula')}</div>`;
        }

        function setupVampireChoices(raceData) {
            const { talents, maculas } = raceData;
            let maculaHTML = `<div data-type="macula"><h3 class="font-runic text-xl text-yellow-300 mb-2">Escolha 1 Mácula Adicional</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-2" data-max="2">`;
            maculaHTML += `<div class="flex items-center gap-2 choice-box p-2 rounded bg-blue-900/50">
                                <input type="checkbox" data-name="Sede de Sangue (Hereditária)" checked disabled class="form-checkbox">
                                <label>Sede de Sangue (Hereditária)</label>
                                <button type="button" class="info-eye-button" data-description-key="Sede de Sangue (Hereditária)" title="Ver Descrição">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>`;
            maculas.forEach(item => {
                const choiceId = `choice-macula-${item.toLowerCase().replace(/[^a-z0-9]/g, '')}`;
                maculaHTML += `
                    <div class="flex items-center gap-2 choice-box p-2 rounded">
                        <input type="checkbox" id="${choiceId}" data-name="${item}" class="choice-checkbox form-checkbox h-5 w-5 rounded">
                        <label for="${choiceId}">${item}</label>
                        <button type="button" class="info-eye-button" data-description-key="${item}" title="Ver Descrição">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>`;
            });
               maculaHTML += `</div></div>`;

            raceChoicesContainer.innerHTML = createChoiceHTML(talents, `Escolha 2 Talentos`, 2, 'talent') + `<div class="mt-4">${maculaHTML}</div>`;
        }

        function setupDampiroChoices() {
            raceChoicesContainer.innerHTML = `
                <h3 class="font-runic text-xl text-yellow-300 mb-2">Prole de Nosferatu: Escolha seu Legado</h3>
                <div class="flex gap-4 mb-4">
                    <button id="dampiro-path-default" class="btn-primary p-2 rounded-lg flex-1">Legado de Dampiro</button>
                    <button id="dampiro-path-hybrid" class="btn-secondary p-2 rounded-lg flex-1">Legado Híbrido</button>
                </div>
                <div id="dampiro-default-choices">${createChoiceHTML(DAMPIRO_TALENTS, 'Escolha 2 Talentos de Dampiro', 2, 'talent')} <div class="mt-4">${createChoiceHTML(DAMPIRO_MACULAS, 'Escolha 2 Máculas de Dampiro', 2, 'macula')}</div></div>
                <div id="dampiro-hybrid-choices" class="hidden">${createChoiceHTML(HUMAN_TALENTS.concat(VAMPIRE_TALENTS), 'Escolha 2 Talento (Humano ou Vampiro)', 2, 'talent')} <div class="mt-4">${createChoiceHTML(HUMAN_MACULAS.concat(VAMPIRE_MACULAS_OPTIONAL), 'Escolha 2 Mácula (Humana ou Vampiro)', 2, 'macula')}</div></div>
            `;
            getEl('dampiro-path-default').addEventListener('click', () => { getEl('dampiro-default-choices').classList.remove('hidden'); getEl('dampiro-hybrid-choices').classList.add('hidden'); });
            getEl('dampiro-path-hybrid').addEventListener('click', () => { getEl('dampiro-default-choices').classList.add('hidden'); getEl('dampiro-hybrid-choices').classList.remove('hidden'); });
        }
        
        raceChoicesContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('choice-checkbox')) {
                const container = e.target.closest('[data-max]');
                if (!container) return;
                const max = parseInt(container.dataset.max, 10);
                
                const totalChecked = container.querySelectorAll('input:checked').length;
                
                container.querySelectorAll('input:not(:checked)').forEach(cb => cb.disabled = totalChecked >= max);
                updateTalentsAndMaculasText();
            }
        });

        function updateTalentsAndMaculasText() {
            const talentDivs = raceChoicesContainer.querySelectorAll('[data-type="talent"]');
            const maculaDivs = raceChoicesContainer.querySelectorAll('[data-type="macula"]');
            
            let selectedTalents = [];
            let selectedMaculas = [];

            talentDivs.forEach(container => {
                if (!container.closest('.hidden')) {
                    selectedTalents.push(...Array.from(container.querySelectorAll('input:checked')).map(cb => cb.dataset.name));
                }
            });
            maculaDivs.forEach(container => {
                if (!container.closest('.hidden')) {
                    selectedMaculas.push(...Array.from(container.querySelectorAll('input:checked')).map(cb => cb.dataset.name));
                }
            });
            
            let text = '';
            if (selectedTalents.length > 0) text += 'Talentos: ' + selectedTalents.join(', ') + '.\n\n';
            if (selectedMaculas.length > 0) text += 'Máculas: ' + selectedMaculas.join(', ') + '.';
            getEl('char-talents').value = text;
            
            const raceData = RACE_DATA[raceSelect.value];
            if (!raceData || !raceData.choiceLogic) return;
            
            const { choiceLogic } = raceData;
            let talentsDone = false, maculasDone = false;

            if (choiceLogic.type === 'standard') {
                talentsDone = selectedTalents.length === choiceLogic.talents;
                maculasDone = selectedMaculas.length === choiceLogic.maculas;
            } else if (choiceLogic.type === 'vampire') {
                talentsDone = selectedTalents.length === 2;
                // For vampire, one macula is pre-selected, so check for 1 additional selected
                maculasDone = selectedMaculas.length === 1 && container.querySelector('[data-name="Sede de Sangue (Hereditária)"]').checked; // Ensure the default is still checked
            } else if (choiceLogic.type === 'dampiro') {
                const isHybrid = getEl('dampiro-hybrid-choices') && !getEl('dampiro-hybrid-choices').classList.contains('hidden');
                talentsDone = selectedTalents.length === (isHybrid ? 2 : 2); // Dampiro always picks 2 talents, hybrid or not
                maculasDone = selectedMaculas.length === (isHybrid ? 2 : 2); // Dampiro always picks 2 maculas, hybrid or not
            }

            if (talentsDone && maculasDone) {
                raceChoicesContainer.classList.add('hidden');
            }
        }

        // --- FUNÇÕES DINÂMICAS E UTILITÁRIAS ---
        function addDynamicListItem(listElement, itemClass, innerHTML) {
            const itemId = `item-${Date.now()}`;
            const itemEl = document.createElement('div');
            itemEl.id = itemId;
            itemEl.className = itemClass;
            itemEl.innerHTML = innerHTML.replace(/{{itemId}}/g, itemId);
            listElement.appendChild(itemEl);
        }

        function addInventoryItem() { addDynamicListItem(inventoryList, 'p-2 card flex flex-col gap-2', `<div class="flex gap-2"><input type="text" class="input-base flex-grow p-1" placeholder="Nome do Item"><button class="btn-danger p-1 px-2 rounded" onclick="document.getElementById('{{itemId}}').remove()"><i class="fas fa-trash"></i></button></div><textarea class="textarea-base w-full p-1 h-12" placeholder="Descrição"></textarea><div class="grid grid-cols-2 gap-2"><input type="text" class="input-base p-1" placeholder="Dano"><input type="text" class="input-base p-1" placeholder="Efeito/Crítico"></div>`); }
        function addRune() { addDynamicListItem(runesList, 'p-2 card flex items-center gap-2', `<div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-2"><select class="select-base p-1">${RUNE_ELEMENTS.map(e => `<option>${e}</option>`).join('')}</select><select class="select-base p-1">${RUNE_SIGILS.map(s => `<option>${s}</option>`).join('')}</select><input type="number" class="input-base p-1 text-center" placeholder="Acúmulos" value="0"></div><button class="btn-danger p-1 px-2 rounded" onclick="document.getElementById('{{itemId}}').remove()"><i class="fas fa-trash"></i></button>`); }
        function addRitual() { addDynamicListItem(ritualsList, 'p-2 card flex flex-col', `<div class="flex gap-2 items-center mb-2"><input type="text" class="input-base flex-grow p-1" placeholder="Nome do Ritual"><button class="btn-danger p-1 px-2 rounded" onclick="document.getElementById('{{itemId}}').remove()"><i class="fas fa-trash"></i></button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2"><select class="select-base p-1">${RITUAL_LAYERS.map(l => `<option>${l}</option>`).join('')}</select><input type="number" class="input-base p-1 text-center" placeholder="Usos" value="0"></div><textarea class="textarea-base w-full p-1 h-16" placeholder="Descrição do Ritual..."></textarea>`); }
        
        function handleDracmaConversion() {
            let b = parseInt(getEl('dracma-b').value) || 0;
            let p = parseInt(getEl('dracma-p').value) || 0;
            let o = parseInt(getEl('dracma-o').value) || 0;
            let d = parseInt(getEl('dracma-d').value) || 0;

            p += Math.floor(b / 100); b %= 10;
            o += Math.floor(p / 10); p %= 10;
            d += Math.floor(o / 100); o %= 100;

            getEl('dracma-b').value = b; getEl('dracma-p').value = p;
            getEl('dracma-o').value = o; getEl('dracma-d').value = d;
            
            const totalBronze = b + (p * 100) + (o * 100) + (d * 10000);
            getEl('dracma-details').innerHTML = `
                <p>♦️ ${d} (equivale a ${d*100} 🪙)</p>
                <p>🪙 ${o} (equivale a ${o*10} 🥈)</p>
                <p>🥈 ${p} (equivale a ${p*100} 🟤)</p>
                <p class="pt-1 mt-1 border-t border-gray-600"><strong>Total:</strong> ${totalBronze.toLocaleString('pt-BR')} em Bronze</p>
            `;
        }

        // Custom message box function (updated to remove existing before creating new)
        function displayMessageBox(message) {
            const messageBoxContainer = getEl('message-box-container');
            // Remove any existing message boxes first
            while (messageBoxContainer.firstChild) {
                messageBoxContainer.removeChild(messageBoxContainer.firstChild);
            }

            const messageBoxId = 'custom-message-box';
            let messageBox = document.createElement('div');
            messageBox.id = messageBoxId;
            messageBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
            messageBox.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                    <p class="text-white text-lg mb-4">${message}</p>
                    <button class="btn-primary py-2 px-4 rounded-lg" id="message-box-ok-btn">OK</button>
                </div>
            `;
            messageBoxContainer.appendChild(messageBox);

            // Add event listener to the dynamically created OK button
            getEl('message-box-ok-btn').addEventListener('click', () => {
                messageBox.remove();
            });
        }

        // Nova função para lidar com a mudança na vida atual
        function handleCurrentVidaChange() {
            let current = parseInt(statusCurrentVida.value, 10);
            const max = parseInt(statusMaxVida.value, 10);
            if (isNaN(current)) current = 0; // Treat non-numbers as 0

            if (current > max) {
                statusCurrentVida.value = max;
            } else if (current < 0) {
                statusCurrentVida.value = 0;
            }
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            } else {
                document.body.classList.remove('light-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            localStorage.setItem('draemoraTheme', theme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('draemoraTheme') || 'dark';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }

        // --- Multi-Sheet Management ---
        let allCharacterSheets = {};
        let currentLoadedSheetName = null; // To keep track of the currently loaded sheet

        function loadAllSheetsFromLocalStorage() {
            const storedSheets = localStorage.getItem('draemoraCharacterSheets');
            if (storedSheets) {
                allCharacterSheets = JSON.parse(storedSheets);
            } else {
                allCharacterSheets = {};
            }
        }

        function displaySavedSheets() {
            savedSheetsList.innerHTML = '';
            const sheetNames = Object.keys(allCharacterSheets);
            if (sheetNames.length === 0) {
                savedSheetsList.innerHTML = '<p class="text-gray-400">Nenhuma ficha salva.</p>';
                return;
            }

            sheetNames.forEach(name => {
                const sheetItem = document.createElement('div');
                sheetItem.className = 'flex items-center justify-between p-2 card';
                sheetItem.innerHTML = `
                    <span class="font-bold">${name}</span>
                    <div class="flex gap-2">
                        <button class="btn-primary p-2 rounded-lg text-sm" data-sheet-name="${name}" data-action="load">Carregar</button>
                        <button class="btn-danger p-2 rounded-lg text-sm" data-sheet-name="${name}" data-action="delete">Excluir</button>
                    </div>
                `;
                savedSheetsList.appendChild(sheetItem);
            });
        }

        function loadSheet(sheetName) {
            if (allCharacterSheets[sheetName]) {
                clearAllSheetFields(); // Clear current sheet before loading new one

                // Re-initialize dropdowns and skills before loading data
                initDropdown(classSelect, CLASSES);
                initDropdown(raceSelect, RACE_DATA);
                initSkills();
                raceApexesContainer.innerHTML = '';
                classApexesContainer.innerHTML = '';
                createApexes(raceApexesContainer, 'race-apex', 4);
                createApexes(classApexesContainer, 'class-apex', 4);

                window.loadingData = true; // Prevent reactive updates during load
                
                const data = allCharacterSheets[sheetName];

                charNameInput.value = data.name || '';
                classSelect.value = data.class || '';
                raceSelect.value = data.race || '';
                charDevotionInput.value = data.devotion || '';
                getEl('avatar-preview').src = data.avatar || 'https://placehold.co/128x192/0D1B2A/E0E1DD?text=Avatar';
                
                if(data.attrs) Object.entries(data.attrs).forEach(([k,v]) => getEl(`attr-${k}`).value = v);
                if(data.stats) {
                    statusMaxVida.value = data.stats.maxVida || 0;
                    statusCurrentVida.value = data.stats.currentVida || 0;
                    getEl('status-def').value = data.stats.def || 0;
                    getEl('status-rf').value = data.stats.rf || 0;
                    getEl('status-rm').value = data.stats.rm || 0;
                }
                if(data.features) {
                    getEl('char-race-features').value = data.features.race || '';
                    getEl('char-class-features').value = data.features.class || '';
                    getEl('char-talents').value = data.features.talents || '';
                    getEl('char-apex-text').value = data.features.apexText || '';
                    charPersonalBackground.value = data.features.personalBackground || '';
                }
                if(data.equipment) {
                    getEl('armor-type').value = data.equipment.armor || 'nenhuma';
                    getEl('shield-type').value = data.equipment.shield || 'nenhum';
                    getEl('deaths').value = data.equipment.deaths || 0;
                }
                if(data.dracmas) {
                    getEl('dracma-b').value = data.dracmas.b || 0; getEl('dracma-p').value = data.dracmas.p || 0;
                    getEl('dracma-o').value = data.dracmas.o || 0; getEl('dracma-d').value = data.dracmas.d || 0;
                    handleDracmaConversion();
                }
                if(data.skills) data.skills.forEach((s, i) => { const id = `skill-${SKILLS[i].toLowerCase().replace(/[\s\/]/g, '-')}`; if(getEl(id)) { getEl(id).checked = s.trained; getEl(`${id}-level`).value = s.level; } });
                
                inventoryList.innerHTML = '';
                if(data.inventory) data.inventory.forEach(item => { addInventoryItem(); const i = inventoryList.lastChild; i.querySelector('input[type=text]').value = item.name; i.querySelector('textarea').value = item.desc; if (item.dmg) i.querySelectorAll('input[type=text]')[1].value = item.dmg; if (item.crit) i.querySelectorAll('input[type=text]')[2].value = item.crit; });
                
                runesList.innerHTML = '';
                if(data.runes) data.runes.forEach(item => { addRune(); const r = runesList.lastChild; r.querySelectorAll('select')[0].value = item.element; r.querySelectorAll('select')[1].value = item.sigil; r.querySelector('input').value = item.stacks; });
                
                ritualsList.innerHTML = '';
                if(data.rituals) data.rituals.forEach(item => { addRitual(); const r = ritualsList.lastChild; r.querySelector('input[type=text]').value = item.name; r.querySelector('select').value = item.layer; r.querySelector('input[type=number]').value = item.uses; r.querySelector('textarea').value = item.desc; });
                
                if (data.stage2) { getEl('stage2-name').value = data.stage2.name || ''; getEl('stage2-benefit').value = data.stage2.benefit || ''; }
                if (data.stage3) { getEl('stage3-name').value = data.stage3.name || ''; getEl('stage3-ability').value = data.stage3.ability || ''; }
                if (data.stage4) { getEl('stage4-name').value = data.stage4.name || ''; getEl('stage4-effect').value = data.stage4.effect || ''; }
                
                notesTextArea.value = data.notes || '';
                goalsTextArea.value = data.goals || '';

                document.body.dataset.lifeRolled = data.lifeRolled || 'false';
                if (data.lifeRolled === 'true') {
                    lifeRollContainer.classList.add('hidden');
                } else {
                    lifeRollContainer.classList.remove('hidden');
                }
                
                handleClassSelection();
                handleRaceSelection();

                if (data.features && data.features.talents) {
                    raceChoicesContainer.classList.add('hidden');
                } else if (RACE_DATA[data.race] && RACE_DATA[data.race].choiceLogic) {
                    raceChoicesContainer.classList.remove('hidden');
                    setupRaceChoices(RACE_DATA[data.race]);
                    // Re-check selected choices if any
                    if (data.features && data.features.talents) {
                        const loadedTalents = data.features.talents.match(/Talentos: (.*?)\./)?.[1]?.split(', ') || [];
                        const loadedMaculas = data.features.talents.match(/Máculas: (.*?)\./)?.[1]?.split(', ') || [];
                        loadedTalents.forEach(t => {
                            const cb = getEl(`choice-talent-${t.toLowerCase().replace(/[^a-z0-9]/g, '')}`);
                            if (cb) cb.checked = true;
                        });
                        loadedMaculas.forEach(m => {
                            const cb = getEl(`choice-macula-${m.toLowerCase().replace(/[^a-z0-9]/g, '')}`);
                            if (cb) cb.checked = true;
                        });
                        updateTalentsAndMaculasText(); // Re-run to update disabled states
                    }
                }
                if(data.race === 'Dampiro' && data.dampiroPath) {
                   const dampiroDefault = getEl('dampiro-default-choices');
                   const dampiroHybrid = getEl('dampiro-hybrid-choices');
                    if(dampiroDefault && dampiroHybrid) {
                       if(data.dampiroPath === 'hybrid') {
                            dampiroDefault.classList.add('hidden');
                            dampiroHybrid.classList.remove('hidden');
                        } else {
                            dampiroDefault.classList.remove('hidden');
                            dampiroHybrid.classList.add('hidden');
                        }
                    }
                }
                
                window.loadingData = false;
                currentLoadedSheetName = sheetName;
                localStorage.setItem('lastLoadedSheet', sheetName); // Save last loaded sheet
                displayMessageBox(`Ficha "${sheetName}" carregada com sucesso!`);
                manageSheetsModal.classList.add('hidden'); // Close modal after loading
            } else {
                displayMessageBox(`Ficha "${sheetName}" não encontrada.`);
            }
        }

        function deleteSheet(sheetName) {
            const messageBoxId = 'confirm-delete-box';
            let confirmBox = document.getElementById(messageBoxId);

            if (!confirmBox) {
                confirmBox = document.createElement('div');
                confirmBox.id = messageBoxId;
                confirmBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
                confirmBox.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                        <p class="text-white text-lg mb-4">Tem certeza que deseja excluir a ficha "${sheetName}"? Esta ação é irreversível.</p>
                        <div class="flex justify-center gap-4">
                            <button class="btn-danger py-2 px-4 rounded-lg" id="confirm-delete-yes">Sim, Excluir</button>
                            <button class="btn-primary py-2 px-4 rounded-lg" onclick="document.getElementById('${messageBoxId}').remove()">Cancelar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                getEl('confirm-delete-yes').addEventListener('click', () => {
                    document.body.removeChild(confirmBox); // Close the confirmation box
                    delete allCharacterSheets[sheetName];
                    localStorage.setItem('draemoraCharacterSheets', JSON.stringify(allCharacterSheets));
                    displayMessageBox(`Ficha "${sheetName}" excluída com sucesso!`);
                    displaySavedSheets(); // Refresh the list
                    if (currentLoadedSheetName === sheetName) {
                        clearAllSheetFields(); // Clear current sheet if it was the one deleted
                        currentLoadedSheetName = null;
                        localStorage.removeItem('lastLoadedSheet');
                    }
                });
            } else {
                confirmBox.querySelector('p').textContent = `Tem certeza que deseja excluir a ficha "${sheetName}"? Esta ação é irreversível.`;
                confirmBox.style.display = 'flex';
            }
        }


        function saveDataPrompt() {
            const sheetName = prompt("Digite um nome para salvar a ficha:");
            if (sheetName) {
                if (allCharacterSheets[sheetName]) {
                    const overwriteConfirmBoxId = 'confirm-overwrite-box';
                    let overwriteConfirmBox = document.getElementById(overwriteConfirmBoxId);

                    if (!overwriteConfirmBox) {
                        overwriteConfirmBox = document.createElement('div');
                        overwriteConfirmBox.id = overwriteConfirmBoxId;
                        overwriteConfirmBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
                        overwriteConfirmBox.innerHTML = `
                            <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                                <p class="text-white text-lg mb-4">Já existe uma ficha com o nome "${sheetName}". Deseja substituí-la?</p>
                                <div class="flex justify-center gap-4">
                                    <button class="btn-danger py-2 px-4 rounded-lg" id="confirm-overwrite-yes">Sim, Substituir</button>
                                    <button class="btn-primary py-2 px-4 rounded-lg" onclick="document.getElementById('${overwriteConfirmBoxId}').remove()">Cancelar</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(overwriteConfirmBox);

                        getEl('confirm-overwrite-yes').addEventListener('click', () => {
                            document.body.removeChild(overwriteConfirmBox);
                            saveCurrentSheetData(sheetName);
                        });
                    } else {
                        overwriteConfirmBox.querySelector('p').textContent = `Já existe uma ficha com o nome "${sheetName}". Deseja substituí-la?`;
                        overwriteConfirmBox.style.display = 'flex';
                    }
                } else {
                    saveCurrentSheetData(sheetName);
                }
            } else {
                displayMessageBox("Nome da ficha não pode ser vazio.");
            }
        }

        function saveCurrentSheetData(sheetName) {
            const dampiroPath = raceSelect.value === 'Dampiro' && getEl('dampiro-hybrid-choices') ? (getEl('dampiro-hybrid-choices').classList.contains('hidden') ? 'default' : 'hybrid') : null;
            const data = {
                avatar: getEl('avatar-preview').src,
                name: charNameInput.value,
                class: classSelect.value,
                race: raceSelect.value,
                devotion: charDevotionInput.value,
                dampiroPath: dampiroPath,
                attrs: { cor: getEl('attr-cor').value, for: getEl('attr-for').value, des: getEl('attr-des').value, men: getEl('attr-men').value, alm: getEl('attr-alm').value, car: getEl('attr-car').value },
                stats: { maxVida: statusMaxVida.value, currentVida: statusCurrentVida.value, def: getEl('status-def').value, rf: getEl('status-rf').value, rm: getEl('status-rm').value },
                features: { race: getEl('char-race-features').value, class: getEl('char-class-features').value, talents: getEl('char-talents').value, apexText: getEl('char-apex-text').value, personalBackground: charPersonalBackground.value },
                equipment: { armor: getEl('armor-type').value, shield: getEl('shield-type').value, deaths: getEl('deaths').value },
                dracmas: { b: getEl('dracma-b').value, p: getEl('dracma-p').value, o: getEl('dracma-o').value, d: getEl('dracma-d').value },
                skills: SKILLS.map(skill => { const id = `skill-${skill.toLowerCase().replace(/[\s\/]/g, '-')}`; return { trained: getEl(id).checked, level: getEl(`${id}-level`).value }; }),
                inventory: Array.from(inventoryList.children).map(item => ({ name: item.querySelector('input[type=text]').value, desc: item.querySelector('textarea').value, dmg: item.querySelectorAll('input[type=text]')[1] ? item.querySelectorAll('input[type=text]')[1].value : '', crit: item.querySelectorAll('input[type=text]')[2] ? item.querySelectorAll('input[type=text]')[2].value : '' })),
                runes: Array.from(runesList.children).map(item => ({ element: item.querySelectorAll('select')[0].value, sigil: item.querySelectorAll('select')[1].value, stacks: item.querySelector('input').value })),
                rituals: Array.from(ritualsList.children).map(item => ({ name: item.querySelectorAll('input[type=text]')[0].value, layer: item.querySelector('select').value, uses: item.querySelector('input[type=number]').value, desc: item.querySelector('textarea').value })),
                lifeRolled: document.body.dataset.lifeRolled === 'true',
                stage2: { name: getEl('stage2-name').value, benefit: getEl('stage2-benefit').value },
                stage3: { name: getEl('stage3-name').value, ability: getEl('stage3-ability').value },
                stage4: { name: getEl('stage4-name').value, effect: getEl('stage4-effect').value },
                notes: notesTextArea.value,
                goals: goalsTextArea.value
            };
            allCharacterSheets[sheetName] = data;
            localStorage.setItem('draemoraCharacterSheets', JSON.stringify(allCharacterSheets));
            currentLoadedSheetName = sheetName;
            localStorage.setItem('lastLoadedSheet', sheetName); // Save last loaded sheet
            displayMessageBox(`Ficha "${sheetName}" salva com sucesso!`);
        }

        function saveCurrentSheet() {
            if (currentLoadedSheetName) {
                saveCurrentSheetData(currentLoadedSheetName);
            } else {
                saveDataPrompt(); // If no sheet is loaded, prompt for a new name
            }
        }

        function clearAllSheetFields() {
            getEl('avatar-preview').src = 'https://placehold.co/128x192/0D1B2A/E0E1DD?text=Avatar';
            
            document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                input.value = '';
            });

            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            getEl('armor-type').value = 'nenhuma';
            getEl('shield-type').value = 'nenhum';

            const attrs = ['cor', 'for', 'des', 'men', 'alm', 'car'];
            attrs.forEach(attr => getEl(`attr-${attr}`).value = 0);

            statusMaxVida.value = 0;
            statusCurrentVida.value = 0;
            getEl('status-def').value = 0;
            getEl('status-rf').value = 0;
            getEl('status-rm').value = 0;
            getEl('deaths').value = 0;

            inventoryList.innerHTML = '';
            runesList.innerHTML = '';
            ritualsList.innerHTML = '';

            SKILLS.forEach(skill => {
                const id = `skill-${skill.toLowerCase().replace(/[\s\/]/g, '-')}`;
                const checkbox = getEl(id);
                const levelInput = getEl(`${id}-level`);
                if (checkbox) checkbox.checked = false;
                if (levelInput) levelInput.value = 0;
            });

            classDescriptionContainer.innerHTML = '';
            classDescriptionContainer.classList.add('hidden');
            raceDescriptionContainer.innerHTML = '';
            raceDescriptionContainer.classList.add('hidden');
            raceChoicesContainer.innerHTML = '';
            raceChoicesContainer.classList.add('hidden');

            document.body.dataset.lifeRolled = 'false';
            lifeRollContainer.classList.add('hidden');
            lifeRollResult.innerHTML = '';
            
            getEl('dracma-b').value = 1;
            getEl('dracma-p').value = 1;
            getEl('dracma-o').value = 1;
            getEl('dracma-d').value = 1;
            handleDracmaConversion();

            initDropdown(classSelect, CLASSES);
            initDropdown(raceSelect, RACE_DATA);
            initSkills();
            raceApexesContainer.innerHTML = '';
            classApexesContainer.innerHTML = '';
            createApexes(raceApexesContainer, 'race-apex', 4);
            createApexes(classApexesContainer, 'class-apex', 4);
            updateAllStats();
            currentLoadedSheetName = null;
            localStorage.removeItem('lastLoadedSheet');
        }


        function resetData() {
            const messageBoxId = 'confirm-reset-box';
            let confirmBox = document.getElementById(messageBoxId);

            if (!confirmBox) {
                confirmBox = document.createElement('div');
                confirmBox.id = messageBoxId;
                confirmBox.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1000]';
                confirmBox.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto border border-gray-600">
                        <p class="text-white text-lg mb-4">Tem certeza que deseja reiniciar a ficha? Todos os dados atuais serão perdidos, mas as fichas salvas permanecerão.</p>
                        <div class="flex justify-center gap-4">
                            <button class="btn-danger py-2 px-4 rounded-lg" id="confirm-reset-yes">Sim, Reiniciar</button>
                            <button class="btn-primary py-2 px-4 rounded-lg" onclick="document.getElementById('${messageBoxId}').remove()">Cancelar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmBox);

                getEl('confirm-reset-yes').addEventListener('click', () => {
                    document.body.removeChild(confirmBox); // Close the confirmation box
                    clearAllSheetFields();
                    displayMessageBox('Ficha reiniciada com sucesso!');
                });
            } else {
                confirmBox.querySelector('p').textContent = `Tem certeza que deseja reiniciar a ficha? Todos os dados atuais serão perdidos, mas as fichas salvas permanecerão.`;
                confirmBox.style.display = 'flex';
            }
        }

        async function generateCharacterBackground() {
            const charName = charNameInput.value;
            const charRace = raceSelect.value;
            const charClass = classSelect.value;
            const charDevotion = charDevotionInput.value;

            if (!charName || !charRace || !charClass) {
                displayMessageBox("Por favor, preencha o Nome, Raça e Classe do personagem para gerar um histórico.");
                return;
            }

            generateBackgroundText.textContent = "Gerando...";
            generateBackgroundSpinner.classList.remove('hidden');
            generateBackgroundBtn.disabled = true;

            const prompt = `Crie um histórico de personagem de RPG detalhado para um personagem chamado ${charName}, da raça ${charRace} e da classe ${charClass}. Se a devoção for "${charDevotion}", inclua-a no histórico. O histórico deve ser imersivo, com elementos de drama, motivação e como o personagem chegou ao seu ponto atual no mundo de fantasia. Deve ter entre 200 e 300 palavras.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave as-is for Canvas to provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    charPersonalBackground.value = generatedText;
                } else {
                    displayMessageBox("Não foi possível gerar um histórico. Tente novamente.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                displayMessageBox("Ocorreu um erro ao conectar-se com o serviço de geração de histórico. Verifique sua conexão ou tente novamente mais tarde.");
            } finally {
                generateBackgroundText.textContent = "Gerar Histórico ✨";
                generateBackgroundSpinner.classList.add('hidden');
                generateBackgroundBtn.disabled = false;
            }
        }

        async function generateGoalIdeas() {
            const charName = charNameInput.value;
            const charRace = raceSelect.value;
            const charClass = classSelect.value;
            const currentGoals = goalsTextArea.value;
            const charDevotion = charDevotionInput.value;
            const personalBackground = charPersonalBackground.value;

            if (!charName || !charRace || !charClass) {
                displayMessageBox("Por favor, preencha o Nome, Raça e Classe do personagem para gerar ideias de objetivos.");
                return;
            }

            generateGoalsText.textContent = "Gerando...";
            generateGoalsSpinner.classList.remove('hidden');
            generateGoalsBtn.disabled = true;

            let prompt = `Com base no personagem a seguir, gere 3-5 ideias de objetivos de RPG que sejam interessantes e que possam impulsionar a narrativa. Os objetivos devem ser curtos e diretos, focando em missões ou aspirações que o personagem possa ter.`;
            prompt += `\n\nNome: ${charName}\nRaça: ${charRace}\nClasse: ${charClass}`;
            if (charDevotion) prompt += `\nDevoção: ${charDevotion}`;
            if (personalBackground) prompt += `\nHistórico Pessoal: ${personalBackground}`;
            if (currentGoals) prompt += `\nObjetivos Atuais: ${currentGoals}`;
            prompt += `\n\nFormato da resposta: Uma lista numerada de objetivos.`;


            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Leave as-is for Canvas to provide
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const generatedText = result.candidates[0].content.parts[0].text;
                    goalsTextArea.value += (goalsTextArea.value ? "\n\n--- Novas Ideias ---\n" : "") + generatedText;
                } else {
                    displayMessageBox("Não foi possível gerar ideias de objetivos. Tente novamente.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini para objetivos:", error);
                displayMessageBox("Ocorreu um erro ao conectar-se com o serviço de geração de objetivos. Verifique sua conexão ou tente novamente mais tarde.");
            } finally {
                generateGoalsText.textContent = "Gerar Ideias de Objetivos ✨";
                generateGoalsSpinner.classList.add('hidden');
                generateGoalsBtn.disabled = false;
            }
        }


        function exportPDF() {  
            const sheet = document.getElementById('character-sheet');
            const charName = charNameInput.value || 'personagem_draemora';
            const options = { margin: 0.5, filename: `${charName.replace(/\s+/g, '_').toLowerCase()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, backgroundColor: '#0D1B2A' }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(sheet).set(options).save();
           }

        // --- Event Listener para o botão do olho ---
        raceChoicesContainer.addEventListener('click', (e) => {
            const infoButton = e.target.closest('.info-eye-button');
            if (infoButton) {
                const descriptionKey = infoButton.dataset.descriptionKey;
                const description = TALENT_MACULA_DESCRIPTIONS[descriptionKey];

                if (description) {
                    descriptionModalTitle.textContent = descriptionKey;
                    descriptionModalContent.textContent = description;
                    descriptionModal.classList.remove('hidden');
                } else {
                    displayMessageBox(`Descrição para "${descriptionKey}" não encontrada.`);
                }
            }
        });

        // --- Event Listener para fechar o modal de descrição ---
        closeDescriptionModalBtn.addEventListener('click', () => {
            descriptionModal.classList.add('hidden');
        });

        // --- EVENT LISTENERS ---
        getEl('avatar-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => getEl('avatar-preview').src = e.target.result;
                reader.readAsDataURL(file);
            }
        });
        classSelect.addEventListener('change', handleClassSelection);
        raceSelect.addEventListener('change', handleRaceSelection);
        ['armor-type', 'shield-type', 'deaths'].forEach(id => getEl(id).addEventListener('change', updateAllStats));
        ['dracma-b', 'dracma-p', 'dracma-o', 'dracma-d'].forEach(id => getEl(id).addEventListener('input', handleDracmaConversion));
        rollLifeBtn.addEventListener('click', rollLife);
        
        saveCurrentButton.addEventListener('click', saveCurrentSheet); // New event listener for "Salvar Ficha Atual"
        saveAsButton.addEventListener('click', saveDataPrompt);        // Renamed event listener for "Salvar Ficha (Como)"

        getEl('pdf-button').addEventListener('click', exportPDF);
        getEl('reset-button').addEventListener('click', resetData);
        getEl('add-inventory-item').addEventListener('click', addInventoryItem);
        getEl('add-rune-item').addEventListener('click', addRune);
        getEl('add-ritual-item').addEventListener('click', addRitual);
        generateBackgroundBtn.addEventListener('click', generateCharacterBackground);
        generateGoalsBtn.addEventListener('click', generateGoalIdeas);

        // Event listener for current life input
        statusCurrentVida.addEventListener('input', handleCurrentVidaChange);
        
        // Event listener for theme toggle
        themeToggleButton.addEventListener('click', toggleTheme);

        // Event listeners for manage sheets modal
        manageSheetsButton.addEventListener('click', () => {
            displaySavedSheets();
            manageSheetsModal.classList.remove('hidden');
        });
        closeManageSheetsModal.addEventListener('click', () => {
            manageSheetsModal.classList.add('hidden');
        });

        // Delegated event listener for load/delete buttons inside the modal
        savedSheetsList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                const sheetName = button.dataset.sheetName;
                const action = button.dataset.action;
                if (action === 'load') {
                    loadSheet(sheetName);
                } else if (action === 'delete') {
                    deleteSheet(sheetName);
                }
            }
        });

        
        // --- INITIALIZATION ---
        // Load all sheets and apply theme on startup
        loadAllSheetsFromLocalStorage();
        const savedTheme = localStorage.getItem('draemoraTheme') || 'dark';
        applyTheme(savedTheme);

        // Load the last loaded sheet, or a blank one if none selected/available
        const lastLoaded = localStorage.getItem('lastLoadedSheet');
        if (lastLoaded && allCharacterSheets[lastLoaded]) {
            loadSheet(lastLoaded);
        } else if (Object.keys(allCharacterSheets).length > 0) {
            // If no specific last loaded, load the first available sheet
            loadSheet(Object.keys(allCharacterSheets)[0]);
        } else {
            // Otherwise, initialize a fresh sheet
            initDropdown(classSelect, CLASSES);
            initDropdown(raceSelect, RACE_DATA);
            initSkills();
            createApexes(raceApexesContainer, 'race-apex', 4);
            createApexes(classApexesContainer, 'class-apex', 4);
            clearAllSheetFields(); // Ensures a completely fresh start
        }
    });
    </script>
</body>
</html>
